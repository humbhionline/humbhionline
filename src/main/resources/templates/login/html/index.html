<script type="text/javascript" src="/resources/scripts/node_modules/lockr/lockr.min.js"></script>
<script type="text/javascript" src="/resources/scripts/node_modules/axios/dist/axios.min.js"></script>
<script type="text/javascript" src="/resources/scripts/node_modules/vue/dist/vue.js"></script>
<script type="text/javascript" src="/fragments/js/util.js" ></script>
<link href="/fragments/css/mandi.css" rel="stylesheet"></link>


<script type="text/javascript">
    var login = null;

    $(function(){
        var searchParams = (new URL(window.location)).searchParams;
        var redirect_to = searchParams.get("_redirect_to");
        if (!redirect_to) {
            redirect_to = "/index"
        }

        login = new Vue({
            el : "#app",
            data : {
                Android : undefined , //typeof Android == "undefined" ? undefined : Android,
                params: { "User": { "PhoneNumber": "" , "Password":"" } },
                message : "",
                http: axios.create({
                    baseURL: "/",
                    timeout: 30000,
                    headers: { 'Content-Type': 'application/json' },
                    withCredentials: false,
                }),
            },
            created : function(){
                let self  = this;
                self.signIn();
            },
            methods : {
                login: function (event) {
                    if (event){
                        event.preventDefault();
                    }
                    var self = this;
                    this.http.post("/login", self.params).then(function (response) {
                        if (response.data.User.SignUps[0].Validated === 'Y') {
                            Lockr.set("SignUp",response.data.User.SignUps[0]);
                            Lockr.set("User",response.data.User);
                            loadLocation().then(function(){
                                let home = _redirect_to;
                                if (this.Android){
                                    window.location.replace(home);
                                }else {
                                    Notification.requestPermission(function(status) {
                                        console.log('Notification permission status:', status);
                                        window.location.replace(home);
                                    });
                                }
                            });
                        } else {
                            self.message = "Password doesnot match." ;
                        }
                    }).catch(function(err){
                        self.showApp();
                        if (err.response && err.response.data.SWFHttpResponse){
                            self.message = err.response.data.SWFHttpResponse.Error
                        }else {
                            console.log(err);
                        }
                        //self.message = err.response.S
                    });
                },
                resetPhoneNumber: function () {
                    var self = this;
                    self.params.User.PhoneNumber = "";
                    Lockr.rm("User");
                    Lockr.rm("SignUp");
                    window.location.reload();
                },
                forgotPassword : function(){
                    if (self.params.User.PhoneNumber){
                        window.location.replace("/index_otp?phone_number="+self.params.User.PhoneNumber);
                    }else {
                        self.message = "Enter phone number";
                    }
                },
                showApp : function(){
                    $("#root").show();
                },
                hideApp : function(){
                    $("#root").hide();
                },
                signIn: function () {
                    var self = this;
                    self.message = "" ;
                    self.hideApp();
                    self.params.User = Lockr.get("User") || self.params.User;

                    if (self.params.User.PhoneNumber && self.params.User.Password) {
                        self.login();
                    }else {
                        self.showApp();
                    }
                },
                signUp: function (event) {
                    if (event) {
                        event.preventDefault();
                    }
                    let self = this;
                    Lockr.set("User", self.params.User);
                    setConfirmUnload(false);
                    self.signIn();
                }
            },

        });

    });

</script>
<link rel="stylesheet" href="/fragments/css/mandi.css">
</link>
<style>
    html,
    body {
        height: 100%;
    }
</style>
<div id="root" class="v-fill align-items-center" style="display : none;">
    <div id="app"  class="container-fluid">
        <div class="row justify-content-center">
            <div class="col-6 col-sm-2">
                <div class="logo-holder mb-5">
                    <img src="/resources/web_manifest/drawing.svg" alt="HumBhi Online">
                    <div class="text-center font-weight-bold"  style="color: red;font-size: large;">
                        HumBhi Online
                    </div>
                </div>
            </div>
        </div>
        <div class="row justify-content-center" id="GetPhone" >
            <div class="col-10 col-sm-4">
                <form @submit.prevent="signUp()">
                    <div class="form-group">
                        <label for="PhoneNumber" class="text-left d-block">Mobile Number</label>
                        <input class="form-control" type="tel" id="PhoneNumber" placeholder="Mobile Number" v-model="params.User.PhoneNumber" />

                        <label for="PhonePassword" class="text-left d-block">Password</label>
                        <input id="PhonePassword" class="form-control" type="password" placeholder="Password" v-model="params.User.Password" />
                    </div>
                    <div class="form-group text-right">
                        <button class="btn btn-primary" type="submit" id="btnSignUp">Next</button>
                    </div>
                </form>
            </div>
        </div>
        <p id="msg" class="mb-0" v-if="message && message.length > 0"> {{message}}</p>
    </div>
</div>
