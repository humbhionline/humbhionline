<script type="text/javascript" src="/resources/scripts/node_modules/lockr/lockr.min.js"></script>
<script type="text/javascript" src="/resources/scripts/node_modules/axios/dist/axios.min.js"></script>
<script type="text/javascript" src="/resources/scripts/node_modules/vue/dist/vue.js"></script>
<script type="text/javascript" src="/resources/scripts/node_modules/deepmerge/dist/umd.js"></script>

<script type="text/javascript" src="/resources/scripts/swf/js/entity_helper.js"></script>


<link href="/fragments/css/mandi.css" rel="stylesheet"></link>
<script type="text/javascript">
    $(function () {
        $("#header").load("/fragments/html/header");
        var params = (new URL(window.location)).searchParams;
        let id = params.get("id");

        new Vue({
            el: "#app",
            data: {
                messages: [],
                User : Lockr.get("User"),
                Facility : { Inventories : [] },
                facilityBannerBeingEdited : false,
                current : {
                    index : -1 ,
                    Items : [] ,
                    UnitOfMeasures : [],
                    AssetCodes : [],
                    lookupselectionIndex : -1,
                    Inventory: {},
                    AdjustmentQuantity : 0 ,
                },

            },
            created: function () {
                let self = this;
                api().url("/facilities/show/" + id).get().then(function (response) {
                    if (!response.Facility.Inventories){
                        response.Facility.Inventories = [] ;
                    }
                    response.Facility.Inventories.forEach((inv, i) => {
                        if (!inv.Sku.Item.AssetCode){
                           inv.Sku.Item.AssetCode = { Code : "" };
                        }
                        if (!inv.Sku.Attachments){
                            inv.Sku.Attachments = [{SkuId: inv.Sku.Id}];
                        }
                    });
                    if (!response.Facility.Attachments){
                        response.Facility.Attachments = [];
                    }

                    Vue.set(self,"Facility", response.Facility);
                    self.showApp();
                }).catch(function (err) {
                    self.showApp();
                    self.autoClearMessage(err.response.data.SWFHttpResponse.Error);
                })
            },
            methods: {
                showApp: function () {
                    $("#root").show();
                },
                message: function () {
                    var message = "";
                    let self = this;
                    self.messages.forEach(function (m) {
                        message += " " + m;
                    });
                    return message;
                },
                autoClearMessage: function (message,index) {
                    let self = this;
                    if (message){
                        self.messages.push(message);
                        var element = document.getElementById('inventory-' + index) ;
                        if (element){
                            var msg = self.$refs['message'];
                            element.appendChild(msg);
                        }
                    }
                    setTimeout(function () {
                        self.messages = [];
                        var element = document.getElementById('default-error-div') ;
                        if (element){
                            var msg = self.$refs['message'];
                            element.appendChild(msg);
                        }
                    }, 1500);
                },
                create: function(event){
                    if (event){
                        event.preventDefault();
                    }
                    let self = this;

                    var i = {
                            Company :self.User.Company ,
                            Facility : { Id : self.Facility.Id},
                            Sku : {
                                Item :{
                                    Name :"",
                                    Company : {Name :"MANDI"},
                                    AssetCode : { "Code" : "" } ,
                                },
                                Name : "",
                                SkuCode  : "" ,
                                PackagingUOM : {
                                    Measures : "Packaging",
                                    Name :""
                                },
                                Published : "Y"
                            },
                            Quantity : "0" ,
                            Infinite : "N"
                        };
                    let last = self.Facility.Inventories.length > 0 ? self.Facility.Inventories[self.Facility.Inventories.length -1] : null ;

                    if (!last || last.Id){
                        self.Facility.Inventories.push(i);
                        self.edit(null,self.Facility.Inventories.length-1);
                    }

                },
                edit: function(event,index){
                    if (event){
                        event.preventDefault();
                    }
                    this.current.index = index;
                    if (index >= 0 ){
                        this.current.Inventory = JSON.parse(JSON.stringify(this.Facility.Inventories[this.current.index] ) );
                    }else {
                        this.current.Inventory = {};
                        let length = this.Facility.Inventories.length;
                        let last = length >  0 ? this.Facility.Inventories[length - 1] : null ;
                        if (last && !last.Id){
                            this.Facility.Inventories.splice(length -1 , 1);
                        }
                        this.current.AdjustmentQuantity = 0 ;
                    }
                },
                cancel: function(event){
                    if (event){
                        event.preventDefault();
                    }
                    this.edit(event,-1);
                },
                save: function(event){
                    if (event){
                        event.preventDefault();
                    }
                    let self = this;
                    let index = self.current.index;
                    let i = self.current.Inventory;
                    let newRecord = !i.Id;
                    let newProduct = !i.Sku.Id;
                    delete i.Quantity;



                    api().url("/api/adjust").parameters({AdjustmentRequest : { NewProduct : newProduct , "Inventory" :i, AdjustmentQuantity :self.current.AdjustmentQuantity,
                    Comment : "Adjust" }}).post().then(function (response) {
                        var inv = deepmerge (i,response.AdjustmentRequests[0].Inventory);
                        if (!inv.Sku.Item.AssetCode){
                            inv.Sku.Item.AssetCode = { Code : "" };
                        }
                        if (!inv.Sku.Attachments){
                            inv.Sku.Attachments = [{SkuId: inv.Sku.Id}];
                        }

                        if (newRecord){
                            self.Facility.Inventories.splice(self.Facility.Inventories.length-1,1,inv);
                        }else {
                            self.Facility.Inventories.splice(index,1,inv);
                        }
                        self.cancel(null);
                    }).catch(function (err) {
                        if (err.response){
                            self.autoClearMessage(err.response.data.SWFHttpResponse.Error, index);
                        }else {
                            self.autoClearMessage(err.toString(),index);
                        }
                    });

                },
                zeroInventory: function(event,index){
                    if (event){
                        event.preventDefault();
                    }

                    let self = this;
                    let i = self.Facility.Inventories[index];

                    let newRecord = !i.Id;
                    if (!newRecord){
                        i.Infinite = "N";
                        api().url("/api/adjust").parameters({AdjustmentRequest : { Inventory : i, AdjustmentQuantity : -1 * i.Quantity, Comment : "Remove Inventory" , NewProduct : "N" } }).post().then(function (response){
                            var inv = deepmerge (i,response.AdjustmentRequests[0].Inventory);
                            if (!inv.Sku.Item.AssetCode){
                                inv.Sku.Item.AssetCode = { Code : "" };
                            }
                            self.Facility.Inventories.splice(index,1,inv);
                        }).catch(function (err) {
                            if (err.response) {
                                self.autoClearMessage(err.response.data.SWFHttpResponse.Error,index);
                            }else {
                                self.autoClearMessage(err.toString(),index);
                            }
                        });
                    }else {
                        self.Facility.Inventories.splice(index,1);
                    }
                },
                infiniteInventory: function(event,index){
                    if (event){
                        event.preventDefault();
                    }

                    let self = this;
                    let i = self.Facility.Inventories[index];

                    let newRecord = !i.Id;
                    if (!newRecord){
                        i.Infinite = "Y";
                        api().url("/api/adjust").parameters({AdjustmentRequest : { Inventory : i, AdjustmentQuantity : -1 * i.Quantity, Comment : "Mark Infinite Inventory" , NewProduct : "N" } }).post().then(function (response){
                            var inv = deepmerge (i,response.AdjustmentRequests[0].Inventory);
                            if (!inv.Sku.Item.AssetCode){
                                inv.Sku.Item.AssetCode = { Code : "" };
                            }
                            self.Facility.Inventories.splice(index,1,inv);
                        }).catch(function (err) {
                            if (err.response) {
                                self.autoClearMessage(err.response.data.SWFHttpResponse.Error,index);
                            }else {
                                self.autoClearMessage(err.toString(),index);
                            }
                        });
                    }else {
                        self.Facility.Inventories.splice(index,1);
                    }
                },
                isKeyTriggerable: function (e,length = 3) {
                    return e.target.value.length >= length;
                    /*
                    if (e && e.keyCode >= 48 && e.keyCode <= 90) {
                        return true;
                    }
                    return false;
                    */
                },
                _invokeItemLookup: function(e){
                    let self = this;
                    if (self.current.Items.length == 0){
                        self.current.Inventory.Sku = {
                            Item :{
                                Name :e.target.value,
                                Company : {Name :"MANDI"},
                                AssetCode : { "Code" : "" } ,
                            },
                            Name : "",
                            SkuCode  : "" ,
                            PackagingUOM : {
                                Measures : "Packaging",
                                Name :""
                            },
                            Published : "Y"
                        };
                    }else{
                        self.loadLookupEntries(e.target);
                    }

                },
                onItemChange: function (e) {
                    e && e.preventDefault();
                    if (!this.isKeyTriggerable(e)) {
                        self.current.Items = [] ;
                        return;
                    }
                    let self = this;
                    new Autocomplete("items", e.target).search().then(function (response) {
                        if (!response) {
                            return
                        }
                        self.current.Items = response.Items;
                        self._invokeItemLookup(e);
                    });
                },
                onItemSelect: function (e, item) {
                    e && e.preventDefault();
                    let self = this;
                    self.current.Inventory.Sku.Item = item;
                    self.current.Inventory.SellingPrice = self.current.Inventory.Sku.MaxRetailPrice
                    if (!item.AssetCode){
                        item.AssetCode = { Code :"" };
                    }
                    if (item.AssetCode.Code.length > 0 ){
                        self.current.Inventory.Sku.TaxRate = item.AssetCode.GstPct
                    }
                    self.current.Items = [];
                },
                onAssetCodeChange: function (e) {
                    e && e.preventDefault();
                    if (!this.isKeyTriggerable(e)) {
                        return;
                    }

                    let self = this;

                    new Autocomplete("asset_codes", e.target).search().then(function (response) {
                        if (!response) {
                            return
                        }
                        self.current.AssetCodes = response.AssetCodes;
                        if (response.AssetCodes.length === 0) {
                            self.current.Inventory.Sku.Item.AssetCode = { Code : e.target.value };
                            //self.onAssetCodeSelect(null, self.current.AssetCodes[0]);
                        } else {
                            self.loadLookupEntries(e.target);
                        }
                    });
                },
                onAssetCodeSelect:function (e, ac) {
                    e && e.preventDefault();
                    let self = this;
                    self.current.Inventory.Sku.Item.AssetCode = ac;
                    self.current.Inventory.Sku.TaxRate = ac.GstPct
                    self.current.AssetCodes = [];
                },
                onUnitOfMeasureChange: function (e) {
                    e && e.preventDefault();
                    let self = this;
                    delete self.current.Inventory.Sku.PackagingUOM.Id;

                    if (!this.isKeyTriggerable(e,1) && self.current.UnitOfMeasures.length == 0 ) {
                        return;
                    }

                    new Autocomplete("unit_of_measures", e.target,1).search("NAME" , "MEASURES:Packaging").then(function (response) {

                        if (response){
                            self.current.UnitOfMeasures = response.UnitOfMeasures;
                        }else {
                            self.current.UnitOfMeasures = [];
                        }
                        if (self.current.UnitOfMeasures.length === 0) {
                            //self.onUnitOfMeasuresSelect(null, self.current.UnitOfMeasures[0]);
                            self.current.Inventory.Sku.PackagingUOM = {
                                Measures : "Packaging",
                                Name : e.target.value,
                            };
                        } else {
                            self.loadLookupEntries(e.target);
                        }
                    });
                },
                onUnitOfMeasuresSelect:function (e, uom) {
                    e && e.preventDefault();
                    let self = this;
                    delete uom.Id ;

                    self.current.Inventory.Sku.PackagingUOM = uom ;
                    api().url("/skus/search/ITEM:\'"+self.current.Inventory.Sku.Item.Name+"\' AND PACKAGING_U_O_M:\'"+ uom.Name +"\'").get().then(function(response){
                        if (response.Skus.length === 1){
                            self.current.Inventory.Sku = response.Skus[0];
                            self.current.Inventory.SellingPrice = self.current.Inventory.Sku.MaxRetailPrice
                            if (!self.current.Inventory.Sku.Item.AssetCode){
                                self.current.Inventory.Sku.Item.AssetCode = { Code : "" };
                            }
                            if (self.current.Inventory.Sku.Item.AssetCode.GstPct){
                                self.current.Inventory.Sku.TaxRate = self.current.Inventory.Sku.Item.AssetCode.GstPct
                            }
                        }
                    });
                    self.current.UnitOfMeasures = [] ;
                },
                getParentDiv: function (element) {
                    var div = element;
                    while (div && div.tagName !== 'DIV') {
                        div = div.parentElement;
                    }
                    return div;
                },
                loadLookupEntries: function (element) {
                    var div = this.getParentDiv(element);
                    if (div) {
                        div.appendChild(this.$refs['lookupEntries']);
                    }
                },

                navigate : function(e,index,length){
                    e && e.preventDefault();
                    index = Math.max(index,0);
                    let self = this;
                    self.current.lookupselectionIndex = (index % length);
                    let anchors = self.$refs['lookupEntries'].getElementsByTagName("a");
                    anchors[self.current.lookupselectionIndex].focus();
                },

                editBanner: function(event){
                    event && event.preventDefault();
                    let self = this;
                    self.facilityBannerBeingEdited = true;
                },
                bannerEditComplete: function(event){
                    event && event.preventDefault();
                    this.facilityBannerBeingEdited = false;
                },
                isBannerBeingAdded: function(event){
                    let self = this;
                    let numAttachments = self.Facility.Attachments.length;
                    return (numAttachments != 0 && !self.Facility.Attachments[numAttachments - 1].Id);
                },
                addBanner : function(event){
                    if (event){
                        event.preventDefault();
                    }
                    let self = this;
                    if (!self.isBannerBeingAdded(event)){
                        self.Facility.Attachments.push({ FacilityId : self.Facility.Id}) ;
                    }
                },
                removeBannner : function(event,index){
                    if (event){
                        event.preventDefault();
                    }
                    let self = this;
                    if (self.Facility.Attachments[index].Id){
                        api().url("/attachments/destroy/"+self.Facility.Attachments[index].Id).get().then(function(response){
                          self.Facility.Attachments.splice(index,1);
                        }).catch(function(err){
                            if (err.response){
                                self.messages.push(err.response.data.SWFHttpResponse.Error);
                            }else {
                                self.messages.push(err);
                            }
                            self.autoClearMessage();
                        });
                    }else{
                        self.Facility.Attachments.splice(index,1);
                    }
                },
                onFacilityBannerFileChange : function(e,index ){
                    let self = this;
                    self.Facility.Attachments[index].AttachmentContentName = e.target.files[0].name;
                    self.Facility.Attachments[index].Dirty = true;
                    Vue.set(self.Facility.Attachments,index,self.Facility.Attachments[index]);
                    self.readFacilityBannerUrl(e.target.files[0],index);

                },
                readFacilityBannerUrl : function(file,index){
                    var reader = new FileReader();
                    let self = this;

                    reader.onload = function (e) {
                        self.Facility.Attachments[index].Attachment = e.target.result;
                        Vue.set(self.Facility.Attachments,index,self.Facility.Attachments[index]);
                    }

                    reader.readAsDataURL(file);
                },
                uploadFacilityBannerFile: function (e,index) {
                    if (e){
                        e.preventDefault();
                    }

                    var files = $('#attachment-'+index)[0].files;

                    if (!files.length){
                        return;
                    };

                    var file = files[0];
                    let self = this;
                    let formData = new FormData();
                    formData.append("ATTACHMENT",file);
                    formData.append("FACILITY_ID",self.Facility.Id);
                    if (self.Facility.Attachments[index].Id){
                        formData.append("ID",self.Facility.Attachments[index].Id);
                    }
                    api().url("/attachments/save").parameters(formData).headers({ "Content-Type": "multipart/form-data"} ).post().then(function (response) {
                        console.log(response);
                        if (self.Facility.Attachments[index].AttachmentUrl === response.Attachment.AttachmentUrl){
                            response.Attachment.AttachmentUrl = "/attachments/show/0" + response.Attachment.AttachmentUrl;
                        }
                        self.Facility.Attachments.splice(index,1,response.Attachment);
                    });
                },
                createDataFile: function (file, callback) {
                    var reader = new FileReader();
                    reader.onload = (e) => {
                        callback(e.target.result);
                    }
                    reader.readAsDataURL(file);
                },

                removeSkuBannner : function(event,inventoryIndex,attachmentIndex){
                    if (event){
                        event.preventDefault();
                    }
                    let self = this;
                    let skuAttachment = self.Facility.Inventories[inventoryIndex].Sku.Attachments[attachmentIndex];
                    if (skuAttachment.Id){
                        api().url("/attachments/destroy/"+skuAttachment.Id).get().then(function(response){
                          self.Facility.Inventories[inventoryIndex].Sku.Attachments.splice(attachmentIndex,1);
                        }).catch(function(err){
                            if (err.response){
                                self.messages.push(err.response.data.SWFHttpResponse.Error);
                            }else {
                                self.messages.push(err);
                            }
                            self.autoClearMessage();
                        });
                    }else{
                        self.Facility.Inventories[inventoryIndex].Sku.Attachments.splice(attachmentIndex,1);
                    }
                },
                onSkuBannerFileChange : function(e,inventoryIndex,attachmentIndex){
                    e.preventDefault();
                    let self = this;
                    let skuAttachment = self.Facility.Inventories[inventoryIndex].Sku.Attachments[attachmentIndex];

                    skuAttachment.AttachmentContentName = e.target.files[0].name;
                    skuAttachment.Dirty = true;

                    self.readSkuBannerUrl(e.target.files[0],inventoryIndex,attachmentIndex);

                },
                readSkuBannerUrl : function(file,inventoryIndex,attachmentIndex){
                    var reader = new FileReader();
                    let self = this;

                    reader.onload = function (e) {
                        self.Facility.Inventories[inventoryIndex].Sku.Attachments[attachmentIndex].Attachment = e.target.result;
                        Vue.set(self.Facility.Inventories[inventoryIndex].Sku.Attachments,attachmentIndex,self.Facility.Inventories[inventoryIndex].Sku.Attachments[attachmentIndex]);
                    }

                    reader.readAsDataURL(file);
                },
                uploadSkuBannerFile: function (e,inventoryIndex,attachmentIndex) {
                    if (e){
                        e.preventDefault();
                        e.stopPropagation();
                    }

                    var files = $('#sku-attachment-'+inventoryIndex)[0].files;

                    if (!files.length){
                        return;
                    };

                    var file = files[0];
                    let self = this;
                    let formData = new FormData();
                    let inv = self.Facility.Inventories[inventoryIndex];
                    let attachment = self.Facility.Inventories[inventoryIndex].Sku.Attachments[attachmentIndex];

                    formData.append("ATTACHMENT",file);
                    formData.append("SKU_ID",inv.Sku.Id);
                    if (attachment.Id){
                        formData.append("ID",attachment.Id);
                    }
                    api().url("/attachments/save").parameters(formData).headers({ "Content-Type": "multipart/form-data"} ).post().then(function (response) {
                        console.log(response);
                        if (inv.Sku.Attachments[attachmentIndex].AttachmentUrl === response.Attachment.AttachmentUrl){
                            response.Attachment.AttachmentUrl = "/attachments/show/0" + response.Attachment.AttachmentUrl;
                        }

                        inv.Sku.Attachments.splice(attachmentIndex,1,response.Attachment);
                    });
                },
                chooseSkuFile : function(e,inventoryIndex){
                    let fileinput = $("#sku-attachment-"+inventoryIndex);
                    fileinput.click();
                },
                chooseBannerFile :function(e,index){
                    let fileinput = $("#attachment-"+index);
                    fileinput.click();
                },
                blank: function(s){
                    return (!s || s.length === 0)
                }

            }
        });
    });
</script>
<style>
  /* Make the image fully responsive */
  .carousel-inner img {
    height : 200px;
    width: 100%;
  }
  .carousel-inner{
      background : gray;
  }

  .banner-edit{
      bottom: 20pt;
      right: 10pt;
      position: absolute;
      z-index: 1;
      color: #0f0;
  }
</style>
<div id="root" style="display:none;">
    <div id="header">
    </div>
    <div id="app" class="app-body">
        <div id="lookupEntries" ref="lookupEntries" class="below">
            <div v-for="(item,index) in current.Items" v-if="current.Items.length > 0">
                <a href="#" v-on:click="onItemSelect($event,item)"  v-on:keyup.enter="onItemSelect($event,item)" v-on:keyup.space="onItemSelect($event,item)"
                v-on:keyup.up="navigate($event,index-1,current.Items.length)" v-on:keyup.down="navigate($event,index+1,current.Items.length)">{{item.Name}} {{ item.AssetCode ? ' - ' + item.AssetCode.LongDescription : ""}}</a>
            </div>
            <div v-for="(code,index) in current.AssetCodes" v-if="current.AssetCodes.length > 0">
                <a href="#"
                v-on:click="onAssetCodeSelect($event,code)" v-on:keyup.space="onAssetCodeSelect($event,code)" v-on:keyup.enter="onAssetCodeSelect($event,code)"
                v-on:keyup.up="navigate($event,index-1,current.AssetCodes.length)" v-on:keyup.down="navigate($event,index+1,current.AssetCodes.length)" >{{code.Code}} - {{code.Description}} </a>
            </div>
            <div v-for="(code,index) in current.UnitOfMeasures" v-if="current.UnitOfMeasures.length > 0">
                <a href="#"
                v-on:click="onUnitOfMeasuresSelect($event,code)" v-on:keyup.space="onUnitOfMeasuresSelect($event,code)" v-on:keyup.enter="onUnitOfMeasuresSelect($event,code)"
                v-on:keyup.up="navigate($event,index-1,current.UnitOfMeasures.length)" v-on:keyup.down="navigate($event,index+1,current.UnitOfMeasures.length)" >{{code.Name}} </a>
            </div>
        </div>
        <div id="default-error-div" class="container">
            <div id="message" ref="message" class="row" >
                <div class="col-12 alert alert-danger " v-if="messages && messages.length > 0">
                    {{ message() }}
                </div>
            </div>
        </div>
        <div class="container">
            <div class="row">
                <div class="col-12">
                    <div id="banner-slider" class="carousel slide" data-ride="carousel">
                      <!-- Indicators -->
                      <ul class="carousel-indicators">
                            <li data-target="#banner-slider" v-bind:data-slide-to="index" v-bind:class="index == 0 ? 'active' : '' "
                                v-for="(attachment,index) in Facility.Attachments">
                            </li>
                      </ul>
                      <!-- The slideshow -->
                      <div class="carousel-inner">
                          <div v-bind:class="'justify-content-center carousel-item ' + (index == 0 ? 'active' : '') "
                              v-for="(attachment,index) in Facility.Attachments">
                              <img v-bind:src="attachment.AttachmentUrl" v-if="attachment.Id && !attachment.Dirty" ></img>
                              <img v-bind:src="attachment.Attachment"  v-else-if="attachment.Dirty"></img>
                          </div>
                      </div>

                      <!-- Left and right controls -->
                      <a class="carousel-control-prev" href="#banner-slider" data-slide="prev">
                        <span class="carousel-control-prev-icon"></span>
                      </a>
                      <a class="carousel-control-next" href="#banner-slider" data-slide="next">
                        <span class="carousel-control-next-icon"></span>
                      </a>
                      <a href="#" class="banner-edit fas fa-edit" @click="editBanner($event)" v-if="!facilityBannerBeingEdited">Banner</a>
                      <a href="#" class="banner-edit fas fa-times" @click="bannerEditComplete($event)" v-else>Cancel</a>
                  </div>
                </div>

            </div>

            <div id="banners" class="row"  v-if="facilityBannerBeingEdited" >
                <div class="col-12">
                     <div class="d-flex flex-row justify-content-end">
                         <a href="#" class="btn btn-primary" @click="addBanner($event)" >Add New</a>
                     </div>
                </div>
                <div class="col-12" v-for="(attachment,i) in Facility.Attachments" >
                    <div class="row" >
                        <div class="col-5" v-if="!attachment.Dirty" @click="chooseBannerFile($event,i)">
                            <img v-bind:src="attachment.AttachmentUrl" v-if="attachment.Id" style="width:100%; height:100%;"></img>
                            <span v-else>Click to upload Image</span>
                        </div>
                        <div class="col-5" @click="chooseBannerFile($event,i)" v-else>
                            <img v-bind:src="attachment.Attachment"  style="width:100%; height:100%;" v-if="attachment.Attachment"></img>
                            <span v-else>Click to upload Image</span>
                        </div>
                        <div class="col">
                            <div class="row">
                                <div class="col-9 d-flex flex-row">
                                    <input type="file" class="file-upload" v-bind:key="'attachment-'+i" v-bind:id="'attachment-'+i" v-on:input="onFacilityBannerFileChange($event,i)"/>
                                </div>
                                <div class="col-9 d-flex flex-row">
                                    <a href="#" class="h-fill btn btn-primary" role="button" title="Upload"
                                        v-on:click="uploadFacilityBannerFile($event,i)" v-if="attachment.Dirty">
                                        <i class="small fas fa-check">{{ !attachment.Id ? "Upload" : "Update" }}</i>
                                    </a>
                                    <a href="#" class="h-fill btn btn-primary" role="button" title="Remove"
                                        v-on:click="removeBannner($event,i)">
                                        <i class="small fas fa-trash">Remove</i>
                                    </a>
                                </div>
                                <div class="col-6">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-12">
                    <h2 class="my-3 mt-4" > {{Facility.Name}} </h2>
                    <span v-if="Facility.City">
                        {{Facility.AddressLine1}}
                        {{!blank(Facility.AddressLine2) ? "," : "" }} {{ Facility.AddressLine2}}
                        {{!blank(Facility.AddressLine3) ? "," : "" }}  {{Facility.AddressLine3}}
                        {{!blank(Facility.AddressLine4) ? "," : "" }}  {{Facility.AddressLine4}}
                        {{Facility.City.Name}}-{{Facility.City.State.Name}} ,{{Facility.PinCode.PinCode}}
                    </span>
                </div>
            </div>
            <div class="row">
                <div class="col-8 d-flex small justify-content-start">
                    <span>Credit Balance: {{User.BalanceOrderLineCount}}</span>
                </div>
                <div class="col-4 d-flex small justify-content-end">
                    <span>#Products: {{Facility.Inventories.length}}</span>
                </div>

            </div>


            <div v-bind:id="'inventory-' + i " class="py-3 border-top border-dark" v-for="(inv,i) in Facility.Inventories">
                <div class="d-flex flex-row justify-content-end">
                    <button class="btn btn-primary" role="button" v-if="inv.Infinite === 'Y'" v-on:click="zeroInventory($event,i)" :disabled="current.index === i">
                        <i class="fas fa-stop-circle">Stop</i>
                    </button>
                    <button class="btn btn-primary" role="button" v-on:click="infiniteInventory($event,i)" :disabled="current.index === i" v-else>
                        <i class="fas fa-play-circle">Start</i>
                    </button>
                </div>
                <div class="row">
                    <div class="col-3" @click="chooseSkuFile($event,i)" >
                        <div class="row " v-for="(attachment,ai) in inv.Sku.Attachments">
                            <div  class="col-12 " v-if="!attachment.Dirty">
                                <img v-bind:src="attachment.AttachmentUrl" v-if="attachment.Id" style="width:100%; " ></img>
                                <span v-else>Click to upload Image</span>
                            </div>
                            <div  class="col-12 " v-else>
                                <img v-bind:src="attachment.Attachment"  style="width:100%; " v-if="attachment.Attachment">
                                <span v-else>Click to upload Image</span>
                            </div>
                            <div class="col-12 d-flex flex-row">
                                <input type="file" class="file-upload" v-bind:key="'sku-attachment-'+i" v-bind:id="'sku-attachment-'+i" v-on:input="onSkuBannerFileChange($event,i,ai)"/>
                                <a href="#" class="h-fill btn btn-primary" role="button" title="Upload"
                                    v-on:click="uploadSkuBannerFile($event,i,ai)" v-if="attachment.Dirty">
                                    <i class="small fas fa-check"></i>
                                </a>
                                <!--
                                <a href="#" class="h-fill btn btn-primary" role="button" title="Remove"
                                    v-on:click="removeSkuBannner($event,i,ai)">
                                    <i class="small fas fa-trash"></i>
                                </a>
                                -->
                            </div>
                        </div>
                    </div>
                    <div class="col-9">
                        <div class="row">
                            <div class="col-7" v-if="current.index === i">
                                <label v-bind:for="'item' + i" class="small">Product Name</label>
                                <input  v-bind:key="'item' + i"  v-bind:id="'item' + i"   class="form-control" placeholder="Product Name"
                                v-model="current.Inventory.Sku.Item.Name"
                                v-on:input="onItemChange($event)" v-on:keyup.down="navigate($event,0,current.Items.length)"   />
                            </div>
                            <div class="col-5" v-if="current.index === i">
                                <label class="small"   v-bind:for="'uom' + i"  >Package</label>
                                <input v-bind:key="'uom' + i"  v-bind:id="'uom' + i"  class="form-control" placeholder="Package"
                                v-model="current.Inventory.Sku.PackagingUOM.Name" v-on:input="onUnitOfMeasureChange($event)"
                                v-on:keyup.down="navigate($event,0,current.UnitOfMeasures.length)"  />
                            </div>
                            <div class="col-12" v-if="current.index !== i">
                                {{inv.Sku.Item.Name}} - {{inv.Sku.PackagingUOM.Name}}
                            </div>
                        </div>
                        <div class="row" v-if="current.index === i">
                            <div class="col-7" >
                                <label class="small"   v-bind:for="'mrp' + i"  >Max Retail Price</label>
                                <input v-bind:key="'mrp' + i"  v-bind:id="'mrp' + i"  class="form-control" placeholder="MRP"
                                v-model="current.Inventory.Sku.MaxRetailPrice"  />
                            </div>
                            <div class="col-5" >
                                <label class="small"   v-bind:for="'price' + i"  >Selling Price</label>
                                <input v-bind:key="'price' + i"  v-bind:id="'price' + i"  class="form-control" placeholder="Price"
                                v-model="current.Inventory.SellingPrice"  />
                            </div>
                        </div>
                        <div class="row" v-else>
                            <div class="col-12">
                                <span v-if="inv.Sku.MaxRetailPrice * 1.0 === inv.SellingPrice * 1.0">
                                    <b>&#x20B9; {{inv.SellingPrice}}</b>
                                </span>
                                <span v-else>
                                    <b>&#x20B9; {{inv.SellingPrice}}</b> <del class="font-weight-lighter">&#x20B9; {{inv.Sku.MaxRetailPrice}} </del>
                                </span>
                            </div>
                        </div>

                        <div class="row" v-if="current.index === i" >
                            <div class="col-7">
                                <!-- If item is new only then gst is enterable -->
                                <label class="small"   v-bind:for="'asset_code' + i"  >GST/SAC Code</label>
                                <input  v-bind:key="'asset_code' + i"  v-bind:id="'asset_code' + i"   class="form-control" placeholder="GST/SAC Code"
                                v-model="current.Inventory.Sku.Item.AssetCode.Code"
                                v-on:input="onAssetCodeChange($event)" v-on:keyup.down="navigate($event,0,current.AssetCodes.length)"   />
                            </div>
                            <div class="col-5">
                                <label class="small" >Tax Rate:</label>
                                <br/>
                                <label>{{current.Inventory.Sku.Item.AssetCode.GstPct}}</label>

                            </div>
                        </div>

                        <!--
                        <div class="row" v-else-if="inv.Sku.Item.AssetCode && inv.Sku.Item.AssetCode.LongDescription">
                            <div class="col-7" >
                                <label class="small" >GST/SAC Code</label>
                                <br/>
                                <label>{{inv.Sku.Item.AssetCode.Code}}</label>
                            </div>
                            <div class="col-5" >
                                <label class="small" >Tax Rate:</label>
                                <br/>
                                <label>{{inv.Sku.TaxRate}}</label>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12">
                                <label class="form-label small"  v-bind:for="'infinite' + i"  >Infinite</label>
                                <input value="N" type="checkbox" v-bind:key="'infinite' + i"  v-bind:id="'infinite' + i"  class="mt-2 mb-3 form-check custom-control" placeholder="Infinite"
                                v-model="inv.Infinite"  :disabled="current.index !== i || ( inv.Id && (inv.Quantity * 1.0  > 0))" true-value="Y" false-value="N" />
                            </div>
                            Quantity enabling may be complex. Disable for now.
                            <div class="col-4" v-if=" inv.Infinite === 'N'">
                                <label class="form-label small"   v-bind:for="'quantity' + i"  >Available</label>
                                <input v-bind:key="'quantity' + i"  v-bind:id="'quantity' + i"  class="form-control" placeholder="Quantity"
                                v-model="inv.Quantity"  disabled="disabled"/>
                            </div>
                            <div class="col-5" v-if="current.index === i && inv.Infinite === 'N' ">
                                <label class="form-label small"   v-bind:for="'quantity' + i"  >Adjust +/- </label>
                                <input v-bind:key="'adjustquantity' + i"  v-bind:id="'adjustquantity' + i"  class="form-control" title="Adjustment Quantity"
                                v-model="current.AdjustmentQuantity"  />
                            </div>
                        </div>
                        -->
                        <div class="d-flex flex-row justify-content-end py-2">
                            <div v-if="current.index !== i">
                                <a href="#/" class="btn btn-primary" role="button" v-on:click="edit($event,i)" >
                                    <i class="fas fa-edit">Edit</i>
                                </a>
                            </div>
                            <div v-else>
                                <a href="#/" class="btn btn-primary" role="button" v-on:click="save($event)" >
                                    <i class="fas fa-check">Save</i>
                                </a>
                                <a href="#/" class="btn btn-primary" role="button" v-on:click="cancel($event)" >
                                    <i class="fas fa-times">Cancel</i>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row py-2">
                <div class="col-12 text-right">
                    <a href="#/" class="ml-2 mt-3 btn btn-primary" role="button" v-on:click="create($event)" >
                        <i class="fas fa-plus"> Product</i>
                    </a>
                </div>
            </div>
        </div>

    </div>
<div>
