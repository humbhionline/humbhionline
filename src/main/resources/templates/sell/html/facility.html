<script type="text/javascript" src="/resources/scripts/node_modules/lockr/lockr.min.js" defer></script>
<script type="text/javascript" src="/resources/scripts/node_modules/axios/dist/axios.min.js" defer></script>
<script type="text/javascript" src="/resources/scripts/node_modules/vue/dist/vue.js" defer></script>
<script type="text/javascript" src="/resources/scripts/node_modules/deepmerge/dist/umd.js" defer></script>
<script type="text/javascript" src="/resources/scripts/swf/js/entity_helper.js" defer></script>
<script src="/fragments/js/cropper.js" defer></script>
<script type="text/javascript" src="/fragments/js/util.js" defer></script>
<link rel="preload" as="style" href="/fragments/css/cropper.css" onload="this.onload=null;this.rel='stylesheet'">
<link rel="preload" as="style" href="/fragments/css/mandi.css" onload="this.onload=null;this.rel='stylesheet'">


<script type="text/javascript">
    $(function () {
        var params = (new URL(window.location)).searchParams;
        let id = params.get("id");



        new Vue({
            el: "#app",
            data: {
                User: Lockr.get("User"),
                Facility: { Name: "", City: { Name: "", State: { Name: "", Country: { "Name": "India" } } }, PinCode: { PinCode: "" }, Inventories: [] },
                facilityBannerBeingEdited: false,
                facilityCropperBeingEdited: false,
                timer: -1,
                selectedDataFileName: "",
                current: {
                    index: -1,
                    Items: [],
                    UnitOfMeasures: [],
                    AssetCodes: [],
                    Tags: [],
                    lookupselectionIndex: -1,
                    Inventory: {},
                    AdjustmentQuantity: 0,
                },
                search: {
                    term: "",
                    results: [],
                },
            },
            created: function () {
                let self = this;
                showSpinner();
                api().url("/facilities/show/" + id).get().then(function (response) {
                    self.loadInventory(response.Facility).then(function () {
                        self.showApp();
                    });
                }).catch(function (err) {
                    self.showApp();
                    showError(err);
                }).finally(function () {
                    hideSpinner();
                });

            },
            methods: {
                fixInventoryAttributes: function (f, i) {
                    i.forEach((inv, index) => {
                        inv.Sku.Item.AssetCode ||= { Code: "" };
                        inv.Sku.Attachments ||= [{ Sku: { Id: inv.Sku.Id } }];
                        inv.ManagedBy ||= "";
                    });
                    f.Inventories = i;
                    self.search.results = f.Inventories;
                },
                fixFacilityAttributes: function (f) {
                    try {
                        let self = this;
                        f.Inventories ||= [];
                        f.Attachments ||= [];
                        self.Facility = f;
                        self.search.results = f.Inventories;
                    } catch (err) {
                        console.log(err);
                    }
                    //Vue.set(self, "Facility", response.Facility);
                },
                showApp: function () {
                    $("#header").load("/fragments/html/header", {}, function () {
                        fixMenu();
                        $(".navbar").addClass("bg-clear");
                        $("#root").show();
                        if (window.innerWidth < 640) {
                            let facilityHeader = $(".facility-header").height() + 10;
                            $(".body").css("padding-top", facilityHeader);
                            $("#pageTitle").html("Sales-Facilities");
                        }
                    });
                },

                create: function (event) {
                    if (event) {
                        event.preventDefault();
                    }
                    let self = this;

                    var i = {
                        Company: self.User.Company,
                        Facility: { Id: self.Facility.Id },
                        Sku: {
                            Item: {
                                Name: "",
                                Company: self.User.Company,
                                AssetCode: { "Code": "" },
                            },
                            Name: "",
                            SkuCode: "",
                            PackagingUOM: {
                                Measures: "Packaging",
                                Name: ""
                            },
                            Published: "Y"
                        },
                        Quantity: "0",
                        Infinite: "N"
                    };
                    let last = self.search.results.length > 0 ? self.search.results[self.search.results.length - 1] : null;

                    if (!last || last.Id) {
                        self.search.results.push(i);
                        self.edit(null, self.search.results.length - 1);
                    }

                },
                edit: function (event, index) {
                    if (event) {
                        event.preventDefault();
                    }
                    this.current.index = index;
                    if (index >= 0) {
                        this.current.Inventory = JSON.parse(JSON.stringify(this.search.results[this.current.index]));
                    } else {
                        this.current.Inventory = {};
                        let length = this.search.results.length;
                        let last = length > 0 ? this.search.results[length - 1] : null;
                        if (last && !last.Id) {
                            this.search.results.splice(length - 1, 1);
                        }
                        this.current.AdjustmentQuantity = 0;
                    }
                    this.current.Inventory.ManagedBy ||= "";
                },
                cancel: function (event) {
                    if (event) {
                        event.preventDefault();
                    }
                    this.edit(event, -1);
                },
                updateLists: function (inv) {
                    let self = this;
                    [self.Facility.Inventories, self.search.results].forEach((list, i) => {

                        let index = list.findIndex(function (i) {
                            return i.Id == inv.Id;
                        });
                        if (index < 0) {
                            list.push(inv);
                        } else {
                            list.splice(index, 1, inv);
                        }

                    });
                },
                clearFromLists: function (inv) {
                    let self = this;
                    [self.Facility.Inventories, self.search.results].forEach((list, i) => {

                        let index = list.findIndex(function (i) {
                            return i.Id == inv.Id;
                        });
                        if (index >= 0) {
                            list.splice(index, 1);
                        }
                    });
                },
                onDataFileChange: function (e) {
                    e.preventDefault();
                    let self = this;
                    self.selectedDataFileName = e.target.files[0].name;
                },
                upload: function (event) {
                    event && event.preventDefault();
                    let self = this;
                    var files = $("#datafile")[0].files;
                    if (!files.length) {
                        return;
                    }
                    var file = files[0];

                    this.createDataFile(file, function (datafile) {
                        let formData = new FormData();
                        formData.append('datafile', datafile);
                        showSpinner();
                        api().url("/facilities/importInventory/" + self.Facility.Id).parameters(formData).headers({ "Content-Type": "multipart-formdata", "Accept": "application/json" }).post().then(function (response) {
                            console.log(response);
                            self.fixFacilityAttributes(response.Facility);
                        }).catch(function (err) {
                            showError(err);
                        }).finally(function () {
                            self.selectedDataFileName = ""
                            $("#datafile")[0].value = null;
                            hideSpinner();
                        });
                    });
                },
                createDataFile: function (file, callback) {
                    var reader = new FileReader();
                    reader.onload = (e) => {
                        callback(e.target.result);
                    }
                    reader.readAsDataURL(file);
                },
                save: function (event) {
                    if (event) {
                        event.preventDefault();
                    }
                    let self = this;
                    let index = self.current.index;
                    let i = self.current.Inventory;
                    let newRecord = !i.Id;
                    delete i.Quantity;



                    showSpinner();
                    api().url("/api/adjust").parameters({
                        AdjustmentRequest: {
                            "Inventory": i, AdjustmentQuantity: self.current.AdjustmentQuantity,
                            Comment: "Adjust"
                        }
                    }).post().then(function (response) {
                        var inv = deepmerge(i, response.AdjustmentRequests[0].Inventory);
                        if (!inv.Sku.Item.AssetCode) {
                            inv.Sku.Item.AssetCode = { Code: "" };
                        }
                        if (!inv.Sku.Attachments) {
                            inv.Sku.Attachments = [{ Sku: { Id: inv.Sku.Id } }];
                            api().url("/skus/show/" + inv.Sku.Id).get().then(function (sku_response) {
                                inv.Sku.Attachments = sku_response.Sku.Attachments || [{ Sku: { Id: inv.Sku.Id } }];
                            });
                        }

                        self.search.results.splice(index, 1, inv);
                        self.updateLists(inv);
                        self.cancel(null);
                    }).catch(function (err) {
                        showError(err);
                    }).finally(function () {
                        hideSpinner();
                    });

                },
                zeroInventory: function (event, index) {
                    if (event) {
                        event.preventDefault();
                    }

                    let self = this;
                    let i = self.search.results[index];

                    let newRecord = !i.Id;
                    if (!newRecord) {
                        i.Infinite = "N";
                        showSpinner();
                        api().url("/api/adjust").parameters({ AdjustmentRequest: { Inventory: i, AdjustmentQuantity: -1 * i.Quantity, Comment: "Remove Inventory" } }).post().then(function (response) {
                            var inv = deepmerge(i, response.AdjustmentRequests[0].Inventory);
                            if (!inv.Sku.Item.AssetCode) {
                                inv.Sku.Item.AssetCode = { Code: "" };
                            }
                            self.updateLists(inv);
                        }).catch(function (err) {
                            showError(err);
                        }).finally(function () {
                            hideSpinner();
                        });
                    } else {
                        self.search.results.splice(index, 1);
                    }
                },
                destroy: function (event, index) {
                    if (event) {
                        event.preventDefault();
                    }

                    let self = this;
                    let i = self.search.results[index];

                    let newRecord = !i.Id;
                    if (!newRecord) {
                        //i.Infinite = "Y";
                        showSpinner();
                        api().url("/inventories/destroy/" + i.Id).get().then(function (response) {
                            self.clearFromLists(i);
                        }).catch(function (err) {
                            showError(err);
                        }).finally(function () {
                            hideSpinner();
                        });
                    } else {
                        self.search.results.splice(index, 1);
                    }
                },
                infiniteInventory: function (event, index) {
                    if (event) {
                        event.preventDefault();
                    }

                    let self = this;
                    let i = self.search.results[index];

                    let newRecord = !i.Id;
                    if (!newRecord) {
                        i.Infinite = "Y";
                        showSpinner();
                        api().url("/api/adjust").parameters({ AdjustmentRequest: { Inventory: i, AdjustmentQuantity: -1 * i.Quantity, Comment: "Mark Infinite Inventory" } }).post().then(function (response) {
                            var inv = deepmerge(i, response.AdjustmentRequests[0].Inventory);
                            if (!inv.Sku.Item.AssetCode) {
                                inv.Sku.Item.AssetCode = { Code: "" };
                            }
                            self.updateLists(inv);
                        }).catch(function (err) {
                            i.Infinite = "N";
                            showError(err);
                        }).finally(function () {
                            hideSpinner();
                        });
                    } else {
                        self.search.results.splice(index, 1, i);
                    }
                },
                isKeyTriggerable: function (e, length = 3) {
                    return e.inputType && e.target.value.length >= length;
                    /*
                    if (e && e.keyCode >= 48 && e.keyCode <= 90) {
                        return true;
                    }
                    return false;
                    */
                },
                _invokeItemLookup: function (e) {
                    let self = this;
                    if (self.current.Items.length == 0) {
                        self.current.Inventory.Sku = {
                            Item: {
                                Name: e.target.value,
                                Company: self.User.Company,
                                AssetCode: { "Code": "" },
                            },
                            Name: "",
                            SkuCode: "",
                            PackagingUOM: {
                                Measures: "Packaging",
                                Name: ""
                            },
                            Published: "Y"
                        };
                    } else {
                        self.loadLookupEntries(e.target);
                    }

                },
                onItemChange: function (e) {
                    e && e.preventDefault();
                    let self = this;

                    if (!self.isKeyTriggerable(e)) {
                        return;
                    }
                    new Autocomplete("items", e.target).search().then(function (response) {
                        if (!response) {
                            return
                        }
                        self.current.Items = response.Items;
                        self._invokeItemLookup(e);
                    });
                },
                onItemSelect: function (e, item) {
                    e && e.preventDefault();
                    let self = this;
                    self.hideKeyboard().then(function () {
                        self.current.Inventory.Sku.Item = item;
                        self.current.Inventory.MaxRetailPrice = self.current.Inventory.Sku.MaxRetailPrice;
                        self.current.Inventory.SellingPrice = self.current.Inventory.MaxRetailPrice;
                        delete self.current.Inventory.Sku.Id;
                        delete self.current.Inventory.Sku.Name;

                        if (!item.AssetCode) {
                            item.AssetCode = { Code: "" };
                        }
                        self.current.Items = [];
                    });
                },
                onAssetCodeChange: function (e) {
                    e && e.preventDefault();
                    if (!this.isKeyTriggerable(e)) {
                        return;
                    }

                    let self = this;

                    new Autocomplete("asset_codes", e.target).search().then(function (response) {
                        if (!response) {
                            return
                        }
                        self.current.AssetCodes = response.AssetCodes;
                        if (response.AssetCodes.length === 0) {
                            self.current.Inventory.Sku.Item.AssetCode = { Code: e.target.value };
                            //self.onAssetCodeSelect(null, self.current.AssetCodes[0]);
                        } else {
                            self.loadLookupEntries(e.target);
                        }
                    });
                },
                onAssetCodeSelect: function (e, ac) {
                    e && e.preventDefault();
                    let self = this;
                    self.hideKeyboard().then(function () {
                        self.current.Inventory.Sku.Item.AssetCode = ac;
                        self.current.AssetCodes = [];
                    });
                },

                onTagChange: function (e) {
                    e && e.preventDefault();
                    let triggerLength = 1
                    if (!this.isKeyTriggerable(e, triggerLength)) {
                        return;
                    }

                    let self = this;
                    let fieldValue = e.target.value;
                    let lastIndex = fieldValue.lastIndexOf(",");
                    var value = lastIndex < 0 ? fieldValue : fieldValue.substring(lastIndex + 1);
                    if (value.length == 0) {
                        self.current.Tags = [];
                    }
                    if (value.length < triggerLength) {
                        return;
                    }


                    api().url("/tags/search/" + value).get().then(function (response) {
                        if (!response) {
                            return
                        }
                        self.current.Tags = response.Tags;
                        if (response.Tags.length > 0) {
                            self.loadLookupEntries(e.target);
                        } else {
                            //self.current.Inventory.Tags = fieldValue;
                        }
                    });
                },
                onTagSelect: function (e, tag) {
                    e && e.preventDefault();
                    let self = this;
                    self.hideKeyboard().then(function () {
                        let lastIndex = self.current.Inventory.Tags.lastIndexOf(",");
                        if (lastIndex < 0) {
                            self.current.Inventory.Tags = tag.Name;
                        } else {
                            self.current.Inventory.Tags = self.current.Inventory.Tags.substring(0, lastIndex) + ", " + tag.Name;
                        }
                        self.current.Tags = [];
                    });
                },

                onUnitOfMeasureChange: function (e) {
                    e && e.preventDefault();
                    let self = this;

                    if (!this.isKeyTriggerable(e, 1) && self.current.UnitOfMeasures.length == 0) {
                        return;
                    }

                    delete self.current.Inventory.Sku.Id; //An Sku's modification is a change of Sku and not update of SKU.!!
                    delete self.current.Inventory.Sku.PackagingUOM.Id;
                    new Autocomplete("unit_of_measures", e.target, 1).search("NAME", "MEASURES:Packaging").then(function (response) {
                        if (response) {
                            self.current.UnitOfMeasures = response.UnitOfMeasures;
                        } else {
                            self.current.UnitOfMeasures = [];
                        }
                        if (self.current.UnitOfMeasures.length === 0) {
                            //self.onUnitOfMeasuresSelect(null, self.current.UnitOfMeasures[0]);
                            self.current.Inventory.Sku.PackagingUOM = {
                                Measures: "Packaging",
                                Name: e.target.value,
                            };
                        } else {
                            self.sortByItemUoms().then(function () {
                                self.loadLookupEntries(e.target);
                            });
                        }
                    });
                },
                sortByItemUoms: function () {
                    let self = this;
                    return new Promise(function (resolve, reject) {
                        if (self.current.Inventory.Sku.Item.Id) {
                            let acUoms = self.current.UnitOfMeasures.map(uom => uom.Id);

                            api().url("/skus/search").get({ "q": "ITEM_ID:" + self.current.Inventory.Sku.Item.Id }).then(function (r) {
                                return r.Skus.map(function (sku) {
                                    if (acUoms.indexOf(sku.PackagingUOM.Id) < 0) {
                                        acUoms.push(sku.PackagingUOM.Id);
                                        self.current.UnitOfMeasures.splice(0, 0, sku.PackagingUOM);
                                    }
                                    (sku.PackagingUOM.Id);
                                })
                            }).then(function (uomIds) {
                                let length = self.current.UnitOfMeasures.length;
                                self.current.UnitOfMeasures.sort(function (a, b) {
                                    return Math.max(uomIds.indexOf(a.Id), length) - Math.max(uomIds.indexOf(b.Id), length);
                                });
                                resolve();
                            });
                        } else {
                            resolve();
                        }
                    });
                },
                onUnitOfMeasuresSelect: function (e, uom) {
                    e && e.preventDefault();
                    let self = this;
                    self.hideKeyboard().then(function () {
                        delete uom.Id;
                        delete self.current.Inventory.Sku.Id;
                        delete self.current.Inventory.Sku.Name;
                        self.current.Inventory.Sku.PackagingUOM = uom;
                        self.current.UnitOfMeasures = [];
                        let q = { q: "ITEM:" + "\"LUCENE_START " + self.current.Inventory.Sku.Item.Name + " LUCENE_END\" AND PACKAGING_U_O_M:\"LUCENE_START " + uom.Name + " LUCENE_END\"" };
                        showSpinner();
                        api().url("/skus/search").get(q).then(function (response) {
                            if (response.Skus.length === 1) {
                                let sku = response.Skus[0];
                                if (sku.PackagingUOM.Name === uom.Name && sku.Item.Name === self.current.Inventory.Sku.Item.Name) {
                                    self.current.Inventory.Sku = sku;
                                    self.current.Inventory.MaxRetailPrice = self.current.Inventory.Sku.MaxRetailPrice || 0;
                                    self.current.Inventory.SellingPrice = self.current.Inventory.MaxRetailPrice || 0;
                                    self.current.Inventory.Tags = self.current.Inventory.Sku.Item.Tags;

                                    if (!self.current.Inventory.Sku.Item.AssetCode) {
                                        self.current.Inventory.Sku.Item.AssetCode = { Code: "" };
                                    }
                                }
                            }
                        }).finally(function () {
                            hideSpinner();
                        });
                    })
                },
                getParentDiv: function (element) {
                    var div = element;
                    while (div && div.tagName !== 'DIV') {
                        div = div.parentElement;
                    }
                    return div;
                },
                loadLookupEntries: function (element) {
                    var div = this.getParentDiv(element);
                    var InputId = div.getElementsByTagName("input")[0].id;
                    var offset = document.getElementById("lookupEntries").offsetTop;
                    //console.log("asdfasdf", document.getElementById(InputId).offsetTop, offset);
                    if (div) {
                        div.appendChild(this.$refs['lookupEntries'][0]);
                    }
                    let self = this;
                    if ($(".lookups-list").offset().top > 600) {
                        $(".lookups-list").addClass("offsetTop");
                    }
                },

                removeList: function (e) {
                    let elem = e.target;
                    let self = this;
                    //self.hideKeyboard().then(function(){
                    self.current.Items = [];
                    self.current.UnitOfMeasures = [];
                    self.current.AssetCodes = [];
                    self.current.Tags = [];
                    $(".lookups-list").removeClass("offsetTop");
                    //});
                },
                hideKeyboard: function () {
                    return new Promise(function (resolve, reject) {
                        //let dummy = $("#dummy");
                        let dummy = $(document.documentElement);
                        setTimeout(function () {
                            dummy.focus();
                            setTimeout(function () {
                                resolve();
                            }, 50);
                        }, 50);
                    });
                },

                navigate: function (e, index, length) {
                    e && e.preventDefault();
                    index = Math.max(index, 0);
                    let self = this;
                    self.current.lookupselectionIndex = (index % length);
                    let anchors = self.$refs['lookupEntries'].getElementsByTagName("a");
                    anchors[self.current.lookupselectionIndex].focus();
                },

                editBanner: function (event) {
                    event && event.preventDefault();
                    let self = this;
                    self.facilityBannerBeingEdited = true;
                },
                bannerEditComplete: function (event) {
                    event && event.preventDefault();
                    this.facilityBannerBeingEdited = false;
                },
                isBannerBeingAdded: function (event) {
                    let self = this;
                    let numAttachments = self.Facility.Attachments.length;
                    return (numAttachments != 0 && !self.Facility.Attachments[numAttachments - 1].Id);
                },
                addBanner: function (event) {
                    if (event) {
                        event.preventDefault();
                    }
                    let self = this;
                    if (!self.isBannerBeingAdded(event)) {
                        self.Facility.Attachments.push({ FacilityId: self.Facility.Id });
                    }
                },
                removeBannner: function (event, index) {
                    if (event) {
                        event.preventDefault();
                    }
                    let self = this;
                    if (self.Facility.Attachments[index].Id) {
                        showSpinner();
                        api().url("/attachments/destroy/" + self.Facility.Attachments[index].Id).get().then(function (response) {
                            self.Facility.Attachments.splice(index, 1);
                        }).catch(function (err) {
                            showError(err);
                        }).finally(function () {
                            hideSpinner();
                        });
                    } else {
                        self.Facility.Attachments.splice(index, 1);
                    }
                },
                onFacilityBannerFileChange: function (e, index) {
                    let self = this;
                    // self.Facility.Attachments[index].AttachmentContentName = e.target.files[0].name;
                    // self.Facility.Attachments[index].Dirty = true;
                    // Vue.set(self.Facility.Attachments, index, self.Facility.Attachments[index]);
                    self.readFacilityBannerUrl(e, e.target.files[0], index);
                    // self.uploadFacilityBannerFile(e, index);
                },
                onCancelUpload: function (e, index) {
                    let self = this;
                    self.facilityCropperBeingEdited = false;
                    $("#show-updated-img").cropper('destroy').attr("src", "");
                    $("#attachment-" + index).value(null);
                },
                readFacilityBannerUrl: function (event, file, index) {
                    var reader = new FileReader();
                    let self = this;

                    reader.onload = function (e) {
                        // self.Facility.Attachments[index].Attachment = e.target.result;
                        // Vue.set(self.Facility.Attachments, index, self.Facility.Attachments[index]);
                        self.facilityCropperBeingEdited = true;
                        $("#updated-image").attr("for", "attachment-" + index);
                        $("#show-updated-img").cropper('destroy').attr('src', e.target.result).cropper({
                            aspectRatio: 16 / 9,
                            // preview: '.img-preview',
                            crop: function (e) {
                                // console.log("Croppimage Data", e)
                            }
                        });
                    }
                    disableSwipe();
                    reader.readAsDataURL(file);
                    $("#cancle-update").click(function (e) {
                        self.onCancelUpload(e, index);
                        enableSwipe();
                    });
                    $("#UploadImage").click(function (e) {
                        self.uploadFacilityBannerFile(e, index);
                        enableSwipe();
                    });
                },
                uploadFacilityBannerFile: function (e, index) {
                    if (e) {
                        e.preventDefault();
                    }
                    console.log("uploadFacilityBannerFile", e, index);

                    // var files = $('#attachment-' + index)[0].files;

                    // if (!files.length) {
                    //     return;
                    // };

                    let self = this;
                    // var files = $('#sku-attachment-' + inventoryIndex)[0].files;
                    //Convert canvas image to Base64 $().cropper("getCroppedCanvas", { maxWidth: 4096, maxHeight: 4096 })
                    var snap = $("#show-updated-img").cropper("getCroppedCanvas", { width: 360, height: 165 });
                    var img = snap.toDataURL();
                    // // Convert Base64 image to binary
                    var croppedfile = self.dataURItoBlob(img, $('#attachment-' + index)[0].files[0].name);

                    var file = croppedfile;
                    let formData = new FormData();
                    formData.append("ATTACHMENT", file);
                    formData.append("FACILITY_ID", self.Facility.Id);
                    if (self.Facility.Attachments[index].Id) {
                        formData.append("ID", self.Facility.Attachments[index].Id);
                    }
                    showSpinner();
                    api().url("/attachments/save").parameters(formData).headers({ "Content-Type": "multipart/form-data" }).post().then(function (response) {
                        console.log(response);
                        if (self.Facility.Attachments[index].AttachmentUrl === response.Attachment.AttachmentUrl) {
                            response.Attachment.AttachmentUrl = "/attachments/show/0" + response.Attachment.AttachmentUrl;
                        }
                        self.Facility.Attachments.splice(index, 1, response.Attachment);
                        self.facilityCropperBeingEdited = false;
                    }).finally(function () {
                        hideSpinner();
                    });
                },
                createDataFile: function (file, callback) {
                    var reader = new FileReader();
                    reader.onload = (e) => {
                        callback(e.target.result);
                    }
                    reader.readAsDataURL(file);
                },

                removeSkuBannner: function (event, inventoryIndex, attachmentIndex) {
                    if (event) {
                        event.preventDefault();
                    }
                    let self = this;
                    let skuAttachment = self.search.results[inventoryIndex].Sku.Attachments[attachmentIndex];
                    if (skuAttachment.Id) {
                        showSpinner();
                        api().url("/attachments/destroy/" + skuAttachment.Id).get().then(function (response) {
                            self.search.results[inventoryIndex].Sku.Attachments.splice(attachmentIndex, 1);
                        }).catch(function (err) {
                            showError(err);
                        }).finally(function () {
                            hideSpinner();
                        });
                    } else {
                        self.search.results[inventoryIndex].Sku.Attachments.splice(attachmentIndex, 1);
                    }
                },
                onSkuBannerFileChange: function (e, inventoryIndex, attachmentIndex, newImage) {
                    e.preventDefault();
                    let self = this;
                    let skuAttachment = self.search.results[inventoryIndex].Sku.Attachments[attachmentIndex];
                    var reader = new FileReader();
                    reader.readAsDataURL(e.target.files[0]);
                    reader.onload = function (e) {
                        disableSwipe();
                        $('#PrivewImage' + inventoryIndex).cropper('destroy').attr('src', e.target.result).cropper({
                            aspectRatio: 1,
                            // preview: '.img-preview',
                            crop: function (e) {
                                // console.log("Croppimage Data", e)
                            }
                        });
                    }


                    if (e.target.files.length > 0) {
                        skuAttachment.AttachmentContentName = e.target.files[0].name;
                        skuAttachment.Dirty = true;
                        (!newImage) && $("#sku-modal-" + inventoryIndex).modal("show");
                        // self.readSkuBannerUrl(e, inventoryIndex, attachmentIndex);
                    }

                },
                readSkuBannerUrl: function (event, inventoryIndex, attachmentIndex) {
                    file = event.target.files[0];
                    var reader = new FileReader();
                    let self = this;

                    reader.onload = function (e) {
                        self.search.results[inventoryIndex].Sku.Attachments[attachmentIndex].Attachment = e.target.result;
                        Vue.set(self.search.results[inventoryIndex].Sku.Attachments, attachmentIndex, self.search.results[inventoryIndex].Sku.Attachments[attachmentIndex]);
                        self.uploadSkuBannerFile(e, inventoryIndex, attachmentIndex);
                    }

                    reader.readAsDataURL(file);
                },
                dataURItoBlob: function (dataURI, name) {
                    // convert base64/URLEncoded data component to raw binary data held in a string
                    var byteString;
                    if (dataURI.split(',')[0].indexOf('base64') >= 0)
                        byteString = atob(dataURI.split(',')[1]);
                    else
                        byteString = unescape(dataURI.split(',')[1]);
                    // separate out the mime component
                    var mimeString = dataURI.split(',')[0].split(':')[1].split(';')[0];
                    // write the bytes of the string to a typed array
                    var ia = new Uint8Array(byteString.length);
                    for (var i = 0; i < byteString.length; i++) {
                        ia[i] = byteString.charCodeAt(i);
                    }
                    return new File([ia], name, { type: mimeString });
                },
                uploadSkuBannerFile: function (e, inventoryIndex, attachmentIndex) {
                    let self = this;
                    if (e) {
                        e.preventDefault();
                        e.stopPropagation();
                    }

                    // var files = $('#sku-attachment-' + inventoryIndex)[0].files;
                    //Convert canvas image to Base64 $().cropper("getCroppedCanvas", { maxWidth: 4096, maxHeight: 4096 })
                    var snap = $("#PrivewImage" + inventoryIndex).cropper("getCroppedCanvas", { width: 500, height: 500 });
                    var img = snap.toDataURL();
                    // // Convert Base64 image to binary
                    var croppedfile = self.dataURItoBlob(img, $('#sku-attachment-' + inventoryIndex)[0].files[0].name);

                    // if (!files.length) {
                    //     return;
                    // };

                    var file = croppedfile;
                    let formData = new FormData();
                    let inv = self.search.results[inventoryIndex];
                    let attachment = self.search.results[inventoryIndex].Sku.Attachments[attachmentIndex];

                    formData.append("ATTACHMENT", file);
                    formData.append("SKU_ID", inv.Sku.Id);
                    if (attachment.Id) {
                        formData.append("ID", attachment.Id);
                    }
                    showSpinner();
                    api().url("/attachments/save").parameters(formData).headers({ "Content-Type": "multipart/form-data" }).post().then(function (response) {
                        console.log(response);
                        if (inv.Sku.Attachments[attachmentIndex].AttachmentUrl === response.Attachment.AttachmentUrl) {
                            response.Attachment.AttachmentUrl = "/attachments/show/0" + response.Attachment.AttachmentUrl;
                        }

                        inv.Sku.Attachments.splice(attachmentIndex, 1, response.Attachment);
                        $("#sku-modal-" + inventoryIndex).modal("hide");
                    }).catch(function (err) {
                        showError(err);
                    }).finally(function () {
                        hideSpinner();
                    });
                },
                chooseSkuFile: function (e, inventoryIndex) {
                    let fileinput = $("#sku-attachment-" + inventoryIndex);
                    fileinput.click();
                },
                chooseBannerFile: function (e, index) {
                    let fileinput = $("#attachment-" + index);
                    fileinput.click();
                },
                blank: function (s) {
                    return (!s || s.length === 0)
                },

                find: function (e) {
                    let self = this;
                    if (e) {
                        e.preventDefault();
                    }
                    if (blank(self.search.term)) {
                        self.search.results = self.loadInventory(self.Facility).then(function () {
                            console.log(self.search.results);
                        });
                    } else {
                        let term = self.search.term.toLowerCase();
                        self.loadInventory(self.Facility, { q: term }).then(function () {
                            self.search.results = self.Facility.Inventories;
                            console.log(self.search.results);
                        });
                    }
                },
                loadInventory: function (f, q = {}) {
                    let self = this;
                    return api().url("/facilities/show/" + id + "/inventories/search").get(q).then(function (invResponse) {
                        self.fixInventoryAttributes(f, invResponse.Inventories);
                        self.fixFacilityAttributes(f);
                    });
                },
                isDeliverySku: function (sku) {
                    return sku.Item.AssetCode && sku.Item.AssetCode.Code.startsWith("99681");
                },

            }
        });
    });
</script>
<div id="root" style="display:none;" v-if="Facility.Id">
    <div id="header">
    </div>
    <div id="app" class="app-body">
        <div class="modal fade" id="address-text" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            Facility Address</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        {{Facility.AddressLine1}}
                        {{!blank(Facility.AddressLine2) ? "," : "" }} {{ Facility.AddressLine2}}
                        {{!blank(Facility.AddressLine3) ? "," : "" }} {{Facility.AddressLine3}}
                        {{!blank(Facility.AddressLine4) ? "," : "" }} {{Facility.AddressLine4}}
                        {{Facility.City.Name}}-{{Facility.City.State.Name}}
                        ,{{Facility.PinCode.PinCode}}
                    </div>
                </div>
            </div>
        </div>
        <div class="facility-header">
            <div id="banner-slider" class="carousel slide" data-ride="carousel">
                <!-- Indicators -->
                <ul class="carousel-indicators">
                    <li data-target="#banner-slider" v-bind:data-slide-to="index"
                        v-bind:class="index == 0 ? 'active' : '' " v-for="(attachment,index) in Facility.Attachments">
                    </li>
                </ul>
                <!-- The slideshow -->
                <div class="carousel-inner">
                    <div v-bind:class="'justify-content-center carousel-item ' + (index == 0 ? 'active' : '') "
                        v-for="(attachment,index) in Facility.Attachments">
                        <img v-bind:src="attachment.AttachmentUrl" v-if="attachment.Id && !attachment.Dirty"></img>
                        <img v-bind:src="attachment.Attachment" v-else-if="attachment.Dirty"></img>
                    </div>
                </div>

                <!-- Left and right controls -->
                <a class="carousel-control-prev" href="#banner-slider" data-slide="prev">
                    <span class="carousel-control-prev-icon"></span>
                </a>
                <a class="carousel-control-next" href="#banner-slider" data-slide="next">
                    <span class="carousel-control-next-icon"></span>
                </a>

            </div>
            <div class="container facility-info">
                <div class="row">
                    <div class="col-12">
                        <div class="content-box">
                            <a href="#" class="banner-edit btn btn-sm btn-outline-primary bg-white"
                                @click="editBanner($event)" v-if="!facilityBannerBeingEdited"><i
                                    class="fas fa-camera"></i></a>
                            <div class="form-row">
                                <div class="col">
                                    <h6 class="mb-1"> {{Facility.Name}} </h6>
                                    <p class="text-muted address-text small mb-1" v-if="Facility.City"
                                        data-toggle="modal" data-target="#address-text">
                                        {{Facility.AddressLine1}}
                                        {{!blank(Facility.AddressLine2) ? "," : "" }} {{ Facility.AddressLine2}}
                                        {{!blank(Facility.AddressLine3) ? "," : "" }} {{Facility.AddressLine3}}
                                        {{!blank(Facility.AddressLine4) ? "," : "" }} {{Facility.AddressLine4}}
                                        {{Facility.City.Name}}-{{Facility.City.State.Name}}
                                        ,{{Facility.PinCode.PinCode}}
                                    </p>

                                </div>
                            </div>
                            <div class="form-row no-gutters">
                                <div v-bind:class="[!selectedDataFileName ? 'col':'col-9']">
                                    <a v-if="!selectedDataFileName" class="small" href="/sell/template">Inventory
                                        Template</a>
                                    <label v-else
                                        v-bind:class="[!selectedDataFileName ? 'btn btn-sm btn-primary w-100' :'mb-0 small d-block']"
                                        for="datafile">
                                        Click to Update File:
                                        <p class="mb-0 color-blue text-truncate">{{selectedDataFileName}}</p>
                                    </label>
                                </div>
                                <div v-bind:class="[!selectedDataFileName ? 'col-4 text-right':'col-3']">
                                    <input type="file" class="file-upload" id="datafile" accept="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
                                        v-on:input="onDataFileChange($event)" />
                                    <label v-if="!selectedDataFileName"
                                        v-bind:class="[!selectedDataFileName ? 'btn-outline-primary mb-0 w-100' :'']"
                                        for="datafile">
                                        <i class="fas fa-upload"></i>
                                        {{ selectedDataFileName && selectedDataFileName.length > 0 ?
                                        selectedDataFileName :
                                        "Template"}}
                                    </label>
                                    <a href="#" v-if="selectedDataFileName && selectedDataFileName.length > 0"
                                        class="btn btn-sm btn-block btn-primary" role="button" title="Upload"
                                        v-on:click="upload($event)">
                                        Upload
                                    </a>
                                </div>
                            </div>
                            <hr class="my-2" />
                            <div class="form-row mt-2">
                                <div class="col small">
                                    <span>Credit Balance: {{parseInt(User.BalanceOrderLineCount,10)}}</span>
                                </div>
                                <div class="col-7 small text-right">
                                    <span>{{blank(search.term)? "Store" : "Filtered"}} Items:
                                        {{search.results.length}} of {{Facility.NumSkus}} </span> |
                                    <a href="#/" class="mt-1 btn-outline-primary" role="button"
                                        v-on:click="create($event)" v-if="blank(search.term)">
                                        + New Product
                                    </a>
                                </div>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="col-12">
                                <div class="d-flex flex-row align-items-center">
                                    <input key="search" id="search" class="search-control"
                                        placeholder="Search for Items" v-on:input="find($event)"
                                        v-model="search.term" />
                                    <i class="fa fa-search"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="container">
            <div id="banners" class="show-update" v-if="facilityBannerBeingEdited">
                <div class="form-row">
                    <div class="col-7">
                        <label id="updated-image" v-bind:hidden="!facilityCropperBeingEdited"
                            class="btn btn-outline-primary btn-sm mb-2 float-right">Change Image</label>
                        <h6>{{facilityCropperBeingEdited ? "Upload banner Image" : "Update/ Add New banner"}}</h6>
                    </div>
                    <div class="col text-right" v-bind:hidden="facilityCropperBeingEdited">
                        <a href="#." @click="bannerEditComplete($event)" class="btn btn-sm btn-secondery">Close</a><a
                            href="#." class="btn btn-sm btn-primary" @click="addBanner($event)">Add New</a>
                    </div>
                </div>
                <div class="form-row" v-bind:hidden="facilityCropperBeingEdited">
                    <div class="col-4 col-sm-2 my-1" v-for="(attachment,i) in Facility.Attachments">
                        <span v-if="attachment.AttachmentUrl || attachment.Attachment"
                            @click="chooseBannerFile($event,i)" class="img-holder">
                            <img v-bind:src="!attachment.Dirty ? attachment.AttachmentUrl:attachment.Attachment"
                                class="w-100 h-100"></img>
                        </span>
                        <span v-else @click="chooseBannerFile($event,i)"
                            class="img-holder d-flex align-items-center justify-content-center border rounded-sm">
                            <div>
                                <i class="fa fa-image text-muted"></i>
                                Click to upload Image
                            </div>
                        </span>
                        <a href="#" class="btn btn-sm btn-block btn-outline-primary" role="button" title="Remove"
                            v-on:click="removeBannner($event,i)">
                            <i class="small fas fa-trash"></i>
                        </a>
                        <input type="file" class="file-upload" v-bind:key="'attachment-'+i" v-bind:id="'attachment-'+i"
                            v-on:input="onFacilityBannerFileChange($event,i)" accept="image/*" />
                    </div>
                </div>
                <div class="form-row" v-bind:hidden="!facilityCropperBeingEdited">
                    <div class="col">
                        <img src="" id="show-updated-img" class="img-fluid w-100" alt="">
                    </div>
                </div>
                <div class="form-row mt-2" v-bind:hidden="!facilityCropperBeingEdited">
                    <div class="col text-right">
                        <button id="cancle-update" class="btn btn-sm btn-secondery">Cancel</button>
                        <button id="UploadImage" class="btn btn-primary btn-sm mb-0 ml-2">Upload Image</button>
                    </div>
                </div>
            </div>
            <div class="pop-overlay" v-if="facilityBannerBeingEdited"></div>

            <div class="mt-1 row mt-sm-3">
                <div class="col-lg-3 col-sm-4" v-for="(inv,i) in search.results">
                    <div class="item-list" v-bind:id="'inventory-' + i ">
                        <div class="form-row">
                            <div class="col-4 col-sm-12">
                                <span v-for="(attachment,ai) in inv.Sku.Attachments">
                                    <div class="img-holder border rounded-sm">
                                        <img v-for="(attachment,ai) in "
                                            v-bind:src="!attachment.Dirty ? attachment.AttachmentUrl : attachment.Attachment"
                                            v-if="attachment.Id || attachment.Dirty" class="w-100" data-toggle="modal"
                                            v-bind:data-target="'#sku-img-'+inv.Sku.Item.Id" />
                                        </img>
                                        <div v-else
                                            class="default-img d-flex bg-light align-items-center justify-content-center border rounded-sm">
                                            <span class="font-weight-bold text-muted">{{inv.Sku.Item.Name}}</span>
                                        </div>
                                        <!-- Modal View Images-->
                                        <div v-if="attachment.Id || attachment.Dirty" class="modal fade"
                                            v-bind:id="'sku-img-'+inv.Sku.Item.Id" tabindex="-1"
                                            aria-labelledby="exampleModalLabel" aria-hidden="true">
                                            <div class="modal-dialog">
                                                <div class="modal-content">
                                                    <div class="modal-header">
                                                        <h5 class="modal-title" id="exampleModalLabel">
                                                            {{inv.Sku.Item.Name}}</h5>
                                                        <button type="button" class="close" data-dismiss="modal"
                                                            aria-label="Close">
                                                            <span aria-hidden="true">&times;</span>
                                                        </button>
                                                    </div>
                                                    <div class="modal-body">
                                                        <img class="img-fluid w-100 h-100"
                                                            v-bind:src="!attachment.Dirty ? attachment.AttachmentUrl : attachment.Attachment" />
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <!--
                                    <button type="button" class="btn btn-camera btn-sm btn-outline-primary"
                                        data-toggle="modal" v-bind:data-target="'#sku-modal-'+i">
                                        <i class="fa fa-camera"></i>
                                    </button> -->
                                    <label class="btn btn-camera btn-sm btn-outline-primary"
                                        v-bind:for="'sku-attachment-'+i">
                                        <i class="fa fa-camera"></i>
                                    </label>
                                    <input type="file" class="file-upload" v-bind:key="'sku-attachment-'+i"
                                        v-bind:id="'sku-attachment-'+i" accept="image/*"
                                        v-on:input="onSkuBannerFileChange($event,i,ai)" />
                                    <!-- Modal for Upload -->
                                    <div class="modal fade" v-bind:id="'sku-modal-'+i" tabindex="-1"
                                        aria-labelledby="exampleModalLabel" aria-hidden="true">
                                        <div class="modal-dialog">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <h6 class="modal-title">Image for {{inv.Sku.Item.Name}}</h6>
                                                    <button type="button" class="close" data-dismiss="modal"
                                                        aria-label="Close">
                                                        <span aria-hidden="true">&times;</span>
                                                    </button>
                                                </div>
                                                <div class="modal-body">
                                                    <img v-bind:id="'PrivewImage'+i" j class="PrivewImage" />
                                                    <!-- <a href="#" class="h-fill btn btn-primary" role="button"
                                                        title="Remove" v-on:click="removeSkuBannner($event,i,ai)">
                                                        <i class="small fas fa-trash"></i>
                                                    </a> -->
                                                    <!-- <div class="default-img d-flex align-items-center justify-content-center border rounded-sm"
                                                        v-else>
                                                        <i class="fa fa-image text-muted"></i>
                                                    </div> -->
                                                    <!--  select New Image
                                                    <label class="btn btn-camera btn-sm btn-outline-primary"
                                                        v-bind:for="'sku-attachment-'+i">
                                                        Choose Image
                                                    </label>
                                                    <input type="file" class="file-upload" v-bind:key="'sku-attachment-'+i"
                                                        v-bind:id="'sku-attachment-'+i" accept="image/*"
                                                        v-on:input="onSkuBannerFileChange($event,i,ai)" /> -->
                                                    <label class="btn btn-sm btn-outline-primary mt-2"
                                                        v-bind:for="'sku-attachment-'+i">
                                                        Select New Image
                                                    </label>
                                                    <input type="file" class="file-upload"
                                                        v-bind:key="'sku-attachment-'+i" v-bind:id="'sku-attachment-'+i"
                                                        accept="image/*"
                                                        v-on:input="onSkuBannerFileChange($event,i,ai,'NewImage')" />
                                                </div>
                                                <div class="modal-footer">
                                                    <button type="button" class="btn btn-secondary"
                                                        data-dismiss="modal">Close</button>
                                                    <a href="#" class="btn btn-primary" role="button" title="Upload"
                                                        v-on:click="uploadSkuBannerFile($event,i,ai)">
                                                        Upload Image
                                                    </a>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </span>
                            </div>
                            <div class="col pb-sm-0">
                                <div class="form-row mb-0">
                                    <div class="col text-right">
                                        <a href="#/" class="btn-sm btn-outline-primary" v-if="inv.Infinite === 'Y'"
                                            v-on:click="zeroInventory($event,i)" :disabled="current.index === i">
                                            <i class="fas fa-toggle-on"></i>
                                        </a>
                                        <a href="#/" class="btn-sm btn-outline-primary"
                                            v-on:click="infiniteInventory($event,i)" :disabled="current.index === i"
                                            v-else>
                                            <i class="fas fa-toggle-off"></i>
                                        </a>
                                        <a href="#/" v-if="current.index !== i" class="btn-sm btn-outline-primary"
                                            v-on:click="edit($event,i)">
                                            <i class=" fas fa-edit"></i>
                                        </a>
                                        <button v-if="current.index !== i" class="btn-sm btn btn-outline-primary"
                                            v-on:click="destroy($event,i)">
                                            Delete
                                        </button>
                                    </div>
                                </div>
                                <h6 class="m-0">{{inv.Sku.Item.Name}} -
                                    <small>{{inv.Sku.PackagingUOM.Name}}</small>
                                </h6>
                                <p class="mb-2 mb-2 small">{{inv.Tags}}</p>
                                <span>
                                    <strike v-if="inv.MaxRetailPrice * 1 > inv.SellingPrice * 1">&#x20B9;
                                        {{inv.MaxRetailPrice}}</strike>
                                    <b>&#x20B9; {{inv.SellingPrice}} </b>
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="show-update" v-if="current.index === i">
                        <div id="lookupEntries" ref="lookupEntries" class="lookups-list">
                            <a href="#" v-for="(item,index) in current.Items" v-if="current.Items.length > 0"
                                v-on:click="onItemSelect($event,item)" v-on:keyup.enter="onItemSelect($event,item)"
                                v-on:keyup.space="onItemSelect($event,item)"
                                v-on:keyup.up="navigate($event,index-1,current.Items.length)"
                                v-on:keyup.down="navigate($event,index+1,current.Items.length)">
                                <span>{{item.Name}}{{item.AssetCode ? "-" + item.AssetCode.Code:""}}</span>
                                <span v-bind:alt="item.AssetCode ? item.AssetCode.Description : ''"
                                    class="small d-block text-truncate">{{ item.AssetCode ? item.AssetCode.Description :
                                    ""}}</span>
                            </a>
                            <a href="#" v-for="(code,index) in current.AssetCodes" v-if="current.AssetCodes.length > 0"
                                v-on:click="onAssetCodeSelect($event,code)"
                                v-on:keyup.space="onAssetCodeSelect($event,code)"
                                v-on:keyup.enter="onAssetCodeSelect($event,code)"
                                v-on:keyup.up="navigate($event,index-1,current.AssetCodes.length)"
                                v-on:keyup.down="navigate($event,index+1,current.AssetCodes.length)">
                                <span class="d-block">{{code.Code}}</span>
                                <span class="small d-block text-truncate">{{code.Description}}</span>
                            </a>
                            <a href="#" v-for="(code,index) in current.UnitOfMeasures"
                                v-if="current.UnitOfMeasures.length > 0"
                                v-on:click="onUnitOfMeasuresSelect($event,code)"
                                v-on:keyup.space="onUnitOfMeasuresSelect($event,code)"
                                v-on:keyup.enter="onUnitOfMeasuresSelect($event,code)"
                                v-on:keyup.up="navigate($event,index-1,current.UnitOfMeasures.length)"
                                v-on:keyup.down="navigate($event,index+1,current.UnitOfMeasures.length)">{{code.Name}}
                            </a>

                            <a href="#" v-for="(code,index) in current.Tags" v-if="current.Tags.length > 0"
                                v-on:click="onTagSelect($event,code)">{{code.Name}} </a>
                        </div>
                        <h6 v-if="current.Inventory.Dirty">Modify Stock</h6>
                        <h6 v-else>Add New Stock</h6>
                        <div class="form-row mb-2">
                            <div class="col-7">
                                <label v-bind:for="'item' + i" class="small mb-0">Product Name</label>
                                <input v-bind:key="'item' + i" v-bind:id="'item' + i"
                                    class="form-control form-control-sm" placeholder="Product Name"
                                    v-model="current.Inventory.Sku.Item.Name" v-on:input="onItemChange($event)"
                                    v-on:focus="removeList($event)"
                                    v-on:keyup.down="navigate($event,0,current.Items.length)" />
                            </div>
                            <div class="col-5">
                                <label class="small mb-0" v-bind:for="'uom' + i">Package</label>
                                <input v-bind:key="'uom' + i" v-bind:id="'uom' + i" class="form-control form-control-sm"
                                    placeholder="Package" v-model="current.Inventory.Sku.PackagingUOM.Name"
                                    v-on:input="onUnitOfMeasureChange($event)" v-on:focus="removeList($event)"
                                    v-on:keyup.down="navigate($event,0,current.UnitOfMeasures.length)" />
                            </div>
                        </div>
                        <div class="form-row mb-2">
                            <div class="col-12">
                                <label v-bind:for="'tag' + i" class="small mb-0">Tags</label>
                                <input v-bind:key="'tag' + i" v-bind:id="'tag' + i" class="form-control form-control-sm"
                                    placeholder="Tags" v-model="current.Inventory.Tags" v-on:input="onTagChange($event)"
                                    v-on:focus="removeList($event)" />
                            </div>
                        </div>
                        <div class="form-row mb-2" v-if="User.Staff === 'Y' && isDeliverySku(current.Inventory.Sku)">
                            <div class="col">
                                <label v-bind:for="'ManagedBy' + i" class="small mb-0">{{current.Inventory.Published ===
                                    "Y"
                                    ? "Primary" : "Outsourced"}} Courier</label>
                                <select v-bind:key="'ManagedBy' + i" v-bind:id="'ManagedBy' + i"
                                    class="form-control form-control-sm" placeholder="Managed By"
                                    v-model="current.Inventory.ManagedBy" v-on:focus="removeList($event)">
                                    <option value="">Myself</option>
                                    <option value="wefast">Wefast</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row mb-2"
                            v-if="current.Inventory.ManagedBy &&  current.Inventory.ManagedBy.trim().length > 0">
                            <div class="col-7">
                                <label class="small mb-0" v-bind:for="'ApiToken' + i">Api Token</label>
                                <input v-bind:key="'ApiToken' + i" v-bind:id="'ApiToken' + i"
                                    class="form-control form-control-sm" placeholder="Api Token"
                                    v-model="current.Inventory.ApiToken" />
                            </div>
                            <div class="col-5">
                                <label class="small mb-0" v-bind:for="'CallbackToken' + i">Callback Token</label>
                                <input v-bind:key="'CallbackToken' + i" v-bind:id="'CallbackToken' + i"
                                    class="form-control form-control-sm" placeholder="Callback Token"
                                    v-model="current.Inventory.CallbackToken" />
                            </div>
                        </div>

                        <div class="form-row mb-2"
                            v-if="!current.Inventory.ManagedBy || current.Inventory.ManagedBy.trim().length === 0">
                            <div class="col-7">
                                <label class="small mb-0" v-bind:for="'price' + i">Selling Price</label>
                                <input v-bind:key="'price' + i" v-bind:id="'price' + i"
                                    class="form-control form-control-sm" placeholder="&#x20B9;0"
                                    v-model="current.Inventory.SellingPrice" />
                            </div>
                            <div class="col-5">
                                <label class="small mb-0" v-bind:for="'mrp' + i">MRP</label>
                                <input v-bind:key="'mrp' + i" v-bind:id="'mrp' + i" class="form-control form-control-sm"
                                    placeholder="&#x20B9;0" v-model="current.Inventory.MaxRetailPrice" />
                            </div>
                        </div>
                        <div class="form-row mb-2">
                            <div class="col-7">
                                <!-- If item is new only then gst is enterable -->
                                <label class="small mb-0" v-bind:for="'asset_code' + i">GST/SAC Code</label>
                                <input v-bind:key="'asset_code' + i" v-bind:id="'asset_code' + i"
                                    class="form-control form-control-sm" placeholder="GST/SAC Code"
                                    v-model="current.Inventory.Sku.Item.AssetCode.Code"
                                    :disabled="current.Inventory.Sku.Item.Id" v-on:input="onAssetCodeChange($event)"
                                    v-on:focus="removeList($event)"
                                    v-on:keyup.down="navigate($event,0,current.AssetCodes.length)" />
                            </div>
                            <div class="col-5">
                                <label class="small mb-0">Tax Rate:</label>
                                <br />
                                <label>{{current.Inventory.Sku.Item.AssetCode.GstPct}}</label>
                            </div>
                        </div>

                        <!--
                            <div class="row" v-else-if="inv.Sku.Item.AssetCode && inv.Sku.Item.AssetCode.LongDescription">
                                <div class="col-7" >
                                    <label class="small" >GST/SAC Code</label>
                                    <br/>
                                    <label>{{inv.Sku.Item.AssetCode.Code}}</label>
                                </div>
                                <div class="col-5" >
                                    <label class="small" >Tax Rate:</label>
                                    <br/>
                                    <label>{{inv.Sku.TaxRate}}</label>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-12">
                                    <label class="form-label small"  v-bind:for="'infinite' + i"  >Infinite</label>
                                    <input value="N" type="checkbox" v-bind:key="'infinite' + i"  v-bind:id="'infinite' + i"  class="mt-2 mb-3 form-check custom-control" placeholder="Infinite"
                                    v-model="inv.Infinite"  :disabled="current.index !== i || ( inv.Id && (inv.Quantity * 1.0  > 0))" true-value="Y" false-value="N" />
                                </div>
                                Quantity enabling may be complex. Disable for now.
                                <div class="col-4" v-if=" inv.Infinite === 'N'">
                                    <label class="form-label small"   v-bind:for="'quantity' + i"  >Available</label>
                                    <input v-bind:key="'quantity' + i"  v-bind:id="'quantity' + i"  class="form-control" placeholder="Quantity"
                                    v-model="inv.Quantity"  disabled="disabled"/>
                                </div>
                                <div class="col-5" v-if="current.index === i && inv.Infinite === 'N' ">
                                    <label class="form-label small"   v-bind:for="'quantity' + i"  >Adjust +/- </label>
                                    <input v-bind:key="'adjustquantity' + i"  v-bind:id="'adjustquantity' + i"  class="form-control" title="Adjustment Quantity"
                                    v-model="current.AdjustmentQuantity"  />
                                </div>
                            </div>
                            -->
                        <div class="text-right">
                            <a href="#/" class="btn btn-sm btn-light mr-2" role="button" v-on:click="cancel($event)">
                                Cancel
                            </a>
                            <a href="#/" class="btn btn-sm btn-primary" role="button" v-on:click="save($event)">
                                Save
                            </a>
                        </div>
                    </div>
                    <div class="pop-overlay" v-if="current.index === i"></div>
                </div>
            </div>
        </div>
    </div>

</div>
<div>
