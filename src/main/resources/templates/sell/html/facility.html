<script type="text/javascript" src="/resources/scripts/node_modules/lockr/lockr.min.js"></script>
<script type="text/javascript" src="/resources/scripts/node_modules/axios/dist/axios.min.js"></script>
<script type="text/javascript" src="/resources/scripts/node_modules/vue/dist/vue.js"></script>
<script type="text/javascript" src="/resources/scripts/node_modules/deepmerge/dist/umd.js"></script>
<script type="text/javascript" src="/resources/scripts/swf/js/entity_helper.js"></script>
<link href="/fragments/css/mandi.css" rel="stylesheet">
</link>
<script type="text/javascript" src="/fragments/js/util.js"></script>


<script type="text/javascript">
    $(function () {
        var params = (new URL(window.location)).searchParams;
        let id = params.get("id");

        new Vue({
            el: "#app",
            data: {
                User: Lockr.get("User"),
                Facility: { Inventories: [] },
                facilityBannerBeingEdited: false,
                timer: -1,
                current: {
                    index: -1,
                    Items: [],
                    UnitOfMeasures: [],
                    AssetCodes: [],
                    lookupselectionIndex: -1,
                    Inventory: {},
                    AdjustmentQuantity: 0,
                },

            },
            created: function () {
                let self = this;
                api().url("/facilities/show/" + id).get().then(function (response) {
                    if (!response.Facility.Inventories) {
                        response.Facility.Inventories = [];
                    }
                    response.Facility.Inventories.forEach((inv, i) => {
                        if (!inv.Sku.Item.AssetCode) {
                            inv.Sku.Item.AssetCode = { Code: "" };
                        }
                        if (!inv.Sku.Attachments) {
                            inv.Sku.Attachments = [{ Sku: { Id: inv.Sku.Id } }];
                        }
                    });
                    if (!response.Facility.Attachments) {
                        response.Facility.Attachments = [];
                    }
                    Vue.set(self, "Facility", response.Facility);
                    self.showApp();
                }).catch(function (err) {
                    self.showApp();
                    showError(err);
                })
            },
            methods: {
                showApp: function () {
                    $("#header").load("/fragments/html/header", {}, function () {
                        fixMenu();
                        new Vue({
                            el: "#header",
                            data: {
                                User: Lockr.get("User"),
                                navbar: { hide: false },
                            }
                        });
                        $(".navbar").addClass("bg-clear");
                        $(".body").css("padding-top", "300px");
                        $("#root").show();
                        $("#pageTitle").html("Sales-Facilities");
                    });
                },

                create: function (event) {
                    if (event) {
                        event.preventDefault();
                    }
                    let self = this;

                    var i = {
                        Company: self.User.Company,
                        Facility: { Id: self.Facility.Id },
                        Sku: {
                            Item: {
                                Name: "",
                                Company: { Name: "MANDI" },
                                AssetCode: { "Code": "" },
                            },
                            Name: "",
                            SkuCode: "",
                            PackagingUOM: {
                                Measures: "Packaging",
                                Name: ""
                            },
                            Published: "Y"
                        },
                        Quantity: "0",
                        Infinite: "N"
                    };
                    let last = self.Facility.Inventories.length > 0 ? self.Facility.Inventories[self.Facility.Inventories.length - 1] : null;

                    if (!last || last.Id) {
                        self.Facility.Inventories.push(i);
                        self.edit(null, self.Facility.Inventories.length - 1);
                    }

                },
                edit: function (event, index) {
                    if (event) {
                        event.preventDefault();
                    }
                    this.current.index = index;
                    if (index >= 0) {
                        this.current.Inventory = JSON.parse(JSON.stringify(this.Facility.Inventories[this.current.index]));
                    } else {
                        this.current.Inventory = {};
                        let length = this.Facility.Inventories.length;
                        let last = length > 0 ? this.Facility.Inventories[length - 1] : null;
                        if (last && !last.Id) {
                            this.Facility.Inventories.splice(length - 1, 1);
                        }
                        this.current.AdjustmentQuantity = 0;
                    }
                },
                cancel: function (event) {
                    if (event) {
                        event.preventDefault();
                    }
                    this.edit(event, -1);
                },
                save: function (event) {
                    if (event) {
                        event.preventDefault();
                    }
                    let self = this;
                    let index = self.current.index;
                    let i = self.current.Inventory;
                    let newRecord = !i.Id;
                    let newProduct = !i.Sku.Id;
                    delete i.Quantity;



                    api().url("/api/adjust").parameters({
                        AdjustmentRequest: {
                            NewProduct: newProduct, "Inventory": i, AdjustmentQuantity: self.current.AdjustmentQuantity,
                            Comment: "Adjust"
                        }
                    }).post().then(function (response) {
                        var inv = deepmerge(i, response.AdjustmentRequests[0].Inventory);
                        if (!inv.Sku.Item.AssetCode) {
                            inv.Sku.Item.AssetCode = { Code: "" };
                        }
                        if (!inv.Sku.Attachments) {
                            inv.Sku.Attachments = [{ Sku: { Id: inv.Sku.Id } }];
                            api().url("/skus/show/" + inv.Sku.Id).get().then(function (sku_response) {
                                inv.Sku.Attachments = sku_response.Sku.Attachments || [{ Sku: { Id: inv.Sku.Id } }];
                            });
                        }

                        if (newRecord) {
                            self.Facility.Inventories.splice(self.Facility.Inventories.length - 1, 1, inv);
                        } else {
                            self.Facility.Inventories.splice(index, 1, inv);
                        }
                        self.cancel(null);
                    }).catch(function (err) {
                        showError(err);
                    });

                },
                zeroInventory: function (event, index) {
                    if (event) {
                        event.preventDefault();
                    }

                    let self = this;
                    let i = self.Facility.Inventories[index];

                    let newRecord = !i.Id;
                    if (!newRecord) {
                        i.Infinite = "N";
                        api().url("/api/adjust").parameters({ AdjustmentRequest: { Inventory: i, AdjustmentQuantity: -1 * i.Quantity, Comment: "Remove Inventory", NewProduct: "N" } }).post().then(function (response) {
                            var inv = deepmerge(i, response.AdjustmentRequests[0].Inventory);
                            if (!inv.Sku.Item.AssetCode) {
                                inv.Sku.Item.AssetCode = { Code: "" };
                            }
                            self.Facility.Inventories.splice(index, 1, inv);
                        }).catch(function (err) {
                            showError(err);
                        });
                    } else {
                        self.Facility.Inventories.splice(index, 1);
                    }
                },
                destroy: function (event, index) {
                    if (event) {
                        event.preventDefault();
                    }

                    let self = this;
                    let i = self.Facility.Inventories[index];

                    let newRecord = !i.Id;
                    if (!newRecord) {
                        i.Infinite = "Y";
                        api().url("/inventories/destroy/" + i.Id).get().then(function (response) {
                            self.Facility.Inventories.splice(index, 1);
                        }).catch(function (err) {
                            showError(err);
                        });
                    } else {
                        self.Facility.Inventories.splice(index, 1);
                    }
                },
                infiniteInventory: function (event, index) {
                    if (event) {
                        event.preventDefault();
                    }

                    let self = this;
                    let i = self.Facility.Inventories[index];

                    let newRecord = !i.Id;
                    if (!newRecord) {
                        i.Infinite = "Y";
                        api().url("/api/adjust").parameters({ AdjustmentRequest: { Inventory: i, AdjustmentQuantity: -1 * i.Quantity, Comment: "Mark Infinite Inventory", NewProduct: "N" } }).post().then(function (response) {
                            var inv = deepmerge(i, response.AdjustmentRequests[0].Inventory);
                            if (!inv.Sku.Item.AssetCode) {
                                inv.Sku.Item.AssetCode = { Code: "" };
                            }
                            self.Facility.Inventories.splice(index, 1, inv);
                        }).catch(function (err) {
                            showError(err);
                        });
                    } else {
                        self.Facility.Inventories.splice(index, 1);
                    }
                },
                isKeyTriggerable: function (e, length = 3) {
                    return e.inputType && e.target.value.length >= length;
                    /*
                    if (e && e.keyCode >= 48 && e.keyCode <= 90) {
                        return true;
                    }
                    return false;
                    */
                },
                _invokeItemLookup: function (e) {
                    let self = this;
                    if (self.current.Items.length == 0) {
                        self.current.Inventory.Sku = {
                            Item: {
                                Name: e.target.value,
                                Company: { Name: "MANDI" },
                                AssetCode: { "Code": "" },
                            },
                            Name: "",
                            SkuCode: "",
                            PackagingUOM: {
                                Measures: "Packaging",
                                Name: ""
                            },
                            Published: "Y"
                        };
                    } else {
                        self.loadLookupEntries(e.target);
                    }

                },
                onItemChange: function (e) {
                    e && e.preventDefault();
                    let self = this;

                    if (!self.isKeyTriggerable(e)) {
                        return;
                    }
                    new Autocomplete("items", e.target).search().then(function (response) {
                        if (!response) {
                            return
                        }
                        self.current.Items = response.Items;
                        self._invokeItemLookup(e);
                    });
                },
                onItemSelect: function (e, item) {
                    e && e.preventDefault();
                    let self = this;
                    self.hideKeyboard().then(function () {
                        self.current.Inventory.Sku.Item = item;
                        //self.current.Inventory.SellingPrice = self.current.Inventory.Sku.MaxRetailPrice
                        if (!item.AssetCode) {
                            item.AssetCode = { Code: "" };
                        }
                        self.current.Items = [];
                    });
                },
                onAssetCodeChange: function (e) {
                    e && e.preventDefault();
                    if (!this.isKeyTriggerable(e)) {
                        return;
                    }

                    let self = this;

                    new Autocomplete("asset_codes", e.target).search().then(function (response) {
                        if (!response) {
                            return
                        }
                        self.current.AssetCodes = response.AssetCodes;
                        if (response.AssetCodes.length === 0) {
                            self.current.Inventory.Sku.Item.AssetCode = { Code: e.target.value };
                            //self.onAssetCodeSelect(null, self.current.AssetCodes[0]);
                        } else {
                            self.loadLookupEntries(e.target);
                        }
                    });
                },
                onAssetCodeSelect: function (e, ac) {
                    e && e.preventDefault();
                    let self = this;
                    self.hideKeyboard().then(function () {
                        self.current.Inventory.Sku.Item.AssetCode = ac;
                        self.current.AssetCodes = [];
                    });
                },
                onUnitOfMeasureChange: function (e) {
                    e && e.preventDefault();
                    let self = this;

                    if (!this.isKeyTriggerable(e, 1) && self.current.UnitOfMeasures.length == 0) {
                        return;
                    }

                    delete self.current.Inventory.Sku.Id; //An Sku's modification is a change of Sku and not update of SKU.!!
                    delete self.current.Inventory.Sku.PackagingUOM.Id;
                    new Autocomplete("unit_of_measures", e.target, 1).search("NAME", "MEASURES:Packaging").then(function (response) {

                        if (response) {
                            self.current.UnitOfMeasures = response.UnitOfMeasures;
                        } else {
                            self.current.UnitOfMeasures = [];
                        }
                        if (self.current.UnitOfMeasures.length === 0) {
                            //self.onUnitOfMeasuresSelect(null, self.current.UnitOfMeasures[0]);
                            self.current.Inventory.Sku.PackagingUOM = {
                                Measures: "Packaging",
                                Name: e.target.value,
                            };
                        } else {
                            self.loadLookupEntries(e.target);
                        }
                    });
                },
                onUnitOfMeasuresSelect: function (e, uom) {
                    e && e.preventDefault();
                    let self = this;
                    self.hideKeyboard().then(function () {
                        delete uom.Id;
                        delete self.current.Inventory.Sku.Id;
                        self.current.Inventory.Sku.PackagingUOM = uom;
                        self.current.UnitOfMeasures = [];
                        let q = { q: "ITEM:" + self.current.Inventory.Sku.Item.Name + " AND PACKAGING_U_O_M:" + uom.Name };
                        api().url("/skus/search").get(q).then(function (response) {
                            if (response.Skus.length === 1) {
                                self.current.Inventory.Sku = response.Skus[0];
                                self.current.Inventory.SellingPrice = 0;// self.current.Inventory.Sku.MaxRetailPrice;
                                if (!self.current.Inventory.Sku.Item.AssetCode) {
                                    self.current.Inventory.Sku.Item.AssetCode = { Code: "" };
                                }
                            }
                        });
                    })
                },
                getParentDiv: function (element) {
                    var div = element;
                    while (div && div.tagName !== 'DIV') {
                        div = div.parentElement;
                    }
                    return div;
                },
                loadLookupEntries: function (element) {
                    var div = this.getParentDiv(element);
                    var InputId = div.getElementsByTagName("input")[0].id;
                    var offset = document.getElementById("lookupEntries").offsetTop;
                    //console.log("asdfasdf", document.getElementById(InputId).offsetTop, offset);
                    if (div) {
                        div.appendChild(this.$refs['lookupEntries']);
                    }
                    let self = this;
                    if ($(".lookups-list").offset().top > 600) {
                        $(".lookups-list").addClass("offsetTop");
                    }
                },

                removeList: function (e) {
                    let elem = e.target;
                    let self = this;
                    //self.hideKeyboard().then(function(){
                    self.current.Items = [];
                    self.current.UnitOfMeasures = [];
                    self.current.AssetCodes = [];
                    $(".lookups-list").removeClass("offsetTop");
                    //});
                },
                hideKeyboard: function () {
                    return new Promise(function (resolve, reject) {
                        //let dummy = $("#dummy");
                        let dummy = $(document.documentElement);
                        setTimeout(function () {
                            dummy.focus();
                            setTimeout(function () {
                                resolve();
                            }, 50);
                        }, 50);
                    });
                },

                navigate: function (e, index, length) {
                    e && e.preventDefault();
                    index = Math.max(index, 0);
                    let self = this;
                    self.current.lookupselectionIndex = (index % length);
                    let anchors = self.$refs['lookupEntries'].getElementsByTagName("a");
                    anchors[self.current.lookupselectionIndex].focus();
                },

                editBanner: function (event) {
                    event && event.preventDefault();
                    let self = this;
                    self.facilityBannerBeingEdited = true;
                },
                bannerEditComplete: function (event) {
                    event && event.preventDefault();
                    this.facilityBannerBeingEdited = false;
                },
                isBannerBeingAdded: function (event) {
                    let self = this;
                    let numAttachments = self.Facility.Attachments.length;
                    return (numAttachments != 0 && !self.Facility.Attachments[numAttachments - 1].Id);
                },
                addBanner: function (event) {
                    if (event) {
                        event.preventDefault();
                    }
                    let self = this;
                    if (!self.isBannerBeingAdded(event)) {
                        self.Facility.Attachments.push({ FacilityId: self.Facility.Id });
                    }
                },
                removeBannner: function (event, index) {
                    if (event) {
                        event.preventDefault();
                    }
                    let self = this;
                    if (self.Facility.Attachments[index].Id) {
                        api().url("/attachments/destroy/" + self.Facility.Attachments[index].Id).get().then(function (response) {
                            self.Facility.Attachments.splice(index, 1);
                        }).catch(function (err) {
                            showError(err);
                        });
                    } else {
                        self.Facility.Attachments.splice(index, 1);
                    }
                },
                onFacilityBannerFileChange: function (e, index) {
                    let self = this;
                    self.Facility.Attachments[index].AttachmentContentName = e.target.files[0].name;
                    self.Facility.Attachments[index].Dirty = true;
                    Vue.set(self.Facility.Attachments, index, self.Facility.Attachments[index]);
                    self.readFacilityBannerUrl(e.target.files[0], index);
                    self.uploadFacilityBannerFile(e, index);
                },
                readFacilityBannerUrl: function (file, index) {
                    var reader = new FileReader();
                    let self = this;

                    reader.onload = function (e) {
                        self.Facility.Attachments[index].Attachment = e.target.result;
                        Vue.set(self.Facility.Attachments, index, self.Facility.Attachments[index]);
                    }

                    reader.readAsDataURL(file);
                },
                uploadFacilityBannerFile: function (e, index) {
                    if (e) {
                        e.preventDefault();
                    }

                    var files = $('#attachment-' + index)[0].files;

                    if (!files.length) {
                        return;
                    };

                    var file = files[0];
                    let self = this;
                    let formData = new FormData();
                    formData.append("ATTACHMENT", file);
                    formData.append("FACILITY_ID", self.Facility.Id);
                    if (self.Facility.Attachments[index].Id) {
                        formData.append("ID", self.Facility.Attachments[index].Id);
                    }
                    api().url("/attachments/save").parameters(formData).headers({ "Content-Type": "multipart/form-data" }).post().then(function (response) {
                        console.log(response);
                        if (self.Facility.Attachments[index].AttachmentUrl === response.Attachment.AttachmentUrl) {
                            response.Attachment.AttachmentUrl = "/attachments/show/0" + response.Attachment.AttachmentUrl;
                        }
                        self.Facility.Attachments.splice(index, 1, response.Attachment);
                    });
                },
                createDataFile: function (file, callback) {
                    var reader = new FileReader();
                    reader.onload = (e) => {
                        callback(e.target.result);
                    }
                    reader.readAsDataURL(file);
                },

                removeSkuBannner: function (event, inventoryIndex, attachmentIndex) {
                    if (event) {
                        event.preventDefault();
                    }
                    let self = this;
                    let skuAttachment = self.Facility.Inventories[inventoryIndex].Sku.Attachments[attachmentIndex];
                    if (skuAttachment.Id) {
                        api().url("/attachments/destroy/" + skuAttachment.Id).get().then(function (response) {
                            self.Facility.Inventories[inventoryIndex].Sku.Attachments.splice(attachmentIndex, 1);
                        }).catch(function (err) {
                            showError(err);
                        });
                    } else {
                        self.Facility.Inventories[inventoryIndex].Sku.Attachments.splice(attachmentIndex, 1);
                    }
                },
                onSkuBannerFileChange: function (e, inventoryIndex, attachmentIndex) {
                    //e.preventDefault();
                    let self = this;
                    let skuAttachment = self.Facility.Inventories[inventoryIndex].Sku.Attachments[attachmentIndex];

                    if (e.target.files.length > 0) {
                        skuAttachment.AttachmentContentName = e.target.files[0].name;
                        skuAttachment.Dirty = true;
                        self.readSkuBannerUrl(e, inventoryIndex, attachmentIndex);
                    }

                },
                readSkuBannerUrl: function (event, inventoryIndex, attachmentIndex) {
                    file = event.target.files[0];
                    var reader = new FileReader();
                    let self = this;

                    reader.onload = function (e) {
                        self.Facility.Inventories[inventoryIndex].Sku.Attachments[attachmentIndex].Attachment = e.target.result;
                        Vue.set(self.Facility.Inventories[inventoryIndex].Sku.Attachments, attachmentIndex, self.Facility.Inventories[inventoryIndex].Sku.Attachments[attachmentIndex]);
                        self.uploadSkuBannerFile(e, inventoryIndex, attachmentIndex);
                    }

                    reader.readAsDataURL(file);
                },
                uploadSkuBannerFile: function (e, inventoryIndex, attachmentIndex) {
                    if (e) {
                        e.preventDefault();
                        e.stopPropagation();
                    }

                    var files = $('#sku-attachment-' + inventoryIndex)[0].files;

                    if (!files.length) {
                        return;
                    };

                    var file = files[0];
                    let self = this;
                    let formData = new FormData();
                    let inv = self.Facility.Inventories[inventoryIndex];
                    let attachment = self.Facility.Inventories[inventoryIndex].Sku.Attachments[attachmentIndex];

                    formData.append("ATTACHMENT", file);
                    formData.append("SKU_ID", inv.Sku.Id);
                    if (attachment.Id) {
                        formData.append("ID", attachment.Id);
                    }
                    api().url("/attachments/save").parameters(formData).headers({ "Content-Type": "multipart/form-data" }).post().then(function (response) {
                        console.log(response);
                        if (inv.Sku.Attachments[attachmentIndex].AttachmentUrl === response.Attachment.AttachmentUrl) {
                            response.Attachment.AttachmentUrl = "/attachments/show/0" + response.Attachment.AttachmentUrl;
                        }

                        inv.Sku.Attachments.splice(attachmentIndex, 1, response.Attachment);
                    }).catch(function (err) {
                        showError(err);
                    });
                },
                chooseSkuFile: function (e, inventoryIndex) {
                    let fileinput = $("#sku-attachment-" + inventoryIndex);
                    fileinput.click();
                },
                chooseBannerFile: function (e, index) {
                    let fileinput = $("#attachment-" + index);
                    fileinput.click();
                },
                blank: function (s) {
                    return (!s || s.length === 0)
                }

            }
        });
    });
</script>
<style>
    /* Make the image fully responsive */
    .carousel-inner img {
        height: 200px;
        width: 100%;
    }

    .carousel-inner {
        background: gray;
    }

    .banner-edit {
        bottom: 38px;
        right: 23px;
        position: absolute;
        z-index: 2;
    }
</style>
<div id="root" style="display:none;">
    <div id="header">
    </div>
    <div id="app" class="app-body">
        <div id="lookupEntries" ref="lookupEntries" class="lookups-list">
            <a href="#" v-for="(item,index) in current.Items" v-if="current.Items.length > 0"
                v-on:click="onItemSelect($event,item)" v-on:keyup.enter="onItemSelect($event,item)"
                v-on:keyup.space="onItemSelect($event,item)"
                v-on:keyup.up="navigate($event,index-1,current.Items.length)"
                v-on:keyup.down="navigate($event,index+1,current.Items.length)">
                <span>{{item.Name}}{{item.AssetCode ? "-" + item.AssetCode.Code:""}}</span>
                <span v-bind:alt="item.AssetCode.Description"
                    class="small d-block text-truncate">{{ item.AssetCode ? item.AssetCode.Description : ""}}</span>
            </a>
            <a href="#" v-for="(code,index) in current.AssetCodes" v-if="current.AssetCodes.length > 0"
                v-on:click="onAssetCodeSelect($event,code)" v-on:keyup.space="onAssetCodeSelect($event,code)"
                v-on:keyup.enter="onAssetCodeSelect($event,code)"
                v-on:keyup.up="navigate($event,index-1,current.AssetCodes.length)"
                v-on:keyup.down="navigate($event,index+1,current.AssetCodes.length)">
                <span class="d-block">{{code.Code}}</span>
                <span class="small d-block text-truncate">{{code.Description}}</span>
            </a>
            <a href="#" v-for="(code,index) in current.UnitOfMeasures" v-if="current.UnitOfMeasures.length > 0"
                v-on:click="onUnitOfMeasuresSelect($event,code)" v-on:keyup.space="onUnitOfMeasuresSelect($event,code)"
                v-on:keyup.enter="onUnitOfMeasuresSelect($event,code)"
                v-on:keyup.up="navigate($event,index-1,current.UnitOfMeasures.length)"
                v-on:keyup.down="navigate($event,index+1,current.UnitOfMeasures.length)">{{code.Name}} </a>
        </div>
        <div class="facility-header">
            <div id="banner-slider" class="carousel slide" data-ride="carousel">
                <!-- Indicators -->
                <ul class="carousel-indicators">
                    <li data-target="#banner-slider" v-bind:data-slide-to="index"
                        v-bind:class="index == 0 ? 'active' : '' " v-for="(attachment,index) in Facility.Attachments">
                    </li>
                </ul>
                <!-- The slideshow -->
                <div class="carousel-inner">
                    <div v-bind:class="'justify-content-center carousel-item ' + (index == 0 ? 'active' : '') "
                        v-for="(attachment,index) in Facility.Attachments">
                        <img v-bind:src="attachment.AttachmentUrl" v-if="attachment.Id && !attachment.Dirty"></img>
                        <img v-bind:src="attachment.Attachment" v-else-if="attachment.Dirty"></img>
                    </div>
                </div>

                <!-- Left and right controls -->
                <a class="carousel-control-prev" href="#banner-slider" data-slide="prev">
                    <span class="carousel-control-prev-icon"></span>
                </a>
                <a class="carousel-control-next" href="#banner-slider" data-slide="next">
                    <span class="carousel-control-next-icon"></span>
                </a>
                <a href="#" class="banner-edit btn btn-camera btn-sm btn-outline-primary" @click="editBanner($event)"
                    v-if="!facilityBannerBeingEdited"><i class="fas fa-camera"></i> Banner</a>
            </div>
            <div class="container facility-info">
                <div class="row">
                    <div class="col-12">
                        <div class="content-box">
                            <div class="form-row">
                                <div class="col">
                                    <h6 class="mb-0"> {{Facility.Name}} </h6>
                                    <p class="text-muted small mb-0" v-if="Facility.City">
                                        {{Facility.AddressLine1}}
                                        {{!blank(Facility.AddressLine2) ? "," : "" }} {{ Facility.AddressLine2}}
                                        {{!blank(Facility.AddressLine3) ? "," : "" }} {{Facility.AddressLine3}}
                                        {{!blank(Facility.AddressLine4) ? "," : "" }} {{Facility.AddressLine4}}
                                        {{Facility.City.Name}}-{{Facility.City.State.Name}}
                                        ,{{Facility.PinCode.PinCode}}
                                    </p>
                                </div>
                            </div>
                            <hr class="my-2" />
                            <div class="form-row mt-2">
                                <div class="col small">
                                    <span>Credit Balance: {{User.BalanceOrderLineCount}}</span>
                                </div>
                                <div class="col small text-right">
                                    <span>Store Items: {{Facility.Inventories.length}}</span>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="col text-right">
                                    <a href="#/" class="mt-1 btn btn-sm btn-outline-primary" role="button"
                                        v-on:click="create($event)">
                                        + New Product
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="container">
            <div id="banners" class="show-update" v-if="facilityBannerBeingEdited">
                <div class="form-row">
                    <div class="col">
                        <h6>Update/ Add New banner</h6>
                    </div>
                    <div class="col-2 text-right">
                        <a href="#" @click="bannerEditComplete($event)" v-if="facilityBannerBeingEdited"><i
                                class="fas fa-times"></i></a>
                    </div>
                </div>
                <div class="form-row mb-2">
                    <div class="col text-right">
                        <a href="#" class="btn btn-sm btn-primary" @click="addBanner($event)">Add New</a>
                    </div>
                </div>
                <div class="form-row">
                    <div class="col-4 my-1" v-for="(attachment,i) in Facility.Attachments">
                        <span v-if="attachment.AttachmentUrl || attachment.Attachment"
                            @click="chooseBannerFile($event,i)" class="img-holder">
                            <img v-bind:src="!attachment.Dirty ? attachment.AttachmentUrl:attachment.Attachment"
                                class="w-100"></img>
                        </span>
                        <span v-else @click="chooseBannerFile($event,i)" class="img-holder d-flex align-items-center justify-content-center border rounded-sm">
                            <div>
                                <i class="fa fa-image text-muted"></i>
                                Click to upload Image
                            </div>
                        </span>
                        <a href="#" class="btn btn-sm btn-block btn-outline-primary" role="button" title="Remove"
                            v-on:click="removeBannner($event,i)">
                            <i class="small fas fa-trash"></i>
                        </a>

                        <input type="file" class="file-upload" v-bind:key="'attachment-'+i" v-bind:id="'attachment-'+i"
                            v-on:input="onFacilityBannerFileChange($event,i)" accept="image/*" capture="camera" />

                    </div>
                </div>
            </div>
            <div class="pop-overlay" v-if="facilityBannerBeingEdited"></div>

            <div v-bind:id="'inventory-' + i " class="mt-1 form-row" v-for="(inv,i) in Facility.Inventories">
                <div class="col-12">
                    <div class="item-list">
                        <div class="form-row">
                            <button v-if="current.index !== i"
                                class="btn-sm btn-inv-remove btn-outline-primary d-flex align-contents-center justify-content-center"
                                v-on:click="destroy($event,i)">
                                <i class="fas fa-times"></i>
                            </button>
                            <div class="col-4 img-holder">
                                <img v-for="(attachment,ai) in inv.Sku.Attachments"
                                    v-bind:src="!attachment.Dirty ? attachment.AttachmentUrl : attachment.Attachment"
                                    v-if="attachment.Id || attachment.Dirty" class="w-100">
                                </img>
                                <div class="default-img d-flex align-items-center justify-content-center border rounded-sm"
                                    v-else>
                                    <i class="fa fa-image text-muted"></i>
                                </div>
                                <span v-for="(attachment,ai) in inv.Sku.Attachments">
                                    <label class="btn btn-camera btn-sm btn-outline-primary"
                                        v-bind:for="'sku-attachment-'+i">
                                        <i class="fa fa-camera"></i>
                                    </label>
                                    <input type="file" class="file-upload" v-bind:key="'sku-attachment-'+i"
                                        v-bind:id="'sku-attachment-'+i" accept="image/*" capture="camera"
                                        v-on:input="onSkuBannerFileChange($event,i,ai)" />
                                    <!--
                                    <a href="#" class="btn btn-sm btn-block m-0 mt-2 btn-primary" role="button"
                                        title="Upload" v-on:click="uploadSkuBannerFile($event,i,ai)"
                                        v-if="attachment.Dirty">
                                        Save
                                    </a>
                                     <a href="#" class="h-fill btn btn-primary" role="button" title="Remove"
                                        v-on:click="removeSkuBannner($event,i,ai)">
                                        <i class="small fas fa-trash"></i>
                                    </a> -->
                                </span>
                            </div>
                            <div class="col">
                                <div class="form-row mb-2">
                                    <div class="col text-right">
                                        <a href="#/" class="btn-sm btn-outline-primary" v-if="inv.Infinite === 'Y'"
                                            v-on:click="zeroInventory($event,i)" :disabled="current.index === i">
                                            <i class="fas fa-toggle-on"></i>
                                        </a>
                                        <a href="#/" class="btn-sm btn-outline-primary"
                                            v-on:click="infiniteInventory($event,i)" :disabled="current.index === i"
                                            v-else>
                                            <i class="fas fa-toggle-off"></i>
                                        </a>
                                        <a href="#/" v-if="current.index !== i" class="btn-sm btn-outline-primary"
                                            v-on:click="edit($event,i)">
                                            <i class=" fas fa-edit"></i>
                                        </a>
                                    </div>
                                </div>
                                <h6 class="m-0">{{inv.Sku.Item.Name}} -
                                    <small>{{inv.Sku.PackagingUOM.Name}}</small>
                                </h6>
                                <span>
                                    <b>&#x20B9; {{inv.SellingPrice}}</b>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="show-update" v-if="current.index === i">
                    <h6 v-if="current.Inventory.Dirty">Modify Stock</h6>
                    <h6 v-else>Add New Stock</h6>
                    <div class="form-row mb-2">
                        <div class="col-7">
                            <label v-bind:for="'item' + i" class="small mb-0">Product Name</label>
                            <input v-bind:key="'item' + i" v-bind:id="'item' + i" class="form-control form-control-sm"
                                placeholder="Product Name" v-model="current.Inventory.Sku.Item.Name"
                                v-on:input="onItemChange($event)" v-on:focus="removeList($event)"
                                v-on:keyup.down="navigate($event,0,current.Items.length)" />
                        </div>
                        <div class="col-5">
                            <label class="small mb-0" v-bind:for="'uom' + i">Package</label>
                            <input v-bind:key="'uom' + i" v-bind:id="'uom' + i" class="form-control form-control-sm"
                                placeholder="Package" v-model="current.Inventory.Sku.PackagingUOM.Name"
                                v-on:input="onUnitOfMeasureChange($event)" v-on:focus="removeList($event)"
                                v-on:keyup.down="navigate($event,0,current.UnitOfMeasures.length)" />
                        </div>
                    </div>
                    <div class="form-row mb-2">
                        <div class="col-7">
                            <label class="small mb-0" v-bind:for="'price' + i">Selling Price</label>
                            <input v-bind:key="'price' + i" v-bind:id="'price' + i" class="form-control form-control-sm"
                                placeholder="Price" v-model="current.Inventory.SellingPrice" />
                        </div>
                    </div>
                    <div class="form-row mb-2">
                        <div class="col-7">
                            <!-- If item is new only then gst is enterable -->
                            <label class="small mb-0" v-bind:for="'asset_code' + i">GST/SAC Code</label>
                            <input v-bind:key="'asset_code' + i" v-bind:id="'asset_code' + i"
                                class="form-control form-control-sm" placeholder="GST/SAC Code"
                                v-model="current.Inventory.Sku.Item.AssetCode.Code"
                                :disabled="current.Inventory.Sku.Item.Id" v-on:input="onAssetCodeChange($event)"
                                v-on:focus="removeList($event)"
                                v-on:keyup.down="navigate($event,0,current.AssetCodes.length)" />
                        </div>
                        <div class="col-5">
                            <label class="small mb-0">Tax Rate:</label>
                            <br />
                            <label>{{current.Inventory.Sku.Item.AssetCode.GstPct}}</label>
                        </div>
                    </div>

                    <!--
                        <div class="row" v-else-if="inv.Sku.Item.AssetCode && inv.Sku.Item.AssetCode.LongDescription">
                            <div class="col-7" >
                                <label class="small" >GST/SAC Code</label>
                                <br/>
                                <label>{{inv.Sku.Item.AssetCode.Code}}</label>
                            </div>
                            <div class="col-5" >
                                <label class="small" >Tax Rate:</label>
                                <br/>
                                <label>{{inv.Sku.TaxRate}}</label>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12">
                                <label class="form-label small"  v-bind:for="'infinite' + i"  >Infinite</label>
                                <input value="N" type="checkbox" v-bind:key="'infinite' + i"  v-bind:id="'infinite' + i"  class="mt-2 mb-3 form-check custom-control" placeholder="Infinite"
                                v-model="inv.Infinite"  :disabled="current.index !== i || ( inv.Id && (inv.Quantity * 1.0  > 0))" true-value="Y" false-value="N" />
                            </div>
                            Quantity enabling may be complex. Disable for now.
                            <div class="col-4" v-if=" inv.Infinite === 'N'">
                                <label class="form-label small"   v-bind:for="'quantity' + i"  >Available</label>
                                <input v-bind:key="'quantity' + i"  v-bind:id="'quantity' + i"  class="form-control" placeholder="Quantity"
                                v-model="inv.Quantity"  disabled="disabled"/>
                            </div>
                            <div class="col-5" v-if="current.index === i && inv.Infinite === 'N' ">
                                <label class="form-label small"   v-bind:for="'quantity' + i"  >Adjust +/- </label>
                                <input v-bind:key="'adjustquantity' + i"  v-bind:id="'adjustquantity' + i"  class="form-control" title="Adjustment Quantity"
                                v-model="current.AdjustmentQuantity"  />
                            </div>
                        </div>
                        -->
                    <div class="text-right">
                        <a href="#/" class="btn btn-sm btn-light mr-2" role="button" v-on:click="cancel($event)">
                            Cancel
                        </a>
                        <a href="#/" class="btn btn-sm btn-primary" role="button" v-on:click="save($event)">
                            Save
                        </a>
                    </div>
                </div>
                <div class="pop-overlay" v-if="current.index === i"></div>
            </div>
        </div>
    </div>

</div>
<div>