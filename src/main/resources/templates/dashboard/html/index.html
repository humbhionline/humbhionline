<script type="text/javascript" src="/resources/scripts/node_modules/lockr/lockr.min.js" defer></script>
<script type="text/javascript" src="/resources/scripts/node_modules/axios/dist/axios.min.js" defer></script>
<script type="text/javascript" src="/resources/scripts/node_modules/vue/dist/vue.js" defer></script>
<script type="text/javascript" src="/resources/scripts/swf/js/entity_helper.js" defer></script>
<script type="text/javascript" src="/fragments/js/util.js"></script>
<link rel="preload" as="style" href="/fragments/css/mandi.css" onload="this.onload=null;this.rel='stylesheet'">



<script type="text/javascript">
    $(function () {
        var params = (new URL(window.location)).searchParams;
        var term = params.get("search");
        var facility_id = params.get("facility_id");
        var order_id = params.get("order_id");
        var clone_order_id = params.get("clone_order_id");

        let PreferredMaxDistance = Lockr.get("PreferredMaxDistance");
        if (!PreferredMaxDistance) {
            Lockr.set("PreferredMaxDistance", 10);
        }

        new Vue({
            el: "#app",
            data: {
                Mobile: isMobile(),
                User: {},
                sendSubscriptionToServer: sendSubscriptionToServer,
                ShipmentCount: 0,
                OrderLineCount: 0,
                OrderAmount: 0,
                DeliveryAmount: 0,
                itemWidth: 0,
                blank: blank,
                search: {
                    MaxDistance: Lockr.get("PreferredMaxDistance") || 10,
                    facility_id: facility_id,
                    order_id: order_id,
                    clone_order_id: clone_order_id,
                    Facility: {},
                    Order: {},
                    term: term || "",
                    results: [],
                    termLengthTrigger: 1,
                    timer: undefined,
                },
                hideNewDelivery: true,
                delivery: null,
                lookup: {
                    Cities: [],
                    PinCodes: [],
                    lookupselectionIndex: -1,
                },
                facilityOrders: Lockr.get("facilityOrders") || {},
            },
            created: function () {
                let self = this;
                showSpinner();

                api().url("/users/current").get().then(function (response) {
                    self.User = response.User;
                    self.initDeliveryAddress();
                    if (!self.User.UserPhones) {
                        self.User.UserPhones = [];
                    }
                    Lockr.set("User", self.User);
                    let guest = !self.User.Name;
                    let validated = guest || self.User.Id == 1 || self.User.UserPhones.length > 0;
                    if (!guest) {
                        if (self.User.SignUps && self.User.SignUps.length > 0) {
                            Lockr.set("SignUp", self.User.SignUps[0]);
                        }
                        subscribe(sendSubscriptionToServer); //Do Subscription only after setting User.
                        if (self.User.TermsAccepted !== 'Y') {
                            window.location.replace("/dashboard/html/terms");
                            return;
                        }
                        if (self.User.PasswordSet !== 'Y') {
                            window.location.href = ("/users/html/profile");
                            return;
                        }
                        if (validated) {
                            self.User.UserPhones.forEach((item, i) => {
                                if (item.Validated === 'N') {
                                    validated = false;
                                }
                            });
                        }
                    }


                    if (!validated) {
                        window.location.href = ("/users/html/profile");
                    } else {
                        self.loadFacility().then(function (f) {
                            self.search.Facility = f;
                            if (f.Id) {
                                self.search.termLengthTrigger = 0;
                            }
                            self.loadOrder().then(function (o) {
                                if (o.Id && isOpenOrder(o)) {
                                    self.search.Order = o;
                                } else {
                                    self.search.Order = {};
                                    self.search.order_id = undefined;
                                }
                                if (self.search.Order.Id) {
                                    self.search.termLengthTrigger = 0;
                                }
                                self.loadHistoryOrder().then(function (ho) {
                                    if (ho.Id) {
                                        var qtyHash = {};
                                        var query = "(FACILITY_ID:" + ho.Facility.Id + " AND ( SKU_ID:"
                                        ho.OrderLines.forEach((ol, i) => {
                                            query += ol.Sku.Id + " OR SKU_ID:";
                                            qtyHash[ol.Sku.Id] = ol.OrderedQuantity * 1.0;
                                        });
                                        query += "0))";
                                        let q = { "q": query };
                                        return api().url("/network/call/inventories/search").get(q).then(function (response) {
                                            response.Inventories.forEach((inventory, inventoryIndex) => {
                                                var result = {};
                                                result = inventory;
                                                result.OrderedQuantity = qtyHash[result.Sku.Id];
                                                self.addToCart(null, result);
                                            });
                                            if (response.Inventories.length > 0) {
                                                self.buy(null);
                                            }
                                        });
                                    }
                                }).then(function () {
                                    self.find(null);
                                    self.showApp();

                                });
                            });
                        });
                    }
                });

                hideSpinner();
            },
            methods: {
                initDeliveryAddress: function () {
                    let self = this;
                    self.delivery = Lockr.get("delivery");
                    if (!self.delivery) {
                        self.delivery = {
                            Address: {},
                            beingEdited: false,
                            DraftAddress: {},
                        };
                        copyAddress(self.User, self.delivery.Address); //There in util.js
                    }
                },
                isAddressChanged: function (from, to) {
                    return !(to.AddressLine1 == from.AddressLine1 &&
                        to.AddressLine2 == from.AddressLine2 &&
                        to.AddressLine3 == from.AddressLine3 &&
                        to.AddressLine4 == from.AddressLine4 &&
                        to.City.Name == from.City.Name &&
                        to.City.State.Name == from.City.State.Name &&
                        to.City.State.Country.Name == from.City.State.Country.Name &&
                        to.PinCode.PinCode == from.PinCode.PinCode &&
                        to.PhoneNumber == from.PhoneNumber &&
                        to.Email == from.Email)
                },
                reloadCounts: function () {
                    let self = this;

                    var obj = self.facilityOrders;
                    self.ShipmentCount = 0;
                    self.OrderLineCount = 0;
                    self.OrderAmount = 0;
                    self.DeliveryAmount = 0;

                    for (key in obj) {
                        if (obj.hasOwnProperty(key)) {
                            self.ShipmentCount += 1;
                            self.OrderLineCount += obj[key].OrderLines.length;
                            var facility = null;
                            var deliveryAmount = null; //It is only charged once per order.!!
                            obj[key].OrderLines.forEach((ol, i) => {
                                self.OrderAmount += ol.OrderedQuantity * ol.Inventory.SellingPrice
                                if (!facility) {
                                    facility = ol.Inventory.Facility;
                                }
                                if (!deliveryAmount && ol.Inventory.DeliveryProvided === 'Y') {
                                    deliveryAmount = ol.Inventory.DeliveryCharges
                                }
                            });
                            if (obj[key].OrderLines.length === 0) {
                                delete obj[key];
                            }

                            if (deliveryAmount && (!obj[key].CustomerPickup || obj[key].CustomerPickup !== 'Y')) {
                                self.DeliveryAmount += deliveryAmount * 1.0;
                            }
                        }
                    }

                    updateHeaderCount();
                },
                loadOrder: function () {
                    let self = this;
                    return new Promise(function (resolve, reject) {
                        if (self.search.order_id && self.search.order_id * 1.0 > 0) {
                            showSpinner();
                            api().url("orders/show/" + self.search.order_id).get().then(function (response) {
                                resolve(response.Order);
                            }).catch(function (err) {
                                reject(err);
                            }).finally(function () {
                                hideSpinner();
                            });
                        } else {
                            resolve({});
                        }
                    });
                },
                loadHistoryOrder: function () {
                    let self = this;
                    return new Promise(function (resolve, reject) {
                        if (self.search.clone_order_id && self.search.clone_order_id * 1.0 > 0) {
                            showSpinner();
                            api().url("orders/show/" + self.search.clone_order_id).get().then(function (response) {
                                resolve(response.Order);
                            }).catch(function (err) {
                                reject(err);
                            }).finally(function () {
                                hideSpinner();
                            });
                        } else {
                            resolve({});
                        }
                    });
                },
                loadFacility: function () {
                    let self = this;
                    return new Promise(function (resolve, reject) {
                        if (self.search.facility_id && self.search.facility_id * 1.0 > 0) {
                            showSpinner();
                            api().url("facilities/show/" + self.search.facility_id).get().then(function (response) {
                                resolve(response.Facility);
                            }).catch(function (err) {
                                reject(err);
                            }).finally(function () {
                                hideSpinner();
                            });
                        } else {
                            resolve({});
                        }
                    });
                },
                showApp: function () {
                    let self = this;
                    $("#header").load("/fragments/html/header", {}, function () {
                        fixMenu();
                        $("#pageTitle").html("HumBhiOnline");
                        window.innerWidth < 640
                            && $(".body").css("padding-top", "148px");
                        $("#root").show();
                        $("#search").focus();
                        self.reloadCounts();
                        if (self.OrderLineCount > 0 && Lockr.get("signup-triggered")) {
                            self.buy(null);
                        }
                    });
                },
                headers: function () {
                    let location = Lockr.get("Location");
                    if (location && location.latitude && location.longitude) {
                        return { Lat: location.latitude, Lng: location.longitude };
                    } else {
                        return {};
                    }
                },
                isSearchTriggerable: function (length = this.search.termLengthTrigger) {
                    let self = this;
                    return self.search.term.length >= length;
                },
                find: function (e) {
                    let self = this;
                    if (e) {
                        e.preventDefault();
                        self.search.term = e.target.value;
                    }
                    self.search.results = [];
                    if (self.search.timer) {
                        clearTimeout(self.search.timer);
                        self.search.timer = undefined;
                    }
                    if (!self.isSearchTriggerable()) {
                        return;
                    }
                    self.search.timer = setTimeout(function () {
                        self._find();
                        self.search.timer = undefined;
                    }, 400);
                },
                _find: function () {
                    let self = this;
                    let search_term = self.search.term.replace(/[^a-zA-Z0-9 ]/g, " ").trim();
                    let term = search_term;
                    if (self.search.facility_id && self.search.facility_id * 1.0 > 0) {
                        term = "(FACILITY_ID:" + self.search.facility_id + (term.length > 0 ? " AND ( SKU:" + term + "* OR TAG:" + term + "* )" : "") + ")";
                    }
                    var params = {};
                    params.MaxDistance = self.search.MaxDistance;

                    if (self.search.Order.Id && self.search.Order.Id * 1.0 > 0) {
                        params.OrderId = self.search.Order.Id;
                    }
                    showSpinner();
                    api().url("/network/call/inventories/search/" + term).get(params).then(function (response) {
                        if (self.search.term.replace(/[^a-zA-Z0-9 ]/g, " ").trim() != search_term) {
                            return;
                        }
                        if (!response) {
                            return
                        }
                        self.search.results = response.Inventories.sort(function (o1, o2) {
                            return o1.Facility.Distance - o2.Facility.Distance;
                        });
                        if (self.search.results.length === 0) {
                            return;
                        }
                        self.itemWidth = $("#item-0").width();
                        self.search.results.forEach((result, i) => {
                            var order = self.facilityOrders[result.Facility.Id];
                            result.OrderedQuantity = 0;
                            result.OrderedAmount = (0.00).toFixed(2);
                            if (order) {
                                if (order.CustomerPickup === 'Y') {
                                    result.DeliveryProvided = 'N';
                                }
                                order.OrderLines.forEach((orderLine, i) => {
                                    if ( (orderLine.Inventory.Sku.Id === result.Sku.Id)  
                                        && (orderLine.Inventory.Tags === result.Tags )
                                        && orderLine.Inventory.Facility.Id === result.Facility.Id) {
                                        result.OrderedQuantity = orderLine.OrderedQuantity
                                        result.OrderedAmount = (result.OrderedQuantity * result.SellingPrice * 100 / 100).toFixed(2);
                                    }
                                });
                            }
                        });

                    }).finally(function () {
                        hideSpinner();
                    });
                },
                onQtyChange: function (event, index) {
                    let self = this;
                    let result = self.search.results[index];
                    result.OrderedQuantity = Math.max(0, result.OrderedQuantity);
                    Vue.set(self.search.results, index, result);
                    self.addToCart(event, result);
                },
                reduce: function (event, index) {
                    let self = this;
                    let result = self.search.results[index];
                    result.OrderedQuantity -= (!self.isDeliverySku(result.Sku) ? 1.0 : Math.max(result.ChargeableDistance * 1.0 - result.Facility.MinChargeableDistance * 1.0, 0.001));
                    result.OrderedQuantity = Math.max(0, result.OrderedQuantity);
                    result.OrderedAmount = (result.OrderedQuantity * result.SellingPrice * 100 / 100).toFixed(2);
                    Vue.set(self.search.results, index, result);
                    self.addToCart(event, result);
                },
                isDeliverySku: function (sku) {
                    return sku.Item.AssetCode && sku.Item.AssetCode.Code.startsWith("99681");
                },
                increase: function (event, index) {
                    if (event) {
                        event.preventDefault();
                    }
                    let self = this;
                    let result = self.search.results[index];

                    if (!result.OrderedQuantity) {
                        result.OrderedQuantity = 0.0;
                    }
                    if (self.isDeliverySku(result.Sku) && result.OrderedQuantity * 1.0 > 0) {
                        return;
                    }
                    result.OrderedQuantity += (!self.isDeliverySku(result.Sku) ? 1.0 : Math.max(result.ChargeableDistance * 1.0 - result.Facility.MinChargeableDistance * 1.0, 0.00001));
                    result.OrderedAmount = (result.OrderedQuantity * result.SellingPrice * 100 / 100).toFixed(2);
                    Vue.set(self.search.results, index, result);
                    self.addToCart(event, result);
                },
                addToCart: function (event, result) {
                    if (event) {
                        event.preventDefault();
                    }
                    let self = this;
                    if (!self.facilityOrders[result.Facility.Id]) {
                        self.facilityOrders[result.Facility.Id] = {
                            OrderLines: [],
                            OrderAddresses: []
                        };
                        Vue.set(self.facilityOrders, result.Facility.Id, self.facilityOrders[result.Facility.Id]);
                    }
                    var order = self.facilityOrders[result.Facility.Id];
                    if (order) {
                        let index = order.OrderLines.findIndex(function (ol) {
                            return ol.Inventory.Sku.Id === result.Sku.Id && 
                            ol.Inventory.Tags === result.Tags &&
                            ol.Inventory.Facility.Id === result.Facility.Id;
                        });
                        let ol = {
                            Inventory: result,
                            OrderedQuantity: result.OrderedQuantity
                        };
                        if (index < 0) {
                            if (ol.OrderedQuantity * 1 > 0) {
                                order.OrderLines.push(ol);
                            }
                        } else {
                            if (ol.OrderedQuantity * 1 > 0) {
                                order.OrderLines.splice(index, 1, ol);
                            } else {
                                order.OrderLines.splice(index, 1);
                            }
                        }
                        if (self.search.Order.Id) {
                            order.RefOrder = { Id: self.search.Order.Id };
                            order.CustomerPickup = 'N';
                        } else {
                            order.CustomerPickup = order.CustomerPickup || (ol.Inventory.DeliveryProvided === 'N' ? 'Y' : 'N');
                        }
                    }
                    if (event) {
                        self.reloadCounts();
                    }
                    Lockr.set("facilityOrders", self.facilityOrders);
                },
                setPreferredDistance: function (distance) {
                    let oldValue = Lockr.get("PreferredMaxDistance");
                    if (oldValue != distance) {
                        Lockr.set("PreferredMaxDistance", distance);
                        this.find(null);
                    }
                },
                buy: function (event) {
                    event && event.preventDefault();
                    window.location.href = ("/buy");
                },
                whatsapp_url: function (f) {

                    var url = "";
                    let self = this;
                    if (isMobile()) {
                        url += 'whatsapp://send';
                    } else {
                        url += 'https://web.whatsapp.com/send'
                    }
                    url += '?phone=' + f.PhoneNumber;
                    return url;
                },
                /* Delivery Address Setting code */
                selectDeliveryAddress(ev, address, index) {
                    ev && ev.preventDefault();
                    let self = this;
                    copyAddress(address, self.delivery.Address);
                    self.editDeliveryAddress(ev);
                }
                /* Delivery Address Setting code */
                , setNewDeliveryAddress(ev, status) {
                    ev && ev.preventDefault();
                    let self = this;
                    let address = {
                        "AddressLine1": null,
                        "AddressLine2": null,
                        "City": {
                            "Name": null,
                            "State": {
                                "Country": {
                                    "Id": "1",
                                    "IsoCode": "IND",
                                    "Name": "India"
                                },
                                "Name": null
                            }
                        },
                        "LongName": null,
                        "PinCode": {
                            "PinCode": null
                        },
                        "Email": null
                    }
                    copyAddress(address, self.delivery.Address);
                    self.hideNewDelivery = status
                    self.editDeliveryAddress(ev);
                }
                , editDeliveryAddress: function (ev) {
                    ev && ev.preventDefault();
                    let self = this;
                    //Show address popup for data entry
                    //Show saved addresses for selection.
                    self.delivery.beingEdited = true;
                    self.delivery.DraftAddress = JSON.parse(JSON.stringify(self.delivery.Address));
                },
                cancelEditDeliveryAddress: function (ev) {
                    ev && ev.preventDefault();
                    let self = this;
                    self.delivery.beingEdited = false;
                    self.delivery.DraftAddress = {};
                },
                updateDeliveryLocation: function (address) {
                    let location = Lockr.get("Location");
                    if (!location) {
                        location = { latitude: address.Lat, longitude: address.Lng };
                    } else {
                        location.latitude = address.Lat;
                        location.longitude = address.Lng;
                    }
                    Lockr.set("Location", location);
                },
                saveDeliveryAddress: function (ev) {
                    ev && ev.preventDefault();
                    let self = this;
                    self.delivery.beingEdited = false;

                    if (self.isAddressChanged(self.delivery.Address, self.delivery.DraftAddress)) {
                        showSpinner();
                        api().url("/delivery_addresses/locate").parameters({ "DeliveryAddress": self.delivery.DraftAddress }).post().then(function (response) {
                            Vue.set(self.delivery, "Address", response.DeliveryAddresses[0]);
                            Lockr.set("delivery", self.delivery);
                            self.updateDeliveryLocation(self.delivery.Address);
                        }).catch(function (err) {
                            showError(err);

                        }).finally(function () {
                            self.delivery.DraftAddress = {};
                            hideSpinner();
                        })
                    } else {
                        self.delivery.Address = self.delivery.DraftAddress;
                        self.delivery.DraftAddress = {};
                        self.updateDeliveryLocation(self.delivery.Address);
                    }
                },
                isKeyTriggerable: function (e) {
                    return (e && e.target.value.length > 1);
                },
                onCityChange: function (e) {
                    e && e.preventDefault();
                    if (!this.isKeyTriggerable(e)) {
                        return;
                    }
                    let self = this;
                    new Autocomplete("cities", e.target).search().then(function (response) {
                        if (!response) {
                            return
                        }
                        self.lookup.Cities = response.Cities;
                        self.loadLookupEntries(e.target);
                        Vue.set(self.lookup, "Cities", self.lookup.Cities);
                    });
                },
                onCitySelect: function (e, item) {
                    e && e.preventDefault();
                    let self = this;
                    self.hideKeyboard().then(function () {
                        self.delivery.DraftAddress.City = item;
                        self.delivery.DraftAddress.State = item.State;
                        self.delivery.DraftAddress.Country = item.State.Country;
                        self.lookup.Cities = [];
                    });
                },
                onPinCodeChange: function (e) {
                    e && e.preventDefault();
                    if (!this.isKeyTriggerable(e)) {
                        return;
                    }

                    let self = this;
                    new Autocomplete("pin_codes", e.target).search("PIN_CODE").then(function (response) {
                        if (!response) {
                            return
                        }
                        self.lookup.PinCodes = response.PinCodes;
                        self.loadLookupEntries(e.target);
                    });
                },
                onPinCodeSelect: function (e, item) {
                    e && e.preventDefault();
                    let self = this;
                    self.hideKeyboard().then(function () {
                        self.delivery.DraftAddress.PinCode = item;
                        if (self.delivery.DraftAddress.PinCode.City && self.delivery.DraftAddress.PinCode.City.Id) {
                            self.delivery.DraftAddress.City = self.delivery.DraftAddress.PinCode.City;
                        }
                        self.lookup.PinCodes = [];
                    });
                },
                getParentDiv: function (element) {
                    var div = element;
                    while (div && div.tagName !== 'DIV') {
                        div = div.parentElement;
                    }
                    return div;
                },
                loadLookupEntries: function (element) {
                    var div = this.getParentDiv(element);
                    if (div) {
                        div.appendChild(this.$refs['lookupEntries']);
                    }
                },

                navigate: function (e, index, length) {
                    e && e.preventDefault();
                    let self = this;
                    this.lookup.lookupselectionIndex = (index % length);
                    let anchors = this.$refs['lookupEntries'].getElementsByTagName("a");
                    anchors[this.lookup.lookupselectionIndex].focus();
                },
                removeList: function (e) {
                    let elem = e.target;
                    let self = this;
                    self.hideKeyboard().then(function () {
                        self.lookup.Cities = [];
                        self.lookup.PinCodes = [];
                        $(".lookups-list").removeClass("offsetTop");
                    });
                },
                hideKeyboard: function () {
                    return new Promise(function (resolve, reject) {
                        //let dummy = $("#dummy");
                        let dummy = $(document.documentElement);
                        setTimeout(function () {
                            dummy.focus();
                            setTimeout(function () {
                                resolve();
                            }, 50);
                        }, 50);
                    });
                },
            }
        });
    });
</script>
<div id="root" style="display:none;">
    <div id="header">
    </div>
    <div id="app" class="app-body">
        <div class="container" v-if="search.facility_id && search.Facility.Name">
            <div id="banner-slider" class="carousel slide" data-ride="carousel">
                <!-- Indicators -->
                <ul class="carousel-indicators">
                    <li data-target="#banner-slider" v-bind:data-slide-to="index"
                        v-bind:class="index == 0 ? 'active' : '' "
                        v-for="(attachment,index) in search.Facility.Attachments">
                    </li>
                </ul>
                <!-- The slideshow -->
                <div class="carousel-inner">
                    <div v-bind:class="'justify-content-center carousel-item ' + (index == 0 ? 'active' : '') "
                        v-for="(attachment,index) in search.Facility.Attachments">
                        <img v-bind:src="'/network/call'+attachment.AttachmentUrl"></img>
                    </div>
                </div>

                <!-- Left and right controls -->
                <a class="carousel-control-prev" href="#banner-slider" data-slide="prev">
                    <span class="carousel-control-prev-icon"></span>
                </a>
                <a class="carousel-control-next" href="#banner-slider" data-slide="next">
                    <span class="carousel-control-next-icon"></span>
                </a>
            </div>
            <div class="row">
                <div class="col-12 item-list">
                    <h6 class="mb-0">{{search.Facility.Name}}</h6>
                    <p class="m-0 text-muted">
                        {{search.Facility.AddressLine1}}, {{search.Facility.AddressLine2}},
                        {{search.Facility.City.Name}}, {{search.Facility.State.Name}}
                        {{search.Facility.PinCode.PinCode}}, <a
                            v-bind:href="'tel:'+ search.Facility.PhoneNumber">{{search.Facility.PhoneNumber}}</a>
                    </p>
                    <div class="row">
                        <div class="col">
                            <!-- <a class="btn btn-link" v-bind:href="'tel:'+ search.Facility.PhoneNumber"
                    v-if="Mobile && search.Facility.PhoneNumber">
                    <i class="fa-phone-alt fas"></i>
                </a> -->
                            <a v-bind:href="whatsapp_url(search.Facility)" data-action="share/whatsapp/share"
                                class="btn btn-link px-1" v-if="search.Facility.PhoneNumber">
                                <i class="fab fa-whatsapp"></i>
                            </a>
                        </div>
                        <div class="col d-flex justify-content-end align-items-center">
                            <small>@ Distance of {{search.Facility.Distance}} Km</small>
                        </div>
                    </div>
                    <!-- {{search.Facility.Lat +","+ search.Facility.Lng}} -->
                </div>
            </div>
        </div>
        <div class="container">
            <div id="search-holder" class="form-row search-holder mb-sm-6">
                <div class="col-12 d-flex flex-row align-items-center mt-3" v-if="delivery && delivery.Address">
                    <a @click="editDeliveryAddress($event)">
                        <i class="h6 fa fa-map-marker-alt mr-1"></i>
                        {{ delivery.Address.LongName ? "Deliver to " + delivery.Address.LongName +"-" +
                        delivery.Address.PinCode.PinCode : "Where are you?" }}</a>
                </div>
                <div class="col-12">
                    <div class="d-flex flex-row align-items-center">
                        <input key="search" id="search" class="search-control" placeholder="Search for Items or Store"
                            v-on:input="find($event)" v-model="search.term" />
                        <i class="fa fa-search"></i>
                    </div>
                    <div class="form-check-inline align-middle mr-1">
                        <input class="form-check-input mb-0" type="radio" v-model="search.MaxDistance"
                            name="MaxDistance" id="distance_filter_5" value="5" @change="setPreferredDistance(5)">
                        <label class="form-check-label small" for="distance_filter_5">0 - 5</label>
                    </div>
                    <div class="form-check-inline align-middle mr-1">
                        <input class="form-check-input mb-0" type="radio" v-model="search.MaxDistance"
                            name="MaxDistance" id="distance_filter_10" value="10" @change="setPreferredDistance(10)">
                        <label class="form-check-label small" for="distance_filter_10">0 - 10</label>
                    </div>
                    <div class="form-check-inline align-middle mr-1">
                        <input class="form-check-input mb-0" type="radio" v-model="search.MaxDistance"
                            name="MaxDistance" id="distance_filter_10000" value="10000"
                            @change="setPreferredDistance(10000)">
                        <label class="form-check-label small" for="distance_filter_10000">>10</label>
                    </div>
                </div>
            </div>
            <div class="row mt-sm-3">
                <div class="col-lg-3 col-sm-4 mb-0 mb-sm-4" v-for="(result,index) in search.results"
                    v-if="search.results.length > 0">
                    <div class="item-list" v-bind:id="'item-'+index">
                        <div class="form-row">
                            <div class="col-4 col-sm-12">
                                <div class="img-holder border rounded-sm">
                                    <img class="img-fluid w-100 h-100"
                                        v-bind:src="'/network/call'+result.Sku.Attachments[0].AttachmentUrl"
                                        v-if="result.Sku.Attachments && result.Sku.Attachments.length > 0"
                                        data-toggle="modal" v-bind:data-target="'#sku-img-'+result.Sku.Id" />
                                    <div v-else
                                        class="default-img d-flex bg-light align-items-center justify-content-center"
                                        v-bind:style="{ height: itemWidth + 'px' }">
                                        <span class="font-weight-bold text-muted">{{result.Sku.Item.Name}}</span>
                                    </div>
                                    <!-- Modal View Images -->
                                    <div v-if="result.Sku.Attachments && result.Sku.Attachments.length > 0"
                                        class="modal fade" v-bind:id="'sku-img-'+result.Sku.Id" tabindex="-1"
                                        aria-labelledby="exampleModalLabel" aria-hidden="true">
                                        <div class="modal-dialog">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <h5 class="modal-title" id="exampleModalLabel">
                                                        {{result.Sku.Name}}
                                                    </h5>
                                                    <button type="button" class="close" data-dismiss="modal"
                                                        aria-label="Close">
                                                        <span aria-hidden="true">&times;</span>
                                                    </button>
                                                </div>
                                                <div class="modal-body">
                                                    <img class="img-fluid w-100 h-100"
                                                        v-if="result.Sku.Attachments && result.Sku.Attachments.length > 0"
                                                        v-bind:src="'/network/call' + result.Sku.Attachments[0].AttachmentUrl" />
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col pb-4 pb-sm-0">
                                <h6 class="m-0 text-truncate" v-bind:title="result.Sku.Name">
                                    {{ result.Sku.Name }} 
                                </h6>
                                <span class="small text-muted">{{ result.Tags }}</span>
                                <!-- <p class="mb-0 small">{{result.Tags}}</p> -->
                                <p class="mb-1 small text-muted text-truncate" v-bind:title="result.Facility.Name">
                                    By: <a
                                        v-bind:href="'/dashboard?facility_id=' +result.Facility.Id">{{result.Facility.Name}}</a>
                                </p>
                                <div class="form-row">
                                    <div class="col small">
                                        <a
                                            v-bind:href="'https://google.com/maps/place/'+result.Facility.Lat +',' + result.Facility.Lng">
                                            <i class="fa fa-map-pin mr-1 text-muted"></i>
                                            {{result.Facility.Distance}} Km
                                        </a>
                                    </div>
                                    <div class="col d-none d-sm-block small text-right">
                                        <del v-if="result.Facility.CodEnabled !== 'Y'">COD</del>
                                        <del v-if="result.DeliveryProvided !== 'Y'">Delivery</del>
                                        <span v-if="result.DeliveryProvided === 'Y' && !isDeliverySku(result.Sku) &&
                                                ( !result.DeliveryCharges || result.DeliveryCharges * 1.0 === 0 )">
                                            Delivery - Free
                                        </span>
                                        <span
                                            v-else-if="result.DeliveryProvided === 'Y' && result.DeliveryCharges && result.DeliveryCharges * 1.0 > 0"
                                            class="text-muted">
                                            {{ (isDeliverySku(result.Sku) ? "Fixed Charges" :
                                            "Delivery") }} - &#x20B9;
                                            {{
                                            result.DeliveryCharges }}
                                        </span>
                                    </div>
                                </div>
                                <p class="price-box d-block d-sm-none">
                                    <strike v-if="result.MaxRetailPrice * 1.0 > result.SellingPrice">
                                        &#x20B9; {{result.MaxRetailPrice}}
                                    </strike>
                                    <span v-if="result.SellingPrice * 1.0 > 0.0">&#x20B9; {{result.SellingPrice}}</span>
                                </p>
                            </div>
                        </div>
                        <hr class="my-2 d-block d-sm-none" />
                        <div class="form-row mt-sm-3">
                            <div class="col-4 col-sm-4 order-sm-last">
                                <div class="btn-group" role="group" aria-label="Basic example"
                                    v-if="!isDeliverySku(result.Sku)">
                                    <button type="button" class="btn btn-sm btn-outline-primary border-right-0 m-0"
                                        v-on:click="reduce($event,index)">
                                        <i class="fa fa-minus"></i>
                                    </button>
                                    <input v-bind:key="'quantity' + index" v-bind:id="'quantity' + index"
                                        class="btn btn-sm btn-outline-primary w-100 border-left-0 border-right-0 m-0"
                                        placeholder="Quantity" v-model="result.OrderedQuantity"
                                        @change="onQtyChange($event,index)" />
                                    <button type="button" class="btn btn-sm btn-outline-primary border-left-0"
                                        v-on:click="increase($event,index)">
                                        <i class="fa fa-plus"></i>
                                    </button>
                                </div>
                                <div class="btn-group" role="group" aria-label="Basic example" v-else>
                                    <a href="#" class="btn btn-sm btn-outline-primary"
                                        v-if="(result.OrderedQuantity * 1.0 > 0)" v-on:click="reduce($event,index)">
                                        <i class="fas fa-toggle-on"></i>
                                    </a>
                                    <a href="#" class="btn btn-sm btn-outline-primary"
                                        v-if="(result.OrderedQuantity * 1.0 <= 0)" v-on:click="increase($event,index)">
                                        <i class="fas fa-toggle-off"></i>
                                    </a>
                                </div>
                            </div>
                            <div
                                class="col text-right text-sm-left d-flex align-items-center justify-content-end justify-content-sm-start">
                                <h6 class="d-none d-sm-block desk-price">
                                    <strike v-if="result.MaxRetailPrice * 1.0 > result.SellingPrice">
                                        &#x20B9; {{result.MaxRetailPrice}}
                                    </strike>
                                    <span>&#x20B9;</span>
                                    {{result.SellingPrice.split(".")[0]}}<span>.{{result.SellingPrice.split(".")[1]}}</span>
                                </h6>
                                <small class="d-inline-block d-sm-none">
                                    <del v-if="result.Facility.CodEnabled !== 'Y'">COD</del>
                                    <del v-if="result.DeliveryProvided !== 'Y'">Delivery</del>
                                    <span v-if="result.DeliveryProvided === 'Y' && !isDeliverySku(result.Sku) &&
                                            ( !result.DeliveryCharges || result.DeliveryCharges * 1.0 === 0 )">
                                        Delivery - Free
                                    </span>
                                    <span
                                        v-else-if="result.DeliveryProvided === 'Y' && result.DeliveryCharges && result.DeliveryCharges * 1.0 > 0"
                                        class="text-muted">
                                        {{ (isDeliverySku(result.Sku) ? "Fixed Charges" : "Delivery") }}
                                        - &#x20B9; {{
                                        result.DeliveryCharges }}
                                    </span>
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div style="height: 65px;" v-if="OrderLineCount > 0"></div>
        <div class="bottom-card" v-if="OrderLineCount > 0">
            <div class="form-row">
                <div class="col-8">
                    <h6 class="m-0" v-if="OrderAmount * 1.0 > 0">{{OrderLineCount}} Items | &#x20B9; {{(OrderAmount *
                        1.0).toFixed(2)}}</h6>
                    <small class="m-0 text-muted" v-if="DeliveryAmount * 1.0 > 0">Fixed/Delivery charges &#x20B9;
                        {{(DeliveryAmount *1.0).toFixed(2)}}</small>
                </div>
                <div class="col d-flex align-items-center">
                    <a class="btn btn-primary btn-sm btn-block" href="#" @click="buy($event)">CHECKOUT</a>
                </div>
            </div>
        </div>
        <!-- Address choosing -->
        <div class="show-update delivery-address" v-if="delivery && delivery.beingEdited">
            <div class="form-row">
                <div class="col-12">
                    <h6>Deliver To <a v-bind:hidden="!hideNewDelivery" class="float-right"
                            @click="setNewDeliveryAddress($event,false)">Add New
                            Address</a> <a v-bind:hidden="hideNewDelivery" class="float-right"
                            @click="setNewDeliveryAddress($event,true)">Choose
                            Address</a></h6>
                </div>
                <div class="col-12" v-bind:hidden="!hideNewDelivery">
                    <div class="address-wrapper">
                        <div v-for="(address,index) in User.SavedAddresses"
                            @click="selectDeliveryAddress($event, address,index)" class="address-block" :class="[
                            delivery.DraftAddress.Email == address.Email ? 'active' : '',
                          ]">
                            <h6>{{address.LongName}}</h6>
                            <div class="address-block-text">
                                {{address.AddressLine1}}
                                {{(blank(address.AddressLine2)? "" : "," )}}
                                {{address.AddressLine2}}
                                {{(blank(address.AddressLine3)? "" : "," )}}
                                {{address.AddressLine3}}
                                {{(blank(address.AddressLine4)? "" : "," )}}
                                {{address.AddressLine4}}
                            </div>
                            {{address.City.Name}}-{{address.State.Name}},
                            {{address.PinCode.PinCode}}
                        </div>
                    </div>
                </div>
                <div class="form-row" v-bind:hidden="hideNewDelivery">
                    <div class="col-12 mb-2">
                        <input class="form-control form-control-sm" id="name" v-model="delivery.DraftAddress.LongName"
                            placeholder="Full Name" />
                    </div>
                    <div class="col-6 mb-2">
                        <input class="form-control form-control-sm" id="a1" v-model="delivery.DraftAddress.AddressLine1"
                            placeholder="House Number" />
                    </div>
                    <div class="col-6 mb-2">
                        <input class="form-control form-control-sm" id="a2" v-model="delivery.DraftAddress.AddressLine2"
                            placeholder="Building Name" />
                    </div>
                    <div class="col-6 mb-2">
                        <input class="form-control form-control-sm" id="a3" v-model="delivery.DraftAddress.AddressLine3"
                            placeholder="Locality" />
                    </div>
                    <div class="col-6 mb-2">
                        <input class="form-control form-control-sm" id="a4" v-model="delivery.DraftAddress.AddressLine4"
                            placeholder="Locality" />
                    </div>
                    <div class="col-6 mb-2">
                        <input id="city" class="form-control form-control-sm" placeholder="City Name"
                            v-model="delivery.DraftAddress.City.Name" v-on:input="onCityChange($event)"
                            v-on:focus="removeList($event)" v-on:keyup.down="navigate($event,0,lookup.Cities.length)"
                            v-if="delivery.DraftAddress.City" />
                    </div>
                    <div class="col-6 mb-2">
                        <input id="pincode" class="form-control form-control-sm" placeholder="Pin Code"
                            v-model="delivery.DraftAddress.PinCode.PinCode" v-on:input="onPinCodeChange($event)"
                            v-on:focus="removeList($event)" v-on:keyup.down="navigate($event,0,lookup.PinCodes.length)"
                            v-if="delivery.DraftAddress.PinCode" />
                    </div>
                    <div class="col-6 mb-2">
                        <input id="phone" class="form-control form-control-sm" placeholder="PhoneNumber"
                            v-model="delivery.DraftAddress.PhoneNumber" />
                    </div>
                    <div class="col-6 mb-2">
                        <input id="email" class="form-control form-control-sm" placeholder="Email"
                            v-model="delivery.DraftAddress.Email" />
                    </div>
                </div>


                <div class="col-12 text-right">
                    <a href="#/" class="btn btn-sm btn-light mr-2" @click="cancelEditDeliveryAddress($event)">Cancel</a>
                    <a href="#/" class="btn btn-sm btn-primary" @click="saveDeliveryAddress($event)">Submit</a>
                </div>
            </div>
            <div id="lookupEntries" ref="lookupEntries" class="lookups-list">
                <a href="#" class="text-truncate" v-for="(city,index) in lookup.Cities" v-if="lookup.Cities.length > 0"
                    v-on:click="onCitySelect($event,city)" v-on:keyup.enter="onCitySelect($event,city)"
                    v-on:keyup.space="onCitySelect($event,city)"
                    v-on:keyup.up="navigate($event,index-1,lookup.Cities.length)"
                    v-on:keyup.down="navigate($event,index+1,lookup.Cities.length)">{{city.Name}} -
                    {{city.State.Name}}</a>
                <a href="#" class="text-truncate" v-for="(pincode,index) in lookup.PinCodes"
                    v-if="lookup.PinCodes.length > 0" v-on:click="onPinCodeSelect($event,pincode)"
                    v-on:keyup.space="onPinCodeSelect($event,pincode)"
                    v-on:keyup.enter="onPinCodeSelect($event,pincode)"
                    v-on:keyup.up="navigate($event,index-1,lookup.PinCodes.length)"
                    v-on:keyup.down="navigate($event,index+1,lookup.PinCodes.length)">{{pincode.PinCode}} </a>
            </div>
        </div>
        <div class="pop-overlay" v-if="delivery && delivery.beingEdited"> </div>
    </div>
</div>
