<script type="text/javascript" src="/resources/scripts/node_modules/lockr/lockr.min.js" defer></script>
<script type="text/javascript" src="/resources/scripts/node_modules/axios/dist/axios.min.js" defer></script>
<script type="text/javascript" src="/resources/scripts/node_modules/vue/dist/vue.js" defer></script>
<script type="text/javascript" src="/resources/scripts/swf/js/entity_helper.js" defer></script>
<script type="text/javascript" src="/fragments/js/util.js"></script>
<link rel="preload" as="style" href="/fragments/css/mandi.css" onload="this.onload=null;this.rel='stylesheet'">



<script type="text/javascript">
    $(function () {
        var params = (new URL(window.location)).searchParams;
        var term = params.get("search");
        var provider_id = params.get("provider_id");
        var provider_location_id = params.get("provider_location_id");
        

        let PreferredMaxDistance = Lockr.get("PreferredMaxDistance");
        if (!PreferredMaxDistance) {
            PreferredMaxDistance = 5;
        } else if (PreferredMaxDistance > 20) {
            PreferredMaxDistance = 20;
        }else {
            PreferredMaxDistance = 10 ;
        }
        Lockr.set("PreferredMaxDistance", PreferredMaxDistance);
        if (!Lockr.get("usecase.Category")) {
            Lockr.set("usecase.Category", "Inventory");
        }

        var search = {
            context: { ttl : "PT20S" },
            message: {
                intent : { 
                    descriptor: {
                       name : term || "" 
                    },
                    fulfillment : {
                        end : {
                            location: {
                                circle : {
                                    radius : { value : PreferredMaxDistance , unit : "Km"}
                                }
                            }
                        }
                        
                    }
                }
            }
        };
        if (provider_id){
            search.message.intent.provider = { id : provider_id } ;
        }
        if (provider_location_id){
            search.message.intent.provider.locations = [{ id : provider_location_id }]; 
        }




        new Vue({
            el: "#app",
            data: {
                Mobile: isMobile(),
                User: {},
                sendSubscriptionToServer: sendSubscriptionToServer,
                equalAddress: equalAddress,
                ShipmentCount: 0,
                OrderLineCount: 0,
                OrderAmount: 0,
                DeliveryAmount: 0,
                itemWidth: 0,
                facilityWidth: 0,
                blank: blank,
                evtSource : null,
                usecase: {
                    Category : provider_location_id ? "Inventory" : Lockr.get("usecase.Category"),
                    MaxDistance : PreferredMaxDistance
                },
                provider_location_id: provider_location_id,
                config : {
                    termLengthTrigger: 1,
                    timer: undefined,
                    selected_network : undefined,
                },
                search: search,
                on_search: {},
                all_items :[] ,
                items :[] ,
                provider_location : {} , // hash
                networks: [] ,

                hideNewDelivery: true,
                delivery: null,
                lookup: {
                    Cities: [],
                    PinCodes: [],
                    lookupselectionIndex: -1,
                },
                facilityOrders: Lockr.get("facilityOrders") || {},
            },
            created: function () {
                let self = this;
                showSpinner();

                api().url("/users/current").get().then(function (response) {
                    self.User = response.User;
                    self.initDeliveryAddress();
                    if (!self.User.UserPhones) {
                        self.User.UserPhones = [];
                    }
                    Lockr.set("User", self.User);
                    let guest = !self.User.Name;
                    let validated = guest || self.User.Id == 1 || self.User.UserPhones.length > 0;
                    if (!guest) {
                        if (self.User.SignUps && self.User.SignUps.length > 0) {
                            Lockr.set("SignUp", self.User.SignUps[0]);
                        }
                        subscribe(sendSubscriptionToServer); //Do Subscription only after setting User.
                        if (self.User.TermsAccepted !== 'Y') {
                            window.location.replace("/dashboard/html/terms");
                            return;
                        }
                        if (self.User.PasswordSet !== 'Y') {
                            window.location.href = ("/users/html/profile");
                            return;
                        }
                        if (validated) {
                            self.User.UserPhones.forEach((item, i) => {
                                if (item.Validated === 'N') {
                                    validated = false;
                                }
                            });
                        }
                    }


                    if (!validated) {
                        window.location.href = ("/users/html/profile");
                            }
                }).then(function() {
                    networks().then(function(response){
                        self.networks = response;
                        self.config.selected_network = self.networks[0] ;
                        Lockr.set("selected_network",self.config.selected_network);
                    });
                    /*
                    api().url("/beckn_networks").get().then(function (response) {
                        self.networks= response.BecknNetworks.filter(bn=>{
                            return bn.Disabled == 'N' ;
                        });
                    }); */
                }).finally(function(){
                    self.find(null);
                    self.showApp();
                });
            },
            methods: {
                initSearch : function(){
                    let self = this;
                    self.all_items.splice(0);
                    self.items.splice(0);
                    Vue.set(self,"on_search",{});
                    Vue.set(self,"provider_location",{});
                },
                initDeliveryAddress: function () {
                    let self = this;
                    self.delivery = Lockr.get("delivery");
                    if (!self.delivery) {
                        self.delivery = {
                            Address: {},
                            beingEdited: false,
                            DraftAddress: {},
                        };
                        copyAddress(self.User, self.delivery.Address); //There in util.js
                    }
                },
                isAddressChanged: function (from, to) {
                    return !equalAddress(from,to,false); //Basic address fields not including name, lat and lng
                },
                reloadCounts: function () {
                    let self = this;

                    var obj = self.facilityOrders;
                    self.ShipmentCount = 0;
                    self.OrderLineCount = 0;
                    self.OrderAmount = 0;

                    for (key in obj) {
                        if (obj.hasOwnProperty(key)) {
                            self.ShipmentCount += 1;
                            var order = obj[key].transaction.select.message.order;
                            var on_select_order = obj[key].transaction.on_select ? obj[key].transaction.on_select.message.order : null ;

                            self.OrderLineCount += order.items.length;

                            if (on_select_order){
                                self.OrderAmount += on_select_order.quote.price.value;
                            }else {
                                order.items.forEach((item, i) => {
                                    self.OrderAmount += item.quantity.count * item.price.value
                                });
                            }
                            if (order.items.length === 0) {
                                delete obj[key];
                                self.clearFilterItems(key);
                            }
                        }
                    }
                    if (typeof updateHeaderCount === 'function'){
                        updateHeaderCount();
                    }
                },
                showApp: function () {
                    let self = this;
                    $("#header").load("/fragments/html/header", {}, function () {
                        fixMenu();
                        $("#pageTitle").html("HumBhiOnline");
                        window.innerWidth < 640
                            && $(".body").css("padding-top", "148px");
                        $("#root").show();
                        $("#search").focus();
                        self.reloadCounts();
                        if (self.OrderLineCount > 0 && Lockr.get("signup-triggered")) {
                            self.buy(null);
                        }
                    });
                },
                headers: function () {
                    let location = Lockr.get("Location");
                    if (location && location.latitude && location.longitude) {
                        return { Lat: location.latitude, Lng: location.longitude };
                    } else {
                        return {};
                    }
                },
                isSearchTriggerable: function (length = this.config.termLengthTrigger) {
                    let self = this;
                    return self.search.message.intent.descriptor.name.length >= length;
                },
                find: function (e) {
                    let self = this;
                    if (e) {
                        e.preventDefault();
                        if (self.search.message.intent.descriptor.name !== e.target.value ){
                            self.search.message.intent.descriptor.name = e.target.value;
                        }
                    }
                    enableSwipe();

                    if (self.config.timer) {
                        clearTimeout(self.config.timer);
                        self.config.timer = undefined;
                    }

                    self.config.timer = setTimeout(function () {
                        self._find();
                        self.config.timer = undefined;
                    }, 400);
                },
                digest: function(response){
                    let self = this;
                   context = response.context;
                   self.on_search[context.bpp_id] = response;
                   let headers = self.headers();

                   response.message.catalog["bpp/providers"].forEach(p=>{
                        if (!p.descriptor){
                            p.descriptor = response.message.catalog["bpp/descriptior"];
                        }
                        p.locations.forEach(pl=>{
                            self.provider_location[pl.id] = pl;
                            if (!pl.descriptor) {
                                pl.descriptor = p.descriptor;
                            }
                            if (!pl.distance && pl.gps && headers.Lat){
                                l = pl.gps.split(",");
                                pl.distance = distance(Number.parseFloat(l[0]),Number.parseFloat(l[1]),headers.Lat,headers.Lng);
                            }
                            pl.provider_id = p.id;
                        });
                        p.fulfillments.forEach(f=>{
                            let pl = self.provider_location[f.start.location.id];
                            if (!pl.fulfillments){
                                pl.fulfillments = [] ;
                            }
                            pl.fulfillments.push(f);
                        });
                        p.items.forEach(i=>{
                            i.bpp_id = context.bpp_id;
                            i.provider_id = p.id;
                            if (!i.quantity){
                                i.quantity = {};
                            }
                            if (!i.quantity){
                                i.quantity = {}
                            }
                            if (!i.quantity.count ){
                                i.quantity.count = 0;
                                var cart_info = self.facilityOrders[i.location_id];
                                if (cart_info){
                                    var cart_item = cart_info.transaction.select.message.order.items.find(function(_i){
                                        return _i.id =i.id
                                    });
                                    i.quantity.count = cart_item.quantity.count;
                                }
                            }
                            if (!i.quantity.measure && i.quantity.available && i.quantity.available.measure){
                                    i.quantity.measure = i.quantity.available.measure;
                            }
                            self.all_items.push(i);
                            self.items.push(i);
                        });
                    });
                },
                current_search_term : function(){
                    return search.message.intent.descriptor.name.replace(/[^a-zA-Z0-9 ]/g, " ").trim();
                },
                _find: function () {
                    let self = this;
                    let search_term = self.current_search_term();
                    if (self.blank(search_term)){
                        return;
                    }
                    self.initSearch();
                    let headers = self.headers();
                    self.search.message.intent.fulfillment.end.location.gps = headers.Lat + "," +  headers.Lng;
                    self.search.message.intent.fulfillment.end.location.circle.gps = headers.Lat + "," +  headers.Lng;
                    self.search.context.city = self.delivery.Address.City.Code ;
                    showSpinner();
                    api().url("/" + self.config.selected_network+ "/network/search").parameters(self.search).post().then(function(requestFired){
                        console.log("Checking messages for " + requestFired.context.message_id);
                        if (self.evtSource){
                            self.evtSource.close();
                        }
                        self.evtSource = new EventSource("/" + self.config.selected_network + "/network/read_events/"+requestFired.context.message_id, {
                            withCredentials : true
                        });
                        self.evtSource.onmessage = (event)=>{
                                showSpinner();
                                console.log("got " + event.data );
                                response = JSON.parse(event.data);
                                let possibly_changed_search_term = self.current_search_term();
                                if (!response || response.done || possibly_changed_search_term != search_term) {
                                    if (possibly_changed_search_term != search_term ) {
                                        self.initSearch();
                                    }
                                    disableSwipe();
                                    self.evtSource.close();
                                    hideSpinner();
                                    return;
                                }
                                if (response.message){
                                    self.digest(response);
                                }
                        };
                    });
                },
                onQtyChange: function (event, index) {
                    let self = this;
                    //EDIT
                    let result = self.items[index];
                    result.quantity.count =  Math.max(0, result.quantity.count);
                    result.quantity.measure = result.quantity.available.measure;
                    Vue.set(self.items, index, result);
                    self.addToCart(event, result);
                },
                reduce: function (event, index) {
                    let self = this;
                    let result = self.items[index];
                    result.quantity.count -= 1.0;
                    result.quantity.count = Math.max(0, result.quantity.count);
                    Vue.set(self.items, index, result);
                    self.addToCart(event, result);
                },
                increase: function (event, index) {
                    let self = this;
                    let result = self.items[index];

                    if (!result.quantity.count){
                        result.quantity.count = 0;
                    }
                    result.quantity.count += 1.0;
                    Vue.set(self.items, index, result);
                    self.addToCart(event, result);
                },
                context: function(bpp_id){
                    let self = this; 
                    return self.on_search[bpp_id].context;
                },
                provider: function (item){
                    let self = this;

                    return self.on_search[item.bpp_id].message.catalog["bpp/providers"].find(function(p) {
                       return p.id == item.provider_id; 
                    });
                },
                get_provider_location : function(item){ //Unused
                    let self = this;
                    var provider = self.provider(item);
                    let provider_location_id = item.location_id || item.location_ids[0];
                    return provider.locations.find(function(l){
                        return f.id == provider_location_id
                    });
                },
                fulfillment : function(item){
                    let self = this;
                    var provider = self.provider(item);
                    provider.fulfillments.find(function(f){
                        return f.id == item.fulfillment_id
                    });
                },
                filterItems :function(coexisting_item){
                    let self = this;
                    let provider_location_id = coexisting_item.location_id || coexisting_item.location_ids[0];
                    let fulfillment_id = coexisting_item.fulfillment_id;

                    self.items = this.all_items.filter(function(i){
                        return ((i.location_id || i.location_ids[0]) == provider_location_id) && fulfillment_id == i.fulfillment_id ;
                    });
                    Vue.set(self,"items",self.items);
                },
                clearFilterItems: function(provider_location_id){
                    this.items = this.all_items;
                },
                addToCart: function (event, result) {
                    if (event) {
                        event.preventDefault();
                    }
                    let self = this;
                    let provider_location_id = result.location_id || result.location_ids[0];
                    if (!self.facilityOrders[provider_location_id]) {
                        self.facilityOrders[provider_location_id] = {
                            transaction : {
                                select : {
                                    context : self.context(result.bpp_id),
                                    message : {
                                        order : {
                                            items : []
                                        }
                                    }
                                },
                            }
                        };
                        self.filterItems(result);
                        Vue.set(self.facilityOrders, provider_location_id, self.facilityOrders[provider_location_id]);
                    }

                    var transaction = self.facilityOrders[provider_location_id].transaction;
                    var select = transaction.select;
                    select.context.action = "select" ;
                    delete select.context.message_id;

                    var order = select.message.order;
                    if (!order.provider){
                        var provider = self.provider(result); 
                        order.provider = { 
                            "id" : provider.id ,
                            locations : []   
                        } 

                        var provider_location = provider.locations.find(function(l) {
                            return l.id=provider_location_id;
                        });
                        order.provider.locations.push(provider_location);

                        var fulfillment = provider.fulfillments.find(function(f){
                            return f.id == result.fulfillment_id;
                        });

                        order.fulfillment = { ...fulfillment} ;
                        order.fulfillment.end = self.search.message.intent.fulfillment.end;
                        order.provider.payments =  provider.payments;
                    }else {
                        if (order.fulfillment.id != result.fulfillment_id){
                            result.quantity.count = 0;
                            showErrorMessage("Can't mix items that are " + order.fulfillment.type + " and " + fulfillment(item).type);
                        }
                    }

                    let index = order.items.findIndex(function (ol) {
                        return ol.id === result.id 
                    });
                    if (index < 0) {
                        if (result.quantity.count * 1 > 0) {
                            order.items.push(result);
                        }
                    } else {
                        if (result.quantity.count * 1 > 0) {
                            order.items.splice(index, 1, result);
                        } else {
                            order.items.splice(index, 1);
                        }
                    }

                    showSpinner()
                    api().url("/" + self.config.selected_network + "/network/select").headers({"X-CallBackToBeSynchronized":"Y"}).parameters(select).post().then(function(on_select){
                        transaction.on_select = on_select[0];
                        transaction.init = transaction.on_select;

                        transaction.init.context.action = "init";
                        delete transaction.init.context.message_id
                        if (event) {
                            self.reloadCounts();
                        }
                        Lockr.set("facilityOrders", self.facilityOrders);
                    }).finally(function(){
                        hideSpinner()
                    });
                },
                setPreferredDistance: function (distance) {
                    let oldValue = Lockr.get("PreferredMaxDistance");
                    if (oldValue != distance) {
                        Lockr.set("PreferredMaxDistance", distance);
                        this.find(null);
                    }
                },
                buy: function (event) {
                    event && event.preventDefault();
                    let self =this;
                    let address = self.delivery.Address;
                    if (!address.AddressLine1 ||!address.City ){
                        self.editDeliveryAddress(event);
                        return;
                    }

                    let obj= self.facilityOrders;
                    for (key in obj){
                        var inits = [] ;
                        if (obj.hasOwnProperty(key)) {
                            var init = obj[key].transaction.init;
                            var order = init.message.order ;
                            var user  = self.User; 
                            if (!order.fulfillment){
                                order.fulfillment = obj[key].transaction.select.message.order.fulfillment;
                            }
                            order.fulfillment.end = { "location" : {  
                                                                    gps : address.Lat + "," + address.Lng,
                                                                    address : {
                                                                        name : address.LongName,
                                                                        building : address.AddressLine1 ,
                                                                        street : address.AddressLine2, 
                                                                        locality : ( address.AddressLine3 ? address.AddressLine3 : "" )  + ( address.AddressLine4 ? "," + address.AddressLine4 : "" ) ,
                                                                        city : address.City.Name,
                                                                        state : address.City.State.Name,
                                                                        area_code : address.PinCode.PinCode,
                                                                        country : address.City.State.Country.Name
                                                                    },
                                                               },
                                                        person : {
                                                            name : address.LongName
                                                        },
                                                        contact : { 
                                                            phone : address.PhoneNumber
                                                        }
                                                   } ;
                            order.billing = { 
                                                address : {
                                                        name : user.LongName,
                                                        building : user.AddressLine1 ,
                                                        street : user.AddressLine2, 
                                                        locality : ( user.AddressLine3 ? user.AddressLine3 : "" )  + ( user.AddressLine4 ? "," + user.AddressLine4 : "" ) ,
                                                        city : user.City.Name,
                                                        state : user.City.State.Name,
                                                        area_code : user.PinCode.PinCode,
                                                        country : user.City.State.Country.Name
                                                      },
                                                email  : user.Email,
                                                phone  : user.PhoneNumber,
                                                name   : user.LongName 
                                             };
                            order.fulfillment.customer = { contact : { phone : user.PhoneNumber} , person: { name : user.LongName } } ;
                            inits.push(api().url("/"+self.config.selected_network + "/network/init").headers({"X-CallBackToBeSynchronized":"Y"}).parameters(init).post().then(function(on_init){
                                obj[key].transaction.on_init = on_init[0];
                                return on_init[0];
                            }).catch(function(err){
                                showError(err);
                            }));
                        }

                        showSpinner();
                        Promise.all(inits).then(function(values){
                            Lockr.set("facilityOrders",self.facilityOrders);
                            self.reloadCounts();
                            var hasError = false;
                            values.forEach(function(v){
                                if (v.error){
                                    hasError = true;
                                }
                            });
                            if (!hasError){
                                window.location.replace("/buy");
                            }
                        }).finally(function(){
                            hideSpinner();
                        });
                    }
                },
                whatsapp_url: function (f) {
                    var url = "";
                    let self = this;
                    if (isMobile()) {
                        url += 'whatsapp://send';
                    } else {
                        url += 'https://web.whatsapp.com/send'
                    }
                    url += '?phone=' + f.contact.phone;
                    return url;
                },
                /* Delivery Address Setting code */
                selectDeliveryAddress(ev, address, index) {
                    ev && ev.preventDefault();
                    let self = this;
                    copyAddress(address, self.delivery.Address);
                    self.editDeliveryAddress(ev);
                }
                /* Delivery Address Setting code */
                , setNewDeliveryAddress(ev, status) {
                    ev && ev.preventDefault();
                    let self = this;
                    let address = {
                        "AddressLine1": null,
                        "AddressLine2": null,
                        "City": {
                            "Name": null,
                            "State": {
                                "Country": {
                                    "Id": "1",
                                    "IsoCode": "IND",
                                    "Name": "India"
                                },
                                "Name": null
                            }
                        },
                        "LongName": null,
                        "PinCode": {
                            "PinCode": null
                        },
                        "Email": null
                    }
                    copyAddress(address, self.delivery.Address);
                    self.hideNewDelivery = status
                    self.editDeliveryAddress(ev);
                }
                , editDeliveryAddress: function (ev) {
                    ev && ev.preventDefault();
                    let self = this;
                    //Show address popup for data entry
                    //Show saved addresses for selection.
                    self.delivery.beingEdited = true;
                    self.delivery.DraftAddress = JSON.parse(JSON.stringify(self.delivery.Address));
                },
                cancelEditDeliveryAddress: function (ev) {
                    ev && ev.preventDefault();
                    let self = this;
                    self.initDeliveryAddress();
                    self.delivery.beingEdited = false;
                    self.delivery.DraftAddress = {};
                },
                updateDeliveryLocation: function (address) {
                    let location = Lockr.get("Location");
                    if (!location) {
                        location = { latitude: address.Lat, longitude: address.Lng };
                    } else {
                        location.latitude = address.Lat;
                        location.longitude = address.Lng;
                    }
                    Lockr.set("Location", location);
                },
                saveDeliveryAddress: function (ev) {
                    ev && ev.preventDefault();
                    let self = this;

                    if (self.isAddressChanged(self.delivery.Address, self.delivery.DraftAddress)) {
                        showSpinner();
                        api().url("/delivery_addresses/locate").parameters({ "DeliveryAddress": self.delivery.DraftAddress }).post().then(function (response) {
                            Vue.set(self.delivery, "Address", response.DeliveryAddresses[0]);
                            self.delivery.beingEdited = false;
                            self.delivery.DraftAddress = {};
                            Lockr.set("delivery", self.delivery);
                            self.updateDeliveryLocation(self.delivery.Address);
                        }).catch(function (err) {
                            showError(err);

                        }).finally(function () {
                            hideSpinner();
                        })
                    } else {
                        self.delivery.Address = self.delivery.DraftAddress;
                        self.delivery.DraftAddress = {};
                        self.delivery.beingEdited = false;
                        Lockr.set("delivery", self.delivery);
                        self.updateDeliveryLocation(self.delivery.Address);
                    }
                },
                isKeyTriggerable: function (e) {
                    return (e && e.target.value.length > 1);
                },
                onCityChange: function (e) {
                    e && e.preventDefault();
                    if (!this.isKeyTriggerable(e)) {
                        return;
                    }
                    let self = this;
                    new Autocomplete("cities", e.target).search().then(function (response) {
                        if (!response) {
                            return
                        }
                        self.lookup.Cities = response.Cities;
                        self.loadLookupEntries(e.target);
                        Vue.set(self.lookup, "Cities", self.lookup.Cities);
                    });
                },
                onCitySelect: function (e, item) {
                    e && e.preventDefault();
                    let self = this;
                    self.hideKeyboard().then(function () {
                        self.delivery.DraftAddress.City = item;
                        self.delivery.DraftAddress.State = item.State;
                        self.delivery.DraftAddress.Country = item.State.Country;
                        self.lookup.Cities = [];
                    });
                },
                onPinCodeChange: function (e) {
                    e && e.preventDefault();
                    if (!this.isKeyTriggerable(e)) {
                        return;
                    }

                    let self = this;
                    new Autocomplete("pin_codes", e.target).search("PIN_CODE").then(function (response) {
                        if (!response) {
                            return
                        }
                        self.lookup.PinCodes = response.PinCodes;
                        self.loadLookupEntries(e.target);
                    });
                },
                onPinCodeSelect: function (e, item) {
                    e && e.preventDefault();
                    let self = this;
                    self.hideKeyboard().then(function () {
                        self.delivery.DraftAddress.PinCode = item;
                        if (self.delivery.DraftAddress.PinCode.City && self.delivery.DraftAddress.PinCode.City.Id) {
                            self.delivery.DraftAddress.City = self.delivery.DraftAddress.PinCode.City;
                        }
                        self.lookup.PinCodes = [];
                    });
                },
                getParentDiv: function (element) {
                    var div = element;
                    while (div && div.tagName !== 'DIV') {
                        div = div.parentElement;
                    }
                    return div;
                },
                loadLookupEntries: function (element) {
                    var div = this.getParentDiv(element);
                    if (div) {
                        div.appendChild(this.$refs['lookupEntries']);
                    }
                },

                navigate: function (e, index, length) {
                    e && e.preventDefault();
                    let self = this;
                    this.lookup.lookupselectionIndex = (index % length);
                    let anchors = this.$refs['lookupEntries'].getElementsByTagName("a");
                    anchors[this.lookup.lookupselectionIndex].focus();
                },
                removeList: function (e) {
                    let elem = e.target;
                    let self = this;
                    self.hideKeyboard().then(function () {
                        self.lookup.Cities = [];
                        self.lookup.PinCodes = [];
                        $(".lookups-list").removeClass("offsetTop");
                    });
                },
                hideKeyboard: function () {
                    return new Promise(function (resolve, reject) {
                        //let dummy = $("#dummy");
                        let dummy = $(document.documentElement);
                        setTimeout(function () {
                            dummy.focus();
                            setTimeout(function () {
                                resolve();
                            }, 50);
                        }, 50);
                    });
                },
                openFacility: function (f) {
                    window.location.href = `/dashboard?provider_location_id=${f.Id}`
                },
                onSearchCategoryChange: function () {
                    let self = this;
                    if (!provider_location_id) {
                        Lockr.set("usecase.Category", self.usecase.Category);
                    }
                },
            }
        });
    });
</script>
<div id="root" style="display:none;">
    <div id="header">
    </div>
    <div id="app" class="app-body" >
        <!-- Show facility banner -->
        <div class="container" v-if="provider_location_id && provider_location[provider_location_id] && provider_location[provider_location_id].descriptor">
            <div id="banner-slider" class="carousel slide" data-ride="carousel">
                <!-- Indicators -->
                <ul class="carousel-indicators">
                    <li data-target="#banner-slider" v-bind:data-slide-to="index"
                        v-bind:class="index == 0 ? 'active' : '' "
                        v-for="(imageurl,index) in provider_location[provider_location_id].descriptor.images">
                    </li>
                </ul>
                <!-- The slideshow -->
                <div class="carousel-inner">
                    <div v-bind:class="'justify-content-center carousel-item ' + (index == 0 ? 'active' : '') "
                        v-for="(imageurl,index) in provider_location[provider_location_id].descriptor.images">
                        <img v-bind:src="imageurl"></img>
                    </div>
                </div>

                <!-- Left and right controls -->
                <a class="carousel-control-prev" href="#banner-slider" data-slide="prev">
                    <span class="carousel-control-prev-icon"></span>
                </a>
                <a class="carousel-control-next" href="#banner-slider" data-slide="next">
                    <span class="carousel-control-next-icon"></span>
                </a>
            </div>
            <div class="row">
                <div class="col-12 item-list">
                    <h6 class="mb-0">{{provider_location[provider_location_id].descriptor.name}}</h6>
                    <p class="m-0 text-muted">
                        {{provider_location[provider_location_id].address.name}}, {{provider_location[provider_location_id].address.locality}},
                        {{provider_location[provider_location_id].address.city}}, {{provider_location[provider_location_id].address.state}}
                        {{provider_location[provider_location_id].address.area_code}}, <a
                            v-bind:href="'tel:'+ provider_location[provider_location_id].fulfillments[0].start.contact.phone">{{provider_location[provider_location_id].fulfillments[0].start.contact.phone}}</a>
                    </p>
                    <div class="row">
                        <div class="col">
                            <!-- <a class="btn btn-link" v-bind:href="'tel:'+ search.Facility.PhoneNumber"
                                    v-if="Mobile && search.Facility.PhoneNumber">
                                    <i class="fa-phone-alt fas"></i>
                                </a> -->
                            <a v-bind:href="whatsapp_url(provider_location[provider_location_id].fulfillments[0].start.contact.phone)" data-action="share/whatsapp/share"
                                class="btn btn-link px-1" v-if="provider_location[provider_location_id].fulfillments[0].start.contact.phone">
                                <i class="fab fa-whatsapp"></i>
                            </a>
                        </div>
                        <div class="col d-flex justify-content-end align-items-center" v-if="provider_location[provider_location_id].distance" >
                            <small>@ Distance of {{(provider_location[provider_location_id].distance * 1.0).toFixed(2)}} Km</small>
                        </div>
                    </div>
                    <!-- {{search.Facility.Lat +","+ search.Facility.Lng}} -->
                </div>
            </div>
        </div>
        <!-- Search field ---> 
        <div class="container">
            <div id="search-holder" class="form-row search-holder mb-sm-6 mt-2">
                <div class="col-12">
                    <div class="d-flex flex-row align-items-center">
                        <select v-model="usecase.Category" class="category-control col-4"
                            v-bind:disabled="provider_location_id && provider_location[provider_location_id].descriptor.name  ? true : false"
                            :on_change="onSearchCategoryChange()">
                            <option>Inventory</option>
                            <option>Facility</option>
                        </select>
                        <input key="search" id="search" class="search-control" placeholder="Search for Items or Store"
                            v-on:input="find($event)" v-model="search.message.intent.descriptor.name" />
                        <i class="fa fa-search"></i>
                    </div>
                    <div class="form-row mt-1">
                        <div class="col-8">
                            <div class="form-check-inline align-middle mr-1">
                                <input class="form-check-input mb-0" type="radio" v-model="usecase.MaxDistance"
                                    name="MaxDistance" id="distance_filter_5" value="5"
                                    @change="setPreferredDistance(5)">
                                <label class="form-check-label small" for="distance_filter_5">0 - 5</label>
                            </div>
                            <div class="form-check-inline align-middle mr-1">
                                <input class="form-check-input mb-0" type="radio" v-model="usecase.MaxDistance"
                                    name="MaxDistance" id="distance_filter_10" value="10"
                                    @change="setPreferredDistance(10)">
                                <label class="form-check-label small" for="distance_filter_10">0 - 10</label>
                            </div>
                            <div class="form-check-inline align-middle mr-1">
                                <input class="form-check-input mb-0" type="radio" v-model="usecase.MaxDistance"
                                    name="MaxDistance" id="distance_filter_20" value="20"
                                    @change="setPreferredDistance(20)">
                                <label class="form-check-label small" for="distance_filter_20">>10</label>
                            </div>
                        </div>
                        <div class="col text-right">
                            <a @click="editDeliveryAddress($event)" v-if="User.Name && delivery && delivery.Address">
                                <i class="h6 fa fa-map-marker-alt mr-1"></i>
                                {{ delivery.Address.PinCode ? delivery.Address.PinCode.PinCode : "Where are you?" }}</a>
                        </div>
                    </div>

                </div>
            </div>
            <!-- Show facility list -->
            <div class="row mt-sm-3" v-if="(usecase.Category === 'Facility')">
                <div class="col-lg-3 col-sm-4 mb-0 mb-sm-4" v-for="(result,location_id,index) in provider_location"
                    v-if="Object.keys(provider_location).length > 0">
                    <div class="item-list" v-bind:id="'facility-'+index">
                        <div class="form-row">
                            <div class="col-12">
                                <div class="img-holder border rounded-sm" @click="openFacility(result)">
                                    <img class="img-fluid w-100 h-100"
                                        v-bind:src="result.descriptor.images[0]"
                                        v-if="result.descriptor.images && result.descriptor.images.length > 0" />
                                    <div v-else
                                        class="default-img d-flex bg-light align-items-center justify-content-center"
                                        v-bind:style="{ height: facilityWidth + 'px' }">
                                        <span class="font-weight-bold text-muted">{{result.descriptor.name}}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Show inventory list -->
            <div class="row mt-sm-3" v-if="(usecase.Category==='Inventory')">
                <div class="col-lg-3 col-sm-4 mb-0 mb-sm-4" v-for="(result,index) in items"
                    v-if="items.length > 0">
                    <div class="item-list" v-bind:id="'item-'+index" >
                        <div class="form-row">
                            <div class="col-4 col-sm-12">
                                <div class="img-holder border rounded-sm">
                                    <img class="img-fluid w-100 h-100"
                                        v-bind:src="result.descriptor.images[0]"
                                        v-if="result.descriptor.images && result.descriptor.images.length > 0"
                                        data-toggle="modal" v-bind:data-target="'#sku-img-'+result.id" />
                                    <div v-else
                                        class="default-img d-flex bg-light align-items-center justify-content-center"
                                        v-bind:style="{ height: itemWidth + 'px' }" >
                                        <span class="font-weight-bold text-muted" >{{result.descriptor.name}} </span>
                                    </div>
                                    <!-- Modal View Images -->
                                    <div v-if="result.descriptor.images && result.descriptor.images.length > 0"
                                        class="modal fade" v-bind:id="'sku-img-'+result.id" tabindex="-1"
                                        aria-labelledby="exampleModalLabel" aria-hidden="true">
                                        <div class="modal-dialog">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <h5 class="modal-title" id="exampleModalLabel">
                                                        {{result.descriptor.name}}
                                                    </h5>
                                                    <button type="button" class="close" data-dismiss="modal"
                                                        aria-label="Close">
                                                        <span aria-hidden="true">&times;</span>
                                                    </button>
                                                </div>
                                                <div class="modal-body">
                                                    <img class="img-fluid w-100 h-100"
                                                        v-if="result.descriptor.images && result.descriptor.images.length > 0"
                                                        v-bind:src="result.descriptor.images[0]" />
                                                </div>
                                            </div>

                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col pb-4 pb-sm-0">
                                <h6 class="m-0 text-truncate" v-bind:title="result.descriptor.name">
                                    {{ result.descriptor.name }}
                                </h6>
                                <span class="small text-muted">{{ result.Tags }}</span>
                                <!-- <p class="mb-0 small">{{result.Tags}}</p> -->
                                <p class="mb-1 small text-muted text-truncate" v-bind:title="provider_location[result.location_id].descriptor.name">
                                    By: <a
                                        v-bind:href="'/dashboard?provider_location_id=' +result.location_id">{{provider_location[result.location_id].descriptor.name}}
                                        <!-- <i v-bind:class="User.Verified === 'Y' ? 'fas fa-check' : '' "></i> Verifyable creds story-->
                                    </a>
                                </p>
                                <div class="form-row">
                                    <div class="col small">
                                        <a
                                            v-bind:href="'https://google.com/maps/place/'+provider_location[result.location_id].gps" >
                                            <i class="fa fa-map-pin mr-1 text-muted"></i>
                                            {{(provider_location[result.location_id].distance * 1.0).toFixed(2)}} Km
                                        </a>
                                    </div>
                                </div>
                                <p class="price-box d-block d-sm-none">
                                    <strike v-if="result.price.maximum_value * 1.0 > result.price.value">
                                        &#x20B9; {{result.MaxRetailPrice}}
                                    </strike>
                                    <span v-if="result.price.value * 1.0 > 0.0">&#x20B9; {{result.price.value}}</span>
                                </p>
                            </div>
                        </div>
                        <hr class="my-2 d-block d-sm-none" />
                        <div class="form-row mt-sm-3">
                            <div class="col-4 col-sm-4 order-sm-last">
                                <div class="btn-group" role="group" aria-label="Basic example">
                                    <button type="button" class="btn btn-sm btn-outline-primary border-right-0 m-0"
                                        v-on:click="reduce($event,index)">
                                        <i class="fa fa-minus"></i>
                                    </button>
                                    <input v-bind:key="'quantity' + index" v-bind:id="'quantity' + index"
                                        class="btn btn-sm btn-outline-primary w-100 border-left-0 border-right-0 m-0"
                                        placeholder="Quantity" v-model="result.quantity.count"
                                        @change="onQtyChange($event,index)" />
                                    <button type="button" class="btn btn-sm btn-outline-primary border-left-0"
                                        v-on:click="increase($event,index)">
                                        <i class="fa fa-plus"></i>
                                    </button>
                                </div>
                            </div>
                            <div
                                class="col text-right text-sm-left d-flex align-items-center justify-content-end justify-content-sm-start">
                                <h6 class="d-none d-sm-block desk-price">
                                    <strike v-if="result.price.maximum_value * 1.0 > result.price.value">
                                        &#x20B9; {{result.MaxRetailPrice}}
                                    </strike>
                                    <span v-if="result.price.value * 1.0 > 0.0">&#x20B9; {{result.price.value}}</span>
                                </h6>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div style="height: 65px;" v-if="OrderLineCount > 0"></div>
        <div class="bottom-card" v-if="OrderLineCount > 0">
            <div class="form-row">
                <div class="col-8">
                    <h6 class="m-0" v-if="OrderAmount * 1.0 > 0">{{OrderLineCount}} Items | &#x20B9; {{(OrderAmount *
                        1.0).toFixed(2)}}</h6>
                </div>
                <div class="col d-flex align-items-center">
                    <a class="btn btn-primary btn-sm btn-block" href="#" @click="buy($event)">CHECKOUT</a>
                </div>
            </div>
        </div>
        <!-- Address choosing -->
        <div class="show-update delivery-address" v-if="delivery && delivery.beingEdited">
            <div class="form-row">
                <div class="col-12">
                    <h6>Deliver To <a v-bind:hidden="!hideNewDelivery" class="float-right"
                            @click="setNewDeliveryAddress($event,false)">Add New
                            Address</a> <a v-bind:hidden="hideNewDelivery" class="float-right"
                            @click="setNewDeliveryAddress($event,true)">Choose
                            Address</a></h6>
                </div>
                <div class="col-12" v-bind:hidden="!hideNewDelivery">
                    <div class="address-wrapper">
                        <div v-for="(address,index) in User.SavedAddresses"
                            @click="selectDeliveryAddress($event, address,index)" class="address-block" :class="[
                            equalAddress(delivery.DraftAddress,address) ? 'active' : '',
                          ]">
                            <h6>{{address.LongName}}</h6>
                            <div class="address-block-text">
                                {{address.AddressLine1}}
                                {{(blank(address.AddressLine2)? "" : "," )}}
                                {{address.AddressLine2}}
                                {{(blank(address.AddressLine3)? "" : "," )}}
                                {{address.AddressLine3}}
                                {{(blank(address.AddressLine4)? "" : "," )}}
                                {{address.AddressLine4}}
                            </div>
                            {{address.City.Name}}-{{address.State.Name}},
                            {{address.PinCode.PinCode}}
                        </div>
                    </div>
                </div>
                <div class="form-row" v-bind:hidden="hideNewDelivery">
                    <div class="col-12 mb-2">
                        <input class="form-control form-control-sm" id="name" v-model="delivery.DraftAddress.LongName"
                            placeholder="Full Name" />
                    </div>
                    <div class="col-6 mb-2">
                        <input class="form-control form-control-sm" id="a1" v-model="delivery.DraftAddress.AddressLine1"
                            placeholder="House Number" />
                    </div>
                    <div class="col-6 mb-2">
                        <input class="form-control form-control-sm" id="a2" v-model="delivery.DraftAddress.AddressLine2"
                            placeholder="Building Name" />
                    </div>
                    <div class="col-6 mb-2">
                        <input class="form-control form-control-sm" id="a3" v-model="delivery.DraftAddress.AddressLine3"
                            placeholder="Locality" />
                    </div>
                    <div class="col-6 mb-2">
                        <input class="form-control form-control-sm" id="a4" v-model="delivery.DraftAddress.AddressLine4"
                            placeholder="Locality" />
                    </div>
                    <div class="col-6 mb-2">
                        <input id="city" class="form-control form-control-sm" placeholder="City Name"
                            v-model="delivery.DraftAddress.City.Name" v-on:input="onCityChange($event)"
                            v-on:focus="removeList($event)" v-on:keyup.down="navigate($event,0,lookup.Cities.length)"
                            v-if="delivery.DraftAddress.City" />
                    </div>
                    <div class="col-6 mb-2">
                        <input id="pincode" class="form-control form-control-sm" placeholder="Pin Code"
                            v-model="delivery.DraftAddress.PinCode.PinCode" v-on:input="onPinCodeChange($event)"
                            v-on:focus="removeList($event)" v-on:keyup.down="navigate($event,0,lookup.PinCodes.length)"
                            v-if="delivery.DraftAddress.PinCode" />
                    </div>
                    <div class="col-6 mb-2">
                        <input id="phone" class="form-control form-control-sm" placeholder="PhoneNumber"
                            v-model="delivery.DraftAddress.PhoneNumber" />
                    </div>
                    <div class="col-6 mb-2">
                        <input id="email" class="form-control form-control-sm" placeholder="Email"
                            v-model="delivery.DraftAddress.Email" />
                    </div>
                </div>


                <div class="col-12 text-right">
                    <a href="#/" class="btn btn-sm btn-light mr-2" @click="cancelEditDeliveryAddress($event)">Cancel</a>
                    <a href="#/" class="btn btn-sm btn-primary" @click="saveDeliveryAddress($event)">Submit</a>
                </div>
            </div>
        </div>
        <div v-if="(delivery && delivery.beingEdited)">
            <div id="lookupEntries" ref="lookupEntries" class="lookups-list">
                <a href="#" class="text-truncate" v-for="(city,index) in lookup.Cities" v-if="lookup.Cities.length > 0"
                    v-on:click="onCitySelect($event,city)" v-on:keyup.enter="onCitySelect($event,city)"
                    v-on:keyup.space="onCitySelect($event,city)"
                    v-on:keyup.up="navigate($event,index-1,lookup.Cities.length)"
                    v-on:keyup.down="navigate($event,index+1,lookup.Cities.length)">{{city.Name}} -
                    {{city.State.Name}}</a>
                <a href="#" class="text-truncate" v-for="(pincode,index) in lookup.PinCodes"
                    v-if="lookup.PinCodes.length > 0" v-on:click="onPinCodeSelect($event,pincode)"
                    v-on:keyup.space="onPinCodeSelect($event,pincode)"
                    v-on:keyup.enter="onPinCodeSelect($event,pincode)"
                    v-on:keyup.up="navigate($event,index-1,lookup.PinCodes.length)"
                    v-on:keyup.down="navigate($event,index+1,lookup.PinCodes.length)">{{pincode.PinCode}} </a>
            </div>
        </div>
        <div class="pop-overlay" v-if="delivery && delivery.beingEdited"> </div>
    </div>
</div>
