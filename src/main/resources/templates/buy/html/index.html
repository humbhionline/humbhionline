<script type="text/javascript" src="/resources/scripts/node_modules/lockr/lockr.min.js" defer ></script>
<script type="text/javascript" src="/resources/scripts/node_modules/axios/dist/axios.min.js" defer></script>
<script type="text/javascript" src="/resources/scripts/node_modules/vue/dist/vue.js" defer></script>
<script type="text/javascript" src="/fragments/js/util.js" defer></script>
<link rel="preload" as="style" href="/fragments/css/mandi.css" onload="this.onload=null;this.rel='stylesheet'" >

<script type="text/javascript">
    $(function () {
        //$("#header").load("/fragments/html/header");
        new Vue({
            el: "#app",
            data: {
                User: Lockr.get("User"),
                guest: Lockr.get("User") && !Lockr.get("User").Name,
                totals : {
                },
                facilityOrders: Lockr.get("facilityOrders") || {},
                facilities: [],
                logout: logout,
                delivery : {},
                config : {
                    selected_network : null,
                }
            },
            created: function () {
                let self = this;
                self.delivery = Lockr.get("delivery") ; 
                if (!self.delivery ){
                    self.delivery = {}; 
                }
                if (!self.delivery.Address){ 
                    self.delivery.Address = {} ;
                    copyAddress(self.User, self.delivery.Address); //in util.js
                }
                Lockr.rm("signup-triggered");
                self.loadFacilities();
                self.config.selected_network = Lockr.get("selected_network");
                if (self.facilities.length > 0) {
                    self.showApp();
                } else {
                    window.location.replace("/dashboard");
                }
            },
            methods: {

                loadFacilities: function () {
                    let self = this;
                    self.facilities = [];
                    for (key in self.facilityOrders) {
                        if (self.facilityOrders.hasOwnProperty(key)) {
                            var on_select = self.facilityOrders[key].transaction.on_select;
                            var select = self.facilityOrders[key].transaction.select;
                            self.facilityOrders[key].transaction.confirm = {... self.facilityOrders[key].transaction.on_init };
                            var confirm = self.facilityOrders[key].transaction.confirm ;
                            confirm.context.action = "confirm" ;
                            delete confirm.context.message_id

                            

                            var location =  on_select.message.order.provider.locations[0];
                            var origItemMap = {};
                            var origLocationMap = {};

                            select.message.order.items.forEach(function(i){
                                origItemMap[i.id] = i;
                            });
                            select.message.order.provider.locations.forEach(function(l){
                                origLocationMap[l.id] = l ;
                            });

                            on_select.message.order.items.forEach(function(i){
                                i.descriptor = origItemMap[i.id].descriptor;
                            });

                            //order.fulfillment.type = order.fufillment.type || (!isDeliveryOrder(key) && order.items[0].Inventory.DeliveryProvided === 'N' ? 'Y' : 'N');
                            self.facilities.push(origLocationMap[location.id]);
                        }
                    }
                },
                continueShopping: function (event) {
                    if (event) {
                        event.preventDefault();
                    }
                    window.location.replace(document.referrer && document.referrer.indexOf("dashboard") > 0 ? document.referrer.replace(/&clone_order_id=[0-9]+/g, "") : "/index");
                },
                showApp: function () {
                    let self = this;
                    $("#header").load("/fragments/html/header", {}, function () {
                        fixMenu();
                        self.reloadCounts();
                        $("#pageTitle").html("Order Details");
                        $("#root").show();
                    });
                },
                addOrderToBook: function (f, orders) {
                    let self = this;
                    let address = self.delivery.Address;

                    let user = self.User;
                    var confirm = self.facilityOrders[f.id].transaction.confirm;
                    delete confirm.context.message_id
                    orders.push(confirm);
                },
                book: function (orders) {
                    let self = this;
                    var promises = [];
                    orders.forEach(function(o){
                        promises.push(api().headers({"X-CallBackToBeSynchronized":"Y"}).url("/" + self.config.selected_network + "/network/confirm").parameters( o ).post());
                    });
                    showSpinner();
                    Promise.all(promises).then(function (responses) {

                        responses.forEach((r,i) =>{
                            var o = r[0].message.order;
                            let index = self.facilities.findIndex(function(f){
                                return f.id == o.provider.locations[0].id
                            });
                            self.facilities.splice(index,1);
                            delete self.facilityOrders[o.provider.locations[0].id];
                        });
                        Lockr.set("facilityOrders", self.facilityOrders);


                        showErrorMessage("Order " + responses.map(r => r[0].message.order.id) + " Booked Successfully!").then(function () {
                            if (self.facilities.length > 0) {
                                window.location.reload();
                            } else {
                                window.location.replace("/orders/purchases");
                            }
                        });
                    }).catch(function (err) {
                        showError(err);
                    }).finally(function () {
                        hideSpinner();
                    });

                },
                bookOrder: function (event, f) {
                    if (event) {
                        event.preventDefault();
                    }
                    let self = this;
                    var orders = [];
                    self.addOrderToBook(f, orders);
                    self.book(orders);
                },
                bookOrders: function (event) {
                    if (event) {
                        event.preventDefault();
                    }
                    var orders = [];
                    let self = this;
                    if (self.guest) {
                        Lockr.set("signup-triggered", true);
                        self.logout();
                        return;
                    }

                    self.facilities.forEach((f, i) => {
                        self.addOrderToBook(f, orders);
                    });
                    self.book(orders)

                },
                onOrderLineQtyChange: function (event, provider_location, index) {
                    if (event) {
                        event.preventDefault();
                    }
                    let self = this;
                    let transaction = self.facilityOrders[provider_location.id].transaction;
                    let order = transaction.confirm.message.order;
                    let result = order.items[index];


                    var mayNeedToReload = false;
                    if (result.quantity.count <= 0) {
                        mayNeedToReload = true;
                        order.items.splice(index, 1);
                        if (order.items.length === 0) {
                            delete self.facilityOrders[provider_location.id];
                            Lockr.set("facilityOrders", self.facilityOrders);

                            transaction = undefined;
                            window.location.reload();
                        }
                    }

                    if (transaction){
                        let select = transaction.select; 
                        delete select.context.message_id
                        select.message.order.items = order.items ;

                        showSpinner();
                        api().headers({"X-CallBackToBeSynchronized":"Y"}).url("/" + self.config.selected_network + "/network/select").parameters( select ).
                                        post().then(function(on_select){
                            transaction.on_select = on_select[0]; 

                            let init = transaction.init; 
                            delete init.context.message_id;
                            init.message.order.quote = transaction.on_select.message.order.quote ;
                            init.message.order.items = transaction.on_select.message.order.items ; 

                            api().headers({"X-CallBackToBeSynchronized":"Y"}).url("/" + self.config.selected_network + "/network/init").parameters( init ).
                                            post().then(function(on_init){
                                transaction.on_init = on_init[0] ; 
                                transaction.confirm.message.order = transaction.on_init.message.order; 
                                Lockr.set("facilityOrders", self.facilityOrders);
                                if (mayNeedToReload) {
                                    self.loadFacilities();
                                }
                                self.reloadCounts();
                                self.$forceUpdate();
                                hideSpinner();
                            });
                        })
                    }
                },
                reduceOrderLine: function (event, provider_location, index) {
                    let self = this;
                    let result = self.facilityOrders[provider_location.id].transaction.confirm.message.order.items[index];
                    result.quantity.count -= 1;
                    self.onOrderLineQtyChange(event, provider_location, index);
                },
                increaseOrderLine: function (event, provider_location, index) {
                    if (event) {
                        event.preventDefault();
                    }

                    let self = this;

                    let result = self.facilityOrders[provider_location.id].transaction.confirm.message.order.items[index];

                    if (!result.quantity.count) {
                        result.quantity.count = 0.0;
                    }

                    result.quantity.count += 1;

                    self.onOrderLineQtyChange(event, provider_location, index);
                },
                reloadCounts: function () {
                    let self = this;

                    var obj = self.facilityOrders;
                    self.totals = {};
                    for (key in obj) {
                        if (obj.hasOwnProperty(key)) {
                            var order = obj[key].transaction.confirm.message.order;
                            self.totals[key] =  [] ;

                            order.quote.breakup.forEach((element,index)=>{
                                self.totals[key].push( element );
                            });
                            self.totals[key].push( {"title" : "Total" , "price" : order.quote.price});
                                

                            if (order.items.length === 0) {
                                delete obj[key];
                                delete self.totals[key];
                            }
                        }
                    }
                    updateHeaderCount();
                    Vue.set(self, "totals", self.totals);
                },
                totalAmount: function () {
                    let self = this;
                    var total = 0.0;
                    var obj = self.facilityOrders
                    for (key in self.facilityOrders) {
                        if (obj.hasOwnProperty(key)){
                            var order = obj[key].transaction.confirm.message.order;
                            total += order.quote.price.value
                        }
                    }
                    return total;
                }
            }
        });
    });
</script>
<style media="screen">
    .even {}

    .odd {
        background-color: rgba(0, 0, 0, 0.1);
    }
</style>

<div id="root" style="display:none;">
    <div id="header">
    </div>
    <div id="app" class="app-body">
        <div v-if="facilities.length > 0">
            <div class="container my-3" v-for="(facility,index) in facilities">
                <div class="content-box">
                    <div class="form-row">
                        <div class="col">By: <a
                                v-bind:href="'/dashboard?provider_location_id=' +facility.id">{{facility.descriptor.name}}</a></div>
                        <div class="col-3 text-right"><i class="fas fa-drafting-compass"
                                v-bind:href="'https://google.com/maps/place/'+facility.gps"></i>
                            {{(facility.distance * 100 /100).toFixed(2)}}
                            Km</div>
                    </div>
                </div>
                <div class="content-sub-box" style="z-index: inherit;">
                    <div class="form-row mb-2 border-bottom py-2"
                        v-for="(ol,olindex) in facilityOrders[facility.id].transaction.confirm.message.order.items">
                        <div class="col-sm-2 col-4">
                            <div class="img-box">
                                <img v-bind:src="ol.descriptor.images[0]"
                                    v-if="ol.descriptor.images && ol.descriptor.images.length > 0"
                                    class="w-100" data-toggle="modal"
                                    v-bind:data-target="'#sku-img-'+ol.id" />
                                <div v-else
                                    class="default-img d-flex bg-light align-items-center justify-content-center border p-1 rounded-sm">
                                    <span
                                        class="font-weight-bold text-muted small">{{ol.descriptor.name}}</span>
                                </div>
                            </div>
                            <!-- Modal View Images-->
                            <div v-if="ol.descriptor.images  && ol.descriptor.images.length > 0"
                                class="modal fade" v-bind:id="'sku-img-'+ol.id" tabindex="-1"
                                aria-labelledby="exampleModalLabel" aria-hidden="true">
                                <div class="modal-dialog">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title" id="exampleModalLabel">{{ol.descriptor.name}}
                                            </h5>
                                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                <span aria-hidden="true">&times;</span>
                                            </button>
                                        </div>
                                        <div class="modal-body">
                                            <img class="img-fluid w-100 h-100"
                                                v-if="ol.descriptor.images  && ol.descriptor.images.length > 0"
                                                v-bind:src="ol.descriptor.images[0]" />
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-10 col-8">
                            <h6>{{ol.descriptor.name}}</h6>
                            <p v-if="ol.price.value *1.0 > 0 ">@
                                <strike v-if="ol.price.maximum_value * 1 > ol.price.value * 1">
                                    &#8377; {{ol.price.maximum_value}}
                                </strike>
                                &#8377; {{ol.price.value}}
                            </p>
                            <div class="row">
                                <div class="col-8">
                                    <div class="btn-group" role="group" aria-label="Basic example" >
                                        <button type="button" class="btn btn-sm btn-outline-primary border-right-0 m-0"
                                            v-on:click="reduceOrderLine($event,facility,olindex)">
                                            <i class="fa fa-minus"></i>
                                        </button>
                                        <input v-bind:key="'quantity-' + facility.Id +'-'+ index"
                                            v-bind:id="'quantity-' + facility.Id +'-'+ index"
                                            class="btn btn-sm btn-outline-primary w-100 border-left-0 border-right-0 m-0"
                                            placeholder="0" v-model="ol.quantity.count"
                                            @change="onOrderLineQtyChange($event,facility,olindex)" />
                                        <button type="button" class="btn btn-sm btn-outline-primary border-left-0"
                                            v-on:click="increaseOrderLine($event,facility,olindex)">
                                            <i class="fa fa-plus"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="col d-flex align-items-center small">
                            <div class="w-100">
                                <div class="row" v-for="(breakup,breakup_index) in totals[facility.id]">
                                    <div class="col">
                                        {{breakup.title}}
                                    </div>
                                    <div class="col-5 text-right" >
                                        &#8377; {{ breakup.price.value }}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-5 text-right d-flex align-items-center justify-content-end">
                            <button class="btn btn-sm btn-primary"
                                v-on:click="guest? logout($event) : bookOrder($event,facility)">Place
                                Order</button>
                        </div> 
                    </div>
                </div>
            </div>
            <div class="container">
                <div class="row">
                    <div class="col">
                        <h6>Bill Summary</h6>
                    </div>
                </div>
                <div class="row text-muted">
                    <div class="col font-weight-bold">
                        To Pay
                    </div>
                    <div class="col-4 text-right">
                        &#8377; {{ Number(totalAmount()).toFixed(2) }}
                    </div>
                </div>
            </div>
            <div style="height: 98px;">
            </div>
            <div class="container">
                <div class="bottom-card">
                    <h6>Almost there!</h6>
                    <div class="form-row">
                        <div class="col-6">
                            <a href="#" class="btn btn-sm btn-block btn-outline-primary"
                                v-on:click="continueShopping($event)">
                                <small>Continue Shopping</small>
                            </a>
                        </div>
                        <div class="col-6 text-right">
                            <button class="btn btn-sm btn-block btn-primary" v-on:click="bookOrders($event)">
                                <small>
                                    Place Orders
                                </small>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
